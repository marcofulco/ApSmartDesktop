const vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);

query['ListaArticoli.html']=new Array;
query['ListaArticoli.html']['OFFSET']=0;
query['ListaArticoli.html']['FETCH']=75;
query['ListaArticoli.html']['MAXFETCH']=0;
query['ListaArticoli.html']['textBoxRicerca']="txtRicercaArticolo";
query['ListaArticoli.html']['modelloRiga']=elementiListaArticoliLightGuajanaNP;
query['ListaArticoli.html']['imgOffLine']={"precodice":"img.","campoCodice":"CODICE","campoImmagine":"IMMAGINE"};

query['ListaArticoli.html']['modelloRaggruppamento']="<li class='elementiGriglia clrScuro intestazione w100'>{RAGGRUPPAMENTO}</li>";

query['ListaArticoli.html']['oggetti']=new Array;
query['ListaArticoli.html']['oggetti']['{RAGGRUPPAMENTO}']="RAGGRUPPAMENTO";
query['ListaArticoli.html']['oggetti']['{LINKRAGGRUPPAMENTO}']="LINKRAGGRUPPAMENTO";
query['ListaArticoli.html']['oggetti']['{ID}']="CODICE";
query['ListaArticoli.html']['oggetti']['{CODICE}']="CODICE";
query['ListaArticoli.html']['oggetti']['{CODICEFORN}']="CODICEFORN";
query['ListaArticoli.html']['oggetti']['{DESCRIZIONE}']="DESCRIZIONE";
query['ListaArticoli.html']['oggetti']['{UM}']="UM";
query['ListaArticoli.html']['oggetti']['{DISP}']="DISP";
query['ListaArticoli.html']['oggetti']['{PREZZO}']="PREZZO";
query['ListaArticoli.html']['oggetti']['{PREZZOII}']="PREZZOII";
query['ListaArticoli.html']['oggetti']['{DESSCONTO}']="DESSCONTO";
query['ListaArticoli.html']['oggetti']['{COSTO}']="COSTOF";
query['ListaArticoli.html']['oggetti']['{DATACOSTO}']="DATAUC";
query['ListaArticoli.html']['oggetti']['{COSTOSTDF}']="COSTOSTDF";
query['ListaArticoli.html']['oggetti']['{SC1}']="SC1";
query['ListaArticoli.html']['oggetti']['{SCONTATO}']="SCONTATO";
query['ListaArticoli.html']['oggetti']['{SCONTATOII}']="SCONTATOII";
query['ListaArticoli.html']['oggetti']['{IMMAGINE}']="IMMAGINE";
query['ListaArticoli.html']['oggetti']['{QUUNITARIA}']="QUUNITARIA";
query['ListaArticoli.html']['oggetti']['{ORDINATO}']="ORDINATO";
query['ListaArticoli.html']['oggetti']['{INELIMINAZIONE}']="INELIMINAZIONE";
query['ListaArticoli.html']['oggetti']['{IDCLIENTE}']="IDCLIENTE";
query['ListaArticoli.html']['oggetti']['{HIDDENSTORICO}']="HIDDENSTORICO";
query['ListaArticoli.html']['oggetti']['{ALLEGATIWEB}']="ALLEGATIWEB";
query['ListaArticoli.html']['oggetti']['{HIDDENALLEGATOTECNICO}']="HIDDENALLEGATOTECNICO";
query['ListaArticoli.html']['oggetti']['{SKTECNICA}']="SKTECNICA";
query['ListaArticoli.html']['oggetti']['{CRLF}']="CRLF";
query['ListaArticoli.html']['oggetti']['{przNetto}']="przNetto";
query['ListaArticoli.html']['oggetti']['{hDescrizione}']="hDescrizione";
query['ListaArticoli.html']['oggetti']['{hContainer}']="hContainer";
query['ListaArticoli.html']['oggetti']['{hLi}']="hLi";
query['ListaArticoli.html']['oggetti']['{hContainerNP}']="hContainerNP";
query['ListaArticoli.html']['oggetti']['{hLiNP}']="hLiNP";
query['ListaArticoli.html']['oggetti']['{NRIMG}']="NRIMG";
query['ListaArticoli.html']['oggetti']['{hideMultiImg}']="hideMultiImg";
query['ListaArticoli.html']['oggetti']['{PERCIVA}']="PIVA";
query['ListaArticoli.html']['oggetti']['{ID_IVA}']="ID_IVA";
query['ListaArticoli.html']['oggetti']['{nuovo}']="NUOVO";
query['ListaArticoli.html']['oggetti']['{promo}']="DPROMO";
query['ListaArticoli.html']['oggetti']['{NOPROMO}']="NOPROMO";
query['ListaArticoli.html']['oggetti']['{NONETTI}']="NONETTI";
query['ListaArticoli.html']['oggetti']['{stock}']="NOSTOCK";
query['ListaArticoli.html']['oggetti']['{LISTINORIF}']="LISTINORIF";
query['ListaArticoli.html']['oggetti']['{SOLORIVENDITORI}']="SOLORIVENDITORI";
query['ListaArticoli.html']['oggetti']['{SOSTITUITI}']="SOSTITUITI";
query['ListaArticoli.html']['oggetti']['{SCALA}']="SCALA";
query['ListaArticoli.html']['oggetti']['{HIDESCALA}']="HIDESCALA";
query['ListaArticoli.html']['oggetti']['{HIDEALTERNATIVI}']="HIDEALTERNATIVI";
query['ListaArticoli.html']['oggetti']['{NOHIDESCALA}']="NOHIDESCALA";
query['ListaArticoli.html']['oggetti']['{HIDENETTO}']="HIDENETTO";
query['ListaArticoli.html']['oggetti']['{HIDEPROMO}']="HIDEPROMO";
query['ListaArticoli.html']['oggetti']['{CAR1}']="CAR1";
query['ListaArticoli.html']['oggetti']['{CAR2}']="CAR2";
query['ListaArticoli.html']['oggetti']['{CAR3}']="CAR3";
query['ListaArticoli.html']['oggetti']['{imgDisponibile}']="imgDisponibile";
query['ListaArticoli.html']['oggetti']['{titoloDisponibile}']="titoloDisponibile";
query['ListaArticoli.html']['oggetti']['{HIDEOPZIONI}']="HIDEOPZIONI";
query['ListaArticoli.html']['oggetti']['{GRMERC}']="GRMERC";
query['ListaArticoli.html']['oggetti']['{SGR_MERC}']="SGR_MERC";
query['ListaArticoli.html']['oggetti']['{SFAM1}']="SFAM1";
query['ListaArticoli.html']['oggetti']['{SFAM2}']="SFAM2";
query['ListaArticoli.html']['oggetti']['{visQuReso}']="visQuReso";
query['ListaArticoli.html']['oggetti']['{visQuOmaggio}']="visQuOmaggio";
query['ListaArticoli.html']['oggetti']['{HIDEINARRIVO}']="HIDEINARRIVO";
query['ListaArticoli.html']['oggetti']['{HIDEDOPPIAPROMO}']="HIDEDOPPIAPROMO";
query['ListaArticoli.html']['oggetti']['{COLOREDISP}']="COLOREDISP";
query['ListaArticoli.html']['oggetti']['{PESOSPECIFICO}']="PESO_SPECIFICO";
query['ListaArticoli.html']['oggetti']['{DESWEB}']="DESWEB";
query['ListaArticoli.html']['oggetti']['{IMGTIPO}']="IMGTIPO";
query['ListaArticoli.html']['oggetti']['{NOSCONTISUAPP}']="NOSCONTISUAPP";
query['ListaArticoli.html']['oggetti']['{PROVVIGIONE}']="PROVVIGIONE";
query['ListaArticoli.html']['oggetti']['{HIDEORDINA}']="HIDEORDINA";
query['ListaArticoli.html']['oggetti']['{HIDEMSGDISP}']="HIDEMSGDISP";

query['ListaArticoli.html:alternativi']=new Array;
query['ListaArticoli.html:alternativi']['modelloRiga']=query['ListaArticoli.html']['modelloRiga'].replace('class="col3Catalogo','class="col4Alternativi');
query['ListaArticoli.html:alternativi']['modelloRaggruppamento']=query['ListaArticoli.html']['modelloRaggruppamento'];
query['ListaArticoli.html:alternativi']['imgOffLine']={"precodice":"img.","campoCodice":"CODICE","campoImmagine":"IMMAGINE"};
query['ListaArticoli.html:alternativi']['oggetti']=query['ListaArticoli.html']['oggetti'];

query['ListaArticoli.html:opzioni']=new Array;
query['ListaArticoli.html:opzioni']['modelloRiga']=query['ListaArticoli.html']['modelloRiga'].replace('class="col3Catalogo','class="col4Alternativi');
query['ListaArticoli.html:opzioni']['modelloRaggruppamento']=query['ListaArticoli.html']['modelloRaggruppamento'];
query['ListaArticoli.html:opzioni']['OFFSET']=0;
query['ListaArticoli.html:opzioni']['FETCH']=0;
query['ListaArticoli.html:opzioni']['MAXFETCH']=0;
query['ListaArticoli.html:opzioni']['oggetti']=query['ListaArticoli.html']['oggetti'];

query['ListaArticoli.html:famiglie']=new Array;
query['ListaArticoli.html:famiglie']['modelloRigaAc']='<a class="accordion" href="#" onClick="apriChiudiAccordion(this);">{descrizione}</a><ul id="{ID}" class="panel w100 hCorpo scrool"><li><a id="{ID}" href="#" onclick="listaDaFamiglia(this)">{TUTTI}<img src="img/bianche/forward.svg"></a></li></ul>';
query['ListaArticoli.html:famiglie']['modelloRigaLi']='<li><a id="{ID}" href="#" onclick="listaDaFamiglia(this)">{descrizione}<img src="img/bianche/forward.svg"></a></li>';

query['ListaArticoli.html:tipologie']=new Array;
query['ListaArticoli.html:tipologie']['modello1Riga']='<li><a id="{ID}" descrizionecampo="{descrizione1}" href="#" onclick="listaDaTipologia(this)">{descrizione1}<img src="img/bianche/forward.svg"></a></li>';

query['ListaArticoli.html:assortimenti']=new Array;
query['ListaArticoli.html:assortimenti']['modello1Riga']='<li><a id="{ID}" href="#" onclick="listaDaAssortimento(this)">{descrizione1}<img src="img/bianche/forward.svg"></a></li>';

query['ListaArticoli.html:attributi']=new Array;
query['ListaArticoli.html:attributi']['modello1Riga']='<li><a id="{ID}" href="#" onclick="listaDaTipologia(this)">{descrizione1}<img src="img/bianche/forward.svg"></a></li>';

query['ListaArticoli.html:myStorico']=new Array;
query['ListaArticoli.html:myStorico']['OFFSET']=0;
query['ListaArticoli.html:myStorico']['FETCH']=100;
query['ListaArticoli.html:myStorico']['MAXFETCH']=0;
query['ListaArticoli.html:myStorico']['modelloRiga']=elementiStoricoVendite;

query['ListaArticoli.html:myStorico']['oggetti']=new Array;
query['ListaArticoli.html:myStorico']['oggetti']['{DATA}']="DATA";
query['ListaArticoli.html:myStorico']['oggetti']['{DESGENERE}']="DESGENERE";
query['ListaArticoli.html:myStorico']['oggetti']['{NUMERO}']="NUMERO";
query['ListaArticoli.html:myStorico']['oggetti']['{SERIE}']="SERIE";
query['ListaArticoli.html:myStorico']['oggetti']['{UM}']="UM";
query['ListaArticoli.html:myStorico']['oggetti']['{QU}']="QU";
query['ListaArticoli.html:myStorico']['oggetti']['{PREZZO}']="PREZZO";
query['ListaArticoli.html:myStorico']['oggetti']['{SC}']="SC";
query['ListaArticoli.html:myStorico']['oggetti']['{MARGINE}']="MARGINE";
query['ListaArticoli.html:myStorico']['oggetti']['{BR}']="BR";

query['ListaArticoli.html:modalMerceInArrivo']=new Array;
query['ListaArticoli.html:modalMerceInArrivo']['OFFSET']=0;
query['ListaArticoli.html:modalMerceInArrivo']['FETCH']=100;
query['ListaArticoli.html:modalMerceInArrivo']['MAXFETCH']=0;
query['ListaArticoli.html:modalMerceInArrivo']['modelloRiga']=elementiInArrivo;

query['ListaArticoli.html:modalMerceInArrivo']['oggetti']=new Array;
query['ListaArticoli.html:modalMerceInArrivo']['oggetti']['{DATACONSEGNA}']="DATACONSEGNA";
query['ListaArticoli.html:modalMerceInArrivo']['oggetti']['{UM}']="UM";
query['ListaArticoli.html:modalMerceInArrivo']['oggetti']['{QU}']="QU";
query['ListaArticoli.html:modalMerceInArrivo']['oggetti']['{BR}']="BR";

query['ListaArticoli.html:scala']=new Array;
query['ListaArticoli.html:scala']['modelloRiga']=elementiScalaPrezzi;
query['ListaArticoli.html:scala']['oggetti']=new Array;
query['ListaArticoli.html:scala']['oggetti']['{QU}']="QU";
query['ListaArticoli.html:scala']['oggetti']['{PREZZO}']="PREZZO";
query['ListaArticoli.html:scala']['oggetti']['{SCONTI}']="SCONTI";
query['ListaArticoli.html:scala']['oggetti']['{PREZZONETTO}']="PREZZONETTO";

query['ListaArticoli.html:linkRapido']= new Array();
query['ListaArticoli.html:linkRapido']['oggetti']=new Array;
query['ListaArticoli.html:linkRapido']['oggetti']['txtDescrizioneLinkRapido']='descrizione';
query['ListaArticoli.html:linkRapido']['oggetti']['txtDataValiditaDa']='dataDa';
query['ListaArticoli.html:linkRapido']['oggetti']['txtDataValiditaA']='dataA';
query['ListaArticoli.html:linkRapido']['oggetti']['txtLinkEsterno']='linkEsterno';

query['ListaArticoli.html:elencoLinkRapidiListaArticoli']=new Array;
query['ListaArticoli.html:elencoLinkRapidiListaArticoli']['modelloRiga']=elementoListaLink;
query['ListaArticoli.html:elencoLinkRapidiListaArticoli']['modelloContenitore']=modalListaLink;
query['ListaArticoli.html:elencoLinkRapidiListaArticoli']['oggetti']=new Array;
query['ListaArticoli.html:elencoLinkRapidiListaArticoli']['oggetti']['{descrizione}']="descrizione";
query['ListaArticoli.html:elencoLinkRapidiListaArticoli']['oggetti']['{riga}']="riga";
query['ListaArticoli.html:elencoLinkRapidiListaArticoli']['oggetti']['{id}']="id";
query['ListaArticoli.html:elencoLinkRapidiListaArticoli']['oggetti']['{dataDa}']="dataDaElenco";
query['ListaArticoli.html:elencoLinkRapidiListaArticoli']['oggetti']['{dataA}']="dataAElenco";

query['ListaArticoli.html:variabili']=new Array();
query['ListaArticoli.html:variabili']["Filtri['ListaArticoli.html']"]="salvaArrayFILTRI()";
query['ListaArticoli.html:variabili']['ricerca']='ricerca';
query['ListaArticoli.html:variabili']['ricercaF']='ricercaF';
query['ListaArticoli.html:variabili']['codice']='codice';
query['ListaArticoli.html:variabili']['tIDFamiglia']='window.sessionStorage.getItem(nomeStorage+".elencoFamiglia.id")';
query['ListaArticoli.html:variabili']['desFamiglia']='window.sessionStorage.getItem(nomeStorage+".elencoFamiglia.descrizioneId")';
query['ListaArticoli.html:variabili']['idTipologia']='window.sessionStorage.getItem(nomeStorage+".elencoTipologia.id");';
query['ListaArticoli.html:variabili']['desTipologia']='window.sessionStorage.getItem(nomeStorage+".elencoTipologia.descrizioneId")';
query['ListaArticoli.html:variabili']['idAssortimento']='window.sessionStorage.getItem(nomeStorage+".elencoAssortimento.id")';
query['ListaArticoli.html:variabili']['desAssortimento']='window.sessionStorage.getItem(nomeStorage+".elencoAssortimento.descrizioneId");';
query['ListaArticoli.html:variabili']['idAttributo']='window.sessionStorage.getItem(nomeStorage+".elencoAttributo.id");';
query['ListaArticoli.html:variabili']['desAttributo']='window.sessionStorage.getItem(nomeStorage+".elencoAttributo.descrizioneId");';

query['ListaArticoli.html:modalListaMagazzino']=new Array
query['ListaArticoli.html:modalListaMagazzino']['modalC-body']=elementoBodyModal;

query['modalPayPal']=new Array
query['modalPayPal']['modalC-body']=`<div id="paypal-button-container" class="marg10Top"></div>`;

query[nomePagina + ':elencoCarichi'] = new Array;
query[nomePagina + ':elencoCarichi']['OFFSET']=0;
query[nomePagina + ':elencoCarichi']['FETCH']=100;
query[nomePagina + ':elencoCarichi']['MAXFETCH']=0;
query[nomePagina + ':elencoCarichi']['modelloRiga'] = `
<li id="liCarico_{ID}" onclick="selezionaCarico(this,'{ID}')">
    <a id="{ID}" href="#" >
        <div class="row">
            <div id="ragioneSocialeCarico_{ID}">{RAGIONESOCIALE}</div>
            <div>{DATAC}</div>
            <div class="testo14">{NOTE}</div>
        </div>
        <img src="img/bianche/forward.svg">
    </a>
</li>`;
query[nomePagina + ':elencoCarichi']['oggetti'] = new Array;
query[nomePagina + ':elencoCarichi']['oggetti']['{ID}'] = 'ID';
query[nomePagina + ':elencoCarichi']['oggetti']['{DATAC}'] ='DATAC';
query[nomePagina + ':elencoCarichi']['oggetti']['{RAGIONESOCIALE}'] = 'RAGIONESOCIALE';
query[nomePagina + ':elencoCarichi']['oggetti']['{NOTE}'] = 'NOTE';

var linkRapidiObj={};

tipoAnagrafica=recuperaParametroHRef("CLIENTE");
var resoMerce=recuperaParametroHRef(0,"resoMerce");
var filtroApertura=recuperaParametroHRef("","filtro");

if (resoMerce==1){
    document.title="Reso Merce";
}

var idCliente=0;
var idIvaCliente=0;
var percIvaCliente=0;
var cIdDest=0;
var daLoad=true;

if (tipoAnagrafica=="CLIENTE"){
    idCliente=window.sessionStorage.getItem("idCliente");
    idIvaCliente=Number(window.sessionStorage.getItem("idIva"+idCliente));
    percIvaCliente=Number(window.sessionStorage.getItem("percIva"+idCliente));
} else {
    var idCliente=window.sessionStorage.getItem("idFornitore");
}

if (idCliente==null){
    idCliente=0;
}

variantePagina="";

var nomeStorage=nomePagina+"."+tipoAnagrafica+"."+idCliente;

var parametriArticoli={"TabAssortimento":0, "TabFamiglia":1, "TabMarchio":0, "TabAttributi":1, "tabDefault":"tabFamiglia", "modelloRighe":"elementiListaArticoliLightGuajanaNP",
                        "decimaliPrezzi":2, "noPulsantieraLista":0, "hDescrizione":40, "hContainer":"", "hLi":"", "hContainerNP":"", "hLiNP":"", "visCosto":0,
                        "modelloRigheNP":"elementiListaArticoliLightGuajanaNP", "modificaPrezzi":0, "ricaricoVerde":25, "ricaricoArancione":20, "ricaricoRosso":15, "ricaricoViola":0,
                        "modificheGuajana":0, "idDest":"0", "stampaAuto":0, "modificheTroia":0, "omaggioSoloMandante":0, "codiceCatalogo":"CATALOGO2022","modificheDenaro":0,
                        "nascondiRicercaFornitore":0, "filtraAssortimentiApertura":0, "NoQuConfezione":0, "nascondiVettoreConsegnaIl":0, "costiTrasporto":"",
                        "nonCaricarePreordineAvvio":0, "calcolaProvvigioni":0, "nascondiProvvigioni":"hide","filtriAttributiPredefiniti":"", "maxSconti":5,"tabCarichi":0};

var xFiltri=0;

var idAssortimento=0;
var idFamiglia=0;
var idSFamiglia=0;
var idSFam1=0;
var idSFam2=0;
var idTipologia=0;
var idFornitore=0;
var soloDisponibili=0;
var soloVendutiClienteCorrente=0;
var inEliminazione=0;
var ricerca="";
var ricercaCodiceBarre="";
var ricercaF="";
var codice="";
var inPromo=0;
var scalaSconti=0;
var promoScala=0;
var nuovo=0;
var fuoriCatalogo=0;
var primaApertura=1;
var noSconti=0;
var ultimiCarichi=0;
var idCarico=0;
if (idCliente==0){
    cmd=document.getElementById("cmdFiltri");
    cmd.setAttribute("class","w25");
    cmd=document.getElementById("cmdOk");
    cmd.setAttribute("class","w33");
    cmd=document.getElementById("CLIENTE");
    cmd.innerHTML='';
    cmd=document.getElementById("liVENDUTO");
    cmd.style.display="none";
}

window.addEventListener("load", function(event) {
    setTimeout( function() {
        if (xOffLine=="true"){
            caricaScriptOffLine(apriDBOffLine);
        } else {
            avviaCarDatiTabelle('listaLinkRapidiListaArticoli','listaLinkRapidiListaArticoli'); //CARICARE PRIMA QUESTA TABELLA, E POI CARICARE ARTICOLI per collegamenti rapidi?
        }
        
        avviaCarDatiTabelle('cmbPagamento','tesPagamenti');
        avviaCarDatiTabelle('cmbVettore','vettori');
        avviaCarDatiTabelle('recordSetProvviggioniAgente','recordSetProvviggioniAgente');
        
        if (vw>=1200){
            document.getElementById("nav-toggleF").checked=true;
        }

        data=[{id:0,descrizione:"Mittente"},{id:1,descrizione:"Destinatario"},{id:2,descrizione:"Vettore"}];
        popolaSelectDaJSON(data,"cmbMezzo",parametriArticoli["mezzoTrasporto"]);
    }, 500);
});

function apriDBOffLine(){
    apriIndexedDB(nomeIndexedDB,recuperaParametri);
}

function recuperaParametri(){
    if (xOffLine=="true"){
        res=localStorage.getItem("offLine."+nomePagina+".parametri");
        elaboraRisposta(res);
    } else {
        var parametri={"tipoRisposta":"parametri","chiamante":"parametri","nomePagina":nomePagina, "userName":""}; 

        elencoInCaricamento=1;

        inviaRichiestaCentralino("parametri",parametri,elaboraRisposta,"divCorpo");
    }
}

function AvviaCarDatiElencoArticoli(tipoRisposta,sottoQuery="",ricarica=true,righe=0,scrollTop=0,tipoQuery='listaArticoli'){
    var nomeQuery=new String (nomePagina);
    
    if (sottoQuery!=''){
        nomeQuery+=":"+sottoQuery;
    }

    var maxFetch=0;
    
    if (query[nomeQuery]['MAXFETCH']){
        maxFetch=query[nomeQuery]['MAXFETCH'];
    }

    if (ricarica){
        maxFetch=0;
    }

    if (query[nomeQuery]['OFFSET']>=maxFetch && maxFetch!=0) {
        return '';
    }

    if (ricarica){
        query[nomeQuery]['OFFSET']=0;
    }

    var appoNoSconti=0;

    if (tipoRisposta=="elencoArticoli"){
        soloDisponibili=0;
        soloVendutiClienteCorrente=0;
        inEliminazione=0;
        idFamiglia=0;
        idSFamiglia=0;
        idSFam1=0;
        idSFam2=0;
        inPromo=0;
        scalaSconti=0;
        promoScala=0;
        nuovo=0;
        fuoriCatalogo=0;
        appoNoSconti=noSconti;
        noSconti=0;
        ultimiCarichi=0;
        for (x in Filtri[nomePagina]){
            if (Filtri[nomePagina][x]!="") {
                var bx=Filtri[nomePagina][x].indexOf("§");
                
                if (bx>0) {
                    var v=Filtri[nomePagina][x].split("§");

                    for (i=0;i<v.length;i++){
                        switch (v[i]){
                            case "DISPONIBILITA":
                                soloDisponibili=1;
                                break;
                            case "VENDUTO":
                                soloVendutiClienteCorrente=1;
                                break;
                            case "INELIMINAZIONE":
                                inEliminazione=1;
                                break;
                            case "INPROMO":
                                inPromo=1;
                                break;
                            case "SCALA":
                                scalaSconti=1;
                                break;
                            case "INPROMOSCALA":
                                promoScala=1;
                                break;
                            case "NEW":
                                nuovo=1;
                                break;
                            case "FC":
                                fuoriCatalogo=1;
                                break;
                            case "ultimiCarichi":
                                ultimiCarichi=1;
                                break;
                            case "NoSconti":
                                if (appoNoSconti==0){
                                    primaApertura=1;
                                }
                                noSconti=1;
                                break;
                        }
                    }
                } else {
                    switch (x){
                        case "GRMERC":
                            idFamiglia=Filtri[nomePagina][x];
                            break;
                        case "SGR_MERC":
                            idSFamiglia=Filtri[nomePagina][x];
                            break;
                        case "SFAM1":
                            idSFam1=Filtri[nomePagina][x];
                            break;
                        case "SFAM2":
                            idSFam2=Filtri[nomePagina][x];
                            break;
                    }
                }
            }
        }
    }

    if (resoMerce==1){
        soloVendutiClienteCorrente=1
    }

    if (appoNoSconti==1 && noSconti==0){
        primaApertura=1;
    }

    var tNoPromo=0;
    var tNoNetti=0;

    try {
        tNoPromo=skCli[0].NOPROMO;    
        tNoNetti=skCli[0].NONETTI;    
    } catch (error) {
        
    }
    if(tipoQuery!='listaArticoli'){
        var tipoQueryPr=tipoQuery;
    }else{
        var tipoQueryPr="listaArticoli";
    }
    var parametri={"tipoQuery":tipoQueryPr,"tipoRisposta":tipoRisposta,"nomeQuery":nomeQuery,"ricerca":ricerca,"ricercaF":ricercaF,"tipoElenco":righe, 
            "ricarica":ricarica, "scrollTop":scrollTop,"azienda":0,"idCliente":idCliente,"idDest":cIdDest,"idAgente":0,"idFamiglia":idFamiglia,"idSFamiglia":idSFamiglia,
            "idSFam1":idSFam1,"idSFam2":idSFam2,"idTipologia":idTipologia,"idFornitore":idFornitore,"soloDisponibili":soloDisponibili,
            "soloVendutiClienteCorrente":soloVendutiClienteCorrente,"idAssortimento":idAssortimento, "codice":codice, "inEliminazione":inEliminazione,
            "offSet":query[nomeQuery]['OFFSET'],"fetch":query[nomeQuery]['FETCH'],"chiamante":tipoRisposta, "percorsoImmagini":xPercorsoImmagini,
            "decimaliPrezzi":parametriArticoli["decimaliPrezzi"], "hDescrizione":parametriArticoli["hDescrizione"], "hContainer":parametriArticoli["hContainer"],
            "hLi":parametriArticoli["hLi"], "hContainerNP":parametriArticoli["hContainerNP"],"hLiNP":parametriArticoli["hLiNP"], "idIvaCliente":idIvaCliente,
            "percIvaCliente":percIvaCliente, "inPromo":inPromo, "nuovo":nuovo, "fuoriCatalogo":fuoriCatalogo, "noPromo":tNoPromo, "scalaSconti":scalaSconti,
            "primaApertura":primaApertura, "promoScala":promoScala, "noSconti":noSconti, "noNetti":tNoNetti, "codiceBarre":ricercaCodiceBarre, "idDeposito":idDeposito,
            "filtraAssortimentiApertura":parametriArticoli.filtraAssortimentiApertura,"ultimiCarichi":ultimiCarichi,"idCarico":idCarico,
            }; 
    
    if (ricercaCodiceBarre!=""){
        ricercaCodiceBarre="";
        valorizzaValueElemento("txtRicercaBarCode","");

        if (parametriArticoli.modificheDenaro!=1){
            document.getElementById("divRicercaArticoliF").classList.add("hide");
        } else {
            document.getElementById("divRicercaArticoli").classList.add("w100-100p");
            document.getElementById("divRicercaArticoli").classList.remove("w100-50p");
        }

        document.getElementById("cmdBarCodeDel").classList.remove("hide");
    } else {
        if (parametriArticoli.modificheDenaro!=1){
            if (parametriArticoli.nascondiRicercaFornitore!=1){
                document.getElementById("divRicercaArticoliF").classList.remove("hide");
            }
        } else {
            document.getElementById("divRicercaArticoli").classList.add("w100-100p");
            document.getElementById("lblRicArtDen").classList.remove("hide");
            // document.getElementById("divRicercaArticoli").classList.remove("w100-100p");
        }
        
        document.getElementById("cmdBarCodeDel").classList.add("hide");
    }
    
    if (parametriArticoli.forzaTipoListino!=undefined){
        parametri.forzaTipoListino=parametriArticoli.forzaTipoListino;
    }

    if (parametriArticoli.forzaListino!=undefined){
        parametri.forzaListino=parametriArticoli.forzaListino;
    }

    elencoInCaricamento=1;

    if (xOffLine=="true" && tipoRisposta!="elencoStorico"){
        if (parametri.tipoRisposta=="elencoAssortimento"){
            parametri.ricerca='';
            parametri.campiFiltroIN=[{"nomeChiave":"CLIENTI","nomeParametro":"idCliente"}];
            parametri.nomeTabellaOrdinata="assortimenti";
            parametri.offSet=0;
            parametri.fetch=0;

            leggiTabellaIndexedDB("assortimenti",parametri,"ricerca",elaboraRisposta);
        } else if (parametri.tipoRisposta!="elencoArticoli"){
            var data=JSON.parse(localStorage.getItem(parametri.tipoRisposta+".jSon"));
            if (data!=undefined){
                popolaElencoDaJson(data,parametri.tipoRisposta,parametri.tipoElenco,parametri.nomeQuery,parametri.ricarica,parametri.scrollTop);
            }    
        } else {
            parametri.campiFiltro=[{"nomeChiave":"idGrMerc","nomeParametro":"idFamiglia","tipoControllo":"="},{"nomeChiave":"idSGrMerc","nomeParametro":"idSFamiglia","tipoControllo":"="},
                                    {"nomeChiave":"idSFam1","nomeParametro":"idSFam1","tipoControllo":"="},{"nomeChiave":"idSFam2","nomeParametro":"idSFam2","tipoControllo":"="},
                                    {"nomeChiave":"idTipologia","nomeParametro":"idTipologia","tipoControllo":"="},{"nomeChiave":"oDisp","nomeParametro":"soloDisponibili","tipoControllo":"="},
                                    {"nomeChiave":"oNuovo","nomeParametro":"nuovo","tipoControllo":"="}
                                  ];
            
            if (soloVendutiClienteCorrente==1){
                parametri.idClienteVenduto=idCliente;
            }

            parametri.campiFiltroIN=[{"nomeChiave":"ASSORTIMENTI","nomeParametro":"idAssortimento"},{"nomeChiave":"CLIENTI","nomeParametro":"idClienteVenduto"}];
            parametri.nomeTabellaOrdinata="listaArticoli";
            parametri.funzioniParticolari=fnContrattiIDB;
            parametri.attivaAlert=true;

            if (parametri.ricerca!=''){
                if ( parametri.ricerca.substring(0,1)!='+' && parametri.ricerca.substring(0,1)!='%'){
                    parametri.ricerca="+"+parametri.ricerca;
                }
            }

            leggiTabellaIndexedDB("articoli",parametri,"ricerca",elaboraRisposta);
        }

        return;
    } else {
        parametri.md5=localStorage.getItem(tipoRisposta+".md5");
        
        if(tipoQuery=='catalogoListaArticoli'){
            if(parametriArticoli.imgCatalogo!=undefined ){
                parametri.imgCatalogo=parametriArticoli.imgCatalogo
            }
            if(parametriArticoli.coloreFamiglieCatalogo!=undefined){
                parametri.coloreFamiglieCatalogo=parametriArticoli.coloreFamiglieCatalogo
            }
        }
    }

    var tempo=30000;
    var contenitore="body";

    if(tipoQuery=='catalogoListaArticoli'){
        var tipoQuery="multiQuery";
        tempo=80000;
        var a=document.getElementById("cmdCatalogo")
        a.removeAttribute("onclick");
        a.classList.add("scroolYHidden");
        contenitore="cmdCatalogo";
    }else{
        var tipoQuery="query";
    }

    inviaRichiestaCentralino(tipoQuery,parametri,elaboraRisposta,contenitore,"erroreRisposta",tempo);
}

var primoCheckParametriAvvio=true;

function erroreRisposta(){
    try {
        document.getElementById("cmdCatalogo").setAttribute('onclick',"stampaCatalogoPDF()");
    } catch (error) {
        
    }
}

function elaboraRisposta(res){
    var risp=JSON.parse(res);
    var parametri=risp.parametri;
    var data=risp.risposta;

    if(parametri.tipoQuery=='catalogoListaArticoli'){
        document.getElementById("cmdCatalogo").setAttribute('onclick',"stampaCatalogoPDF()");
    }

    if (risp.error!=''){
        return "";
    }

    switch (parametri.tipoRisposta){
        case "parametri":
            for (x in data){
                if (!isNaN(Number(data[x]["valore"]))){
                    parametriArticoli[data[x]["parametro"]]=Number(data[x]["valore"]);
                } else {
                    parametriArticoli[data[x]["parametro"]]=data[x]["valore"];
                }  
            }

            parametriArticoli["decimaliPrezzi"]=xParametriGenerali.decimaliPrezzi;

            if (parametriArticoli.calcolaProvvigioni==1){
                parametriArticoli.nascondiProvvigioni="";
            }

            query['ListaArticoli.html']['modelloRiga']=eval(parametriArticoli["modelloRighe"]);
            
            var script=document.createElement("script");
            script.setAttribute('src',"componenti/elementiCarrello.js");
            script.setAttribute('id','elementiListaCarrello');
            document.body.appendChild(script);
            script.onload = function () {
                query['carrello.js']['modelloRiga']=elementiCarrello;
                query['carrello.js:indispensabili']['modelloRiga']=elementiIndispensabili;
                query['carrello.js:prenotati']['modelloRiga']=elementiIndispensabili;
            }
            
            if (parametriArticoli["modificheGuajana"]==0){
                try {
                    var li=document.getElementById("liINPROMO");
                    li.style.display="none";
                    li=document.getElementById("liSCALA");
                    li.style.display="none";
                    li=document.getElementById("spPromoScala");
                    li.innerHTML="In Promo";
                    li=document.getElementById("INPROMOSCALA");
                    li.setAttribute("descrizione","In Promo");    
                } catch (error) {
                    
                }
            }
            if(parametriArticoli.filtriAttributiPredefiniti!=undefined && parametriArticoli.filtriAttributiPredefiniti!=''){
                var filtriTmp=parametriArticoli.filtriAttributiPredefiniti.split(',');
                for(var x in filtriTmp){
                    if (Filtri[nomePagina]['ATTRIBUTI']!=undefined) {
                        if (Filtri[nomePagina]['ATTRIBUTI'].indexOf(filtriTmp[x]+"§")>=0){
                            Filtri[nomePagina]['ATTRIBUTI']=Filtri[nomePagina]['ATTRIBUTI'].replace(filtriTmp[x]+"§",'');
                            xFiltri-=1;
                        } else {
                            Filtri[nomePagina]['ATTRIBUTI']+=filtriTmp[x]+"§";
                            xFiltri+=1;
                        }
                    } else {
                        Filtri[nomePagina]['ATTRIBUTI']=filtriTmp[x]+"§";
                        xFiltri+=1;
                    }
                    document.getElementById(filtriTmp[x]).checked=true;
                    
                }
            }
            if (xIdCliente>0){
                try {
                    document.getElementById("imgRicM").classList.add("hide");
                    document.getElementById("imgRicT").classList.add("hide");
                    document.getElementById("divDisponibile").classList.add("hidden");
                    document.getElementById("divArrivo").classList.add("hidden");
                    document.getElementById("divPagamentoM").classList.add("hide");
                } catch (error) {
                    
                }
            } else {
                document.getElementById("divDestPredefinita").classList.add("hide");

                if (idCliente==0){
                    document.getElementById("cmdInvia").classList.add("hide");
                    document.getElementById("cmdPreOrdine").classList.remove("w50");
                    document.getElementById("cmdPreOrdine").classList.add("w100-40p");
                    document.getElementById("divDesPreOrdine").innerHTML="SALVA LISTA<BR>MAGAZZINO";
                    document.getElementById("intCarrello").innerHTML="LISTA DI MAGAZZINO";
                }
            }

            if (parametriArticoli["idDest"]!="0"){
                caricaDatiDestinazione(parametriArticoli["idDest"]);
            }
            
            if (parametriArticoli.modificheDenaro==1){
                document.getElementById("divRicercaArticoliF").classList.add("hide");
                document.getElementById("divRicercaArticoli").classList.add("w100-100p")
                document.getElementById("lblRicArtDen").classList.remove("hide");
                document.getElementById("pulsantieraPiede").classList.add("hide");
                document.getElementById("divCorpo").classList.add("posBottomA50p")
                document.getElementById("divCorpo").classList.remove("posBottomA100p")
                document.getElementById("divContImportoTotale").classList.add("hide");
                document.getElementById("divContCLIENTE").classList.add("w100");
                document.getElementById("divContCLIENTE").classList.remove("w50");
                document.getElementById("cmdBarCode").classList.add("hide");
            }

            if (parametriArticoli.nascondiRicercaFornitore==1){
                document.getElementById("divRicercaArticoliF").classList.add("hide");
                document.getElementById("divRicercaArticoli").classList.add("w100-100p");
            }

            if (parametriArticoli.nascondiVettoreConsegnaIl==1){
                document.getElementById("divDataConsegna").classList.add("hide");
            }
            
            if (parametriArticoli.costiTrasporto!=''){
                costiTrasporto=JSON.parse(parametriArticoli.costiTrasporto);
            }

            if(xGruppoUtente=='Amministratori' && parametriArticoli.modificaLinkRapidi!=undefined && parametriArticoli.modificaLinkRapidi==1){
                
                var pulsantieraOrig=document.getElementById('pulsantieraPiede');
                // var btnModal=`
                // `;
                // var htmlOrig=pulsantieraOrig.innerHTML;
                // pulsantieraOrig.innerHTML=btnModal+htmlOrig;
                
                for(var x in pulsantieraOrig.childNodes){
                    if(pulsantieraOrig.childNodes[x].nodeType != Node.TEXT_NODE){
                        if(pulsantieraOrig.childNodes[x].classList!=undefined){
                            pulsantieraOrig.childNodes[x].classList.remove('w25');
                            pulsantieraOrig.childNodes[x].classList.add('w20');
                        }
                    }
                }
                show('cmdModalLink');
            }
            if(parametriArticoli.qrCodeScanner!=undefined && parametriArticoli.qrCodeScanner==1){
                var pulsantieraOrig=document.getElementById('pulsantieraPiede');
                for(var x in pulsantieraOrig.childNodes){
                    if(pulsantieraOrig.childNodes[x].nodeType != Node.TEXT_NODE){
                        if(pulsantieraOrig.childNodes[x].classList!=undefined){
                            pulsantieraOrig.childNodes[x].classList.remove('w25');
                            pulsantieraOrig.childNodes[x].classList.add('w20');
                        }
                    }
                }
                show('cmdQrCode');
            }
            if(parametriArticoli.abilitaAttributoUltimiCarichi!=undefined && parametriArticoli.abilitaAttributoUltimiCarichi==1){
                show('liUltimiCarichi');
            }
            if (parametriArticoli.modificheDenaro==0){
                caricaCarrello();
                aggiornaTotale();
                carDatiListaArticoli();
            }
       
            break;
        default:
            var zNomeCarrello="";
            if(parametri.tipoQuery=='catalogoListaArticoli'){
                elaboraRispostaStampa(res);
                return;
            }
            if (parametri.tipoRisposta=="elencoArticoli"){
                query[nomePagina]['OFFSET']+=parametri.fetch;
                zNomeCarrello=nomeCarrello;
            }
            
            if (parametriArticoli["noPulsantieraLista"]==1 && idCliente==0){
                query['ListaArticoli.html']['modelloRiga']=eval(parametriArticoli["modelloRighe"]+"NoPulsantiera");
            } else if (idCliente==0) {
                query['ListaArticoli.html']['modelloRiga']=eval(parametriArticoli["modelloRigheNP"]);
            }
            
            if (parametri.ricarica && (xOffLine!="true" || parametri.tipoRisposta!="elencoStorico")){
                data=verificaMd5(parametri.tipoRisposta,parametri,risp,data);
            }

            if (parametri.tipoRisposta=="elencoInArrivo"){
                ricalcolaArrivi(parametri,data);
            }
          
            
            popolaElencoDaJson(data,parametri.tipoRisposta,parametri.tipoElenco,parametri.nomeQuery,parametri.ricarica,parametri.scrollTop,"x",zNomeCarrello);

            if (parametri.tipoRisposta=="elencoArticoli" && filtroApertura==parametriArticoli.codiceCatalogo && primoCheckParametriAvvio==true){
                primoCheckParametriAvvio=false;
                
                var p=document.getElementById("cmdP"+parametriArticoli.codiceCatalogo);
                aggiungiCarrello(p);
                apriCarrello();
                apriSalvaOrdine(false);
            }

            if(parametri.tipoRisposta=='elencoAttributo'){
                var attributiAttivi=Filtri[nomePagina]['ATTRIBUTI'];

                if (attributiAttivi!=undefined && attributiAttivi!=''){
                    var attributiTmp=attributiAttivi.split('§');
                    for(var x in attributiTmp){
                        if(attributiTmp[x]!=''){
                            document.getElementById(attributiTmp[x]).checked=true;
                        }
                    }
                }
            }
    }

    elencoInCaricamento=0;
}

function carDatiListaArticoli(){
    var pageName = location.pathname.split("/").slice(-1)[0];
   
    if (presenzaLinkRapido()){
        var tIDFamiglia;
        var desFamiglia;
        var desTipologia;
        var desAssortimento;
        var idAttributo;
        var desAttributo;
        var id=location.search.split('=');
        if(linkRapidiObj[id[1]]!=undefined){
            var x=linkRapidiObj[id[1]];
            for([k,v] of Object.entries(x)){
                
                if(v!=null && IsJsonString(v) && isNaN(Number(v))){
                    
                    for([JK,JV] of Object.entries(JSON.parse(v))){
                        Filtri['ListaArticoli.html'][JK]=JV;
                    }
                }else{
                    // console.log(k);
                    // console.log(''+k+` = '${v==null ? '':v}'`);
                    try{
                        if(query['ListaArticoli.html:variabili'][k].indexOf('session')!=-1 ){
                            
                            eval(''+k+` = '${v==null ? '':v}'`);
                        }else{
                            eval(''+k+` = '${v}'`);
                        }
                    }catch(e){
                        console.error(e);
                    }
                    
                }
                
            }
            if(ricerca!=''){
                valorizzaValueElemento('txtRicercaArticolo',ricerca);
            }
            if(ricercaF!=''){
                valorizzaValueElemento('txtRicercaArticoloF',ricercaF);
            }
        }
    } else {
        var tIDFamiglia=window.sessionStorage.getItem(nomeStorage+".elencoFamiglia.id");
        var desFamiglia=window.sessionStorage.getItem(nomeStorage+".elencoFamiglia.descrizioneId");
        idTipologia=window.sessionStorage.getItem(nomeStorage+".elencoTipologia.id");    
        var desTipologia=window.sessionStorage.getItem(nomeStorage+".elencoTipologia.descrizioneId");
        idAssortimento=window.sessionStorage.getItem(nomeStorage+".elencoAssortimento.id");    
        var desAssortimento=window.sessionStorage.getItem(nomeStorage+".elencoAssortimento.descrizioneId");    
        var idAttributo=window.sessionStorage.getItem(nomeStorage+".elencoAttributo.id");
        var desAttributo=window.sessionStorage.getItem(nomeStorage+".elencoAttributo.descrizioneId");
    }

    //ricerca=window.sessionStorage.getItem(nomeStorage+".filter");
    
    if (idCliente>0) {
        var ragioneSociale=window.sessionStorage.getItem("ragioneSociale");
        var divRS=document.getElementById("CLIENTE");
        divRS.innerHTML=ragioneSociale;
    }

    var liArticoli=window.sessionStorage.getItem(nomeStorage+".elencoArticoli.li");
    
    var ulArticoli=document.getElementById("elencoArticoli");

    var div="";
    var width=100/(parametriArticoli.TabAssortimento+parametriArticoli.TabFamiglia+parametriArticoli.TabMarchio+parametriArticoli.TabAttributi+parametriArticoli.tabCarichi);
    
    div=document.getElementById("tabAssortimento");

    if (parametriArticoli.TabAssortimento==1){
        AvviaCarDatiElencoArticoli("elencoAssortimento","assortimenti",true,1);
        
        div.classList.add("w"+arrotonda(width,0).toString());
    } else {
        div.style.display="none";
    }
    
    div=document.getElementById("tabFamiglia");

    if (parametriArticoli.TabFamiglia==1) {
        AvviaCarDatiElencoArticoli("elencoFamiglia","famiglie",true,99);

        div.classList.add("w"+arrotonda(width,0).toString());
    } else {
        div.style.display="none";
    }
    
    div=document.getElementById("tabTipologia");

    if (parametriArticoli.TabMarchio==1) {
        var tipoElencoMarchio=1;
        if(parametriArticoli.layoutElencoTipologia!=undefined ){
            tipoElencoMarchio=0;
            query['ListaArticoli.html:tipologie']['modelloRiga']=eval(parametriArticoli.layoutElencoTipologia);
            query['ListaArticoli.html:tipologie']['oggetti']=new Array;
            query['ListaArticoli.html:tipologie']['oggetti']['{IMMAGINE}']='IMMAGINE';
            query['ListaArticoli.html:tipologie']['oggetti']['{descrizione1}']='d1';
            query['ListaArticoli.html:tipologie']['oggetti']['{CSSIMMAGINE}']='CSSIMMAGINE';
            query['ListaArticoli.html:tipologie']['oggetti']['{ID}']='id';
            
        }
        
        AvviaCarDatiElencoArticoli("elencoTipologia","tipologie",true,tipoElencoMarchio);
    
        div.classList.add("w"+arrotonda(width,0).toString());
    } else {
        div.style.display="none";
    }
    
    div=document.getElementById("tabAttributo");

    if (parametriArticoli.TabAttributi==1 && resoMerce==0){
        AvviaCarDatiElencoArticoli("elencoAttributo","attributi",false,1);
        
        div.classList.add("w"+arrotonda(width,0).toString());
    } else {
        div.style.display="none";
    }
    div=document.getElementById("tabCarichi");
    if (parametriArticoli.tabCarichi==1) {
        AvviaCarDatiElencoArticoli("elencoCarichi","elencoCarichi",true,0);

        div.classList.add("w"+arrotonda(width,0).toString());
    } else {
        div.style.display="none";
    }

    xFiltri=0;

    if (idAssortimento>0){
        document.getElementById("lblFiltroAssortimento").innerHTML="Selezione: "+desAssortimento;
        document.getElementById("tabAssortimento").style.border="3px solid rgba("+xColoreSecondario+", 1)";
        document.getElementById("cmdFiltri").style.border="3px solid rgba("+xColoreSecondario+", 1)";
        xFiltri+=1
    }

    if (idTipologia>0){
        document.getElementById("lblFiltroTipologia").innerHTML="Selezione: "+desTipologia;
        document.getElementById("tabTipologia").style.border="3px solid rgba("+xColoreSecondario+", 1)";
        document.getElementById("cmdFiltri").style.border="3px solid rgba("+xColoreSecondario+", 1)";
        xFiltri+=1
    }

    Filtri[nomePagina]['GRMERC']="";
    Filtri[nomePagina]['SGR_MERC']="";
    Filtri[nomePagina]['SFAM1']="";
    Filtri[nomePagina]['SFAM2']="";
        
    if (tIDFamiglia){
        var p=tIDFamiglia.indexOf(":");

        if (p>0) {
            Filtri[nomePagina][tIDFamiglia.substring(p+1,1000)]=tIDFamiglia.substring(0,p);
        } else {
            Filtri[nomePagina]['GRMERC']=tIDFamiglia;
        }

        document.getElementById("lblFiltroFamiglia").innerHTML="Selezione: "+desFamiglia;
        document.getElementById("tabFamiglia").style.border="3px solid rgba("+xColoreSecondario+", 1)";
        document.getElementById("cmdFiltri").style.border="3px solid rgba("+xColoreSecondario+", 1)";
        xFiltri+=1
    }

    if (filtroApertura==''){
        
        if (idAttributo){
            if (idCliente==0){
                idAttributo=idAttributo.replace("VENDUTO§","");
                desAttributo=desAttributo.replace("Prodotti Acquistati *",'');
            }

            if (idAttributo.substr(idAttributo.length - 1)!="§"){
                idAttributo='';
            }
            if(parametriArticoli.filtriAttributiPredefiniti!=undefined && parametriArticoli.filtriAttributiPredefiniti!=''){
                var filtriTmp=parametriArticoli.filtriAttributiPredefiniti.split(',');
                for(var x in filtriTmp){
                    if(filtriTmp[x]!='' && idAttributo.indexOf(filtriTmp[x])==-1){
                        idAttributo+=filtriTmp[x]+'§';
                    }
                }
            }
            if (idAttributo!=''){
                Filtri[nomePagina]['ATTRIBUTI']=idAttributo;
        
                document.getElementById("tabAttributo").style.border="3px solid rgba("+xColoreSecondario+", 1)";
                document.getElementById("cmdFiltri").style.border="3px solid rgba("+xColoreSecondario+", 1)";
                xFiltri+=idAttributo.split('§').length-1

                var vAtt=idAttributo.split('§');
                for (x=0;x<vAtt.length;x++){
                    try {
                        var chk=document.getElementById(vAtt[x]);   
                        chk.setAttribute("checked","true");
                    } catch (error) {
                        
                    }
                }
            }
        }
    }
  
    daLoad=false;
    // if (ricerca!='') {
    //     var txtRicerca=document.getElementById("txtRicercaArticolo");
    //     txtRicerca.value=ricerca;
    // }

    var scroolTop=window.sessionStorage.getItem(nomeStorage+".elencoArticoli.scroolTop");

    var fetch=window.sessionStorage.getItem(nomeStorage+".OFFSET");

    if (!isNaN(fetch)) {
        fetch=Number(fetch);
    }
    
    if (filtroApertura!="" && filtroApertura!="tutti" && filtroApertura!=parametriArticoli.codiceCatalogo){
        var eCheck=document.getElementById(filtroApertura);
        eCheck.checked=true;
        eCheck.setAttribute("checked","true");
        listaDaAttributo(eCheck);
    } else {
        if(presenzaLinkRapido()){
            
        }else{
        if (filtroApertura==parametriArticoli.codiceCatalogo){
            valorizzaValueElemento("txtRicercaArticolo",filtroApertura);
            ricerca=filtroApertura;
        }
        }
     
        AvviaCarDatiElencoArticoli("elencoArticoli","");
    }

    primaApertura=0;
    
    document.getElementById(parametriArticoli.tabDefault).click();
}

function elencoArticoliScroll(ec, pagina, txtRicerca="") {
    var scrollPos = ec.scrollTop;
    var maxScroll = ec.scrollHeight - ec.clientHeight;
    
    window.sessionStorage.setItem(nomeStorage+".elencoArticoli.scroolTop", scrollPos);

    if ((maxScroll*90/100)<scrollPos && elencoInCaricamento==0) {
        AvviaCarDatiElencoArticoli("elencoArticoli","",false);
    }
}

function listaDaFamiglia(a){
    var xID=a.getAttribute("ID");
    var p=xID.indexOf(":");

    if (Filtri[nomePagina]['GRMERC']!="" || Filtri[nomePagina]['SGR_MERC']!="" || Filtri[nomePagina]['SFAM1']!="" || Filtri[nomePagina]['SFAM2']!=""){
        xFiltri-=1;
    }

    Filtri[nomePagina]['GRMERC']="";
    Filtri[nomePagina]['SGR_MERC']="";
    Filtri[nomePagina]['SFAM1']="";
    Filtri[nomePagina]['SFAM2']="";

    xRag="";

    if (p>0) {
        Filtri[nomePagina][xID.substring(p+1,1000)]=xID.substring(0,p);
    } else {
        Filtri[nomePagina]['GRMERC']=xID;
    }

    AvviaCarDatiElencoArticoli("elencoArticoli","");

    if (vw<1200){
        document.getElementById("nav-toggleF").checked=false;
    }

    document.getElementById("lblFiltroFamiglia").innerHTML="Selezione: "+a.innerHTML.substring(0,a.innerHTML.indexOf('<img'));
    document.getElementById("tabFamiglia").style.border="3px solid rgba("+xColoreSecondario+", 1)";
    document.getElementById("cmdFiltri").style.border="3px solid rgba("+xColoreSecondario+", 1)";

    xFiltri+=1;

    if (filtroApertura==""){
        segnaStato(a,"elencoFamiglia",xID,"","",nomeStorage);
    }
}

function eliminaTuttiFiltri(a){
    eliminaFiltroFamiglia(a);
    eliminaFiltroTipologia(a);
    eliminaFiltroAssortimento(a);
    eliminaFiltroAttributo(a);
    eliminaFiltroCarico();
}

function eliminaFiltroFamiglia(a){
    if (Filtri[nomePagina]['GRMERC']!="" || Filtri[nomePagina]['SGR_MERC']!="" || Filtri[nomePagina]['SFAM1']!="" || Filtri[nomePagina]['SFAM2']!=""){
        Filtri[nomePagina]['GRMERC']="";
        Filtri[nomePagina]['SGR_MERC']="";
        Filtri[nomePagina]['SFAM1']="";
        Filtri[nomePagina]['SFAM2']="";
        
        AvviaCarDatiElencoArticoli("elencoArticoli","");

        if (vw<1200){
            document.getElementById("nav-toggleF").checked=false;
        }

        document.getElementById("lblFiltroFamiglia").innerHTML="Selezione: ";
        document.getElementById("tabFamiglia").removeAttribute("style");

        xFiltri-=1

        if (xFiltri==0){
            document.getElementById("cmdFiltri").removeAttribute("style");
        }
        
        if (filtroApertura==""){
            eliminaStato(nomeStorage+".elencoFamiglia.id");
            eliminaStato(nomeStorage+".elencoFamiglia.descrizioneId");
        }
    }
}

function listaDaTipologia(a){
    if (idTipologia>0){
        xFiltri-=1;
    }
    idTipologia=a.getAttribute("ID");
    AvviaCarDatiElencoArticoli("elencoArticoli","");

    if (vw<1200){
        document.getElementById("nav-toggleF").checked=false;
    }

    // document.getElementById("lblFiltroTipologia").innerHTML="Selezione: "+a.innerHTML.substring(0,a.innerHTML.indexOf('<img'));
    document.getElementById("lblFiltroTipologia").innerHTML="Selezione: "+a.getAttribute('descrizionecampo');
    document.getElementById("tabTipologia").style.border="3px solid rgba("+xColoreSecondario+", 1)";
    document.getElementById("cmdFiltri").style.border="3px solid rgba("+xColoreSecondario+", 1)";
    xFiltri+=1

    segnaStato(a, "elencoTipologia",a.getAttribute("ID"),a.getAttribute('descrizionecampo'),"",nomeStorage);
}

function eliminaFiltroTipologia(a){
    if (idTipologia>0) {
        idTipologia=0;
        AvviaCarDatiElencoArticoli("elencoArticoli","");
        if (vw<1200){
            document.getElementById("nav-toggleF").checked=false;
        }
        document.getElementById("lblFiltroTipologia").innerHTML="Selezione: ";
        document.getElementById("tabTipologia").removeAttribute("style");
        
        xFiltri-=1

        if (xFiltri==0){
            document.getElementById("cmdFiltri").removeAttribute("style");
        }

        eliminaStato(nomeStorage+".elencoTipologia.id");
        eliminaStato(nomeStorage+".elencoTipologia.descrizioneId");
    }
}

function listaDaAssortimento(a){
    if (idAssortimento>0){
        xFiltri-=1;
    }

    idAssortimento=a.getAttribute("ID");

    AvviaCarDatiElencoArticoli("elencoArticoli","");
    if (vw<1200){
        document.getElementById("nav-toggleF").checked=false;
    }
    document.getElementById("lblFiltroAssortimento").innerHTML="Selezione: "+a.innerHTML.substring(0,a.innerHTML.indexOf('<img'));
    document.getElementById("tabAssortimento").style.border="3px solid rgba("+xColoreSecondario+", 1)";
    document.getElementById("cmdFiltri").style.border="3px solid rgba("+xColoreSecondario+", 1)";
    xFiltri+=1

    segnaStato(a,"elencoAssortimento","","","",nomeStorage);
}

function eliminaFiltroAssortimento(a){
    if (idAssortimento>0){
        idAssortimento=0;
        AvviaCarDatiElencoArticoli("elencoArticoli","");
        if (vw<1200){
            document.getElementById("nav-toggleF").checked=false;
        }
        document.getElementById("lblFiltroAssortimento").innerHTML="Selezione: ";
        document.getElementById("tabAssortimento").removeAttribute("style");
        
        xFiltri-=1

        if (xFiltri==0){
            document.getElementById("cmdFiltri").removeAttribute("style");
        }

        eliminaStato(nomeStorage+".elencoAssortimento.id");
        eliminaStato(nomeStorage+".elencoAssortimento.descrizioneId");
    }
}

function listaDaAttributo(a){
    var xID=a.getAttribute("ID");

    if (daLoad){
        return;
    }

    xRag="";

    if (Filtri[nomePagina]['ATTRIBUTI']!=undefined) {
        if (Filtri[nomePagina]['ATTRIBUTI'].indexOf(xID+"§")>=0){
            Filtri[nomePagina]['ATTRIBUTI']=Filtri[nomePagina]['ATTRIBUTI'].replace(xID+"§",'');
            xFiltri-=1;
        } else {
            Filtri[nomePagina]['ATTRIBUTI']+=xID+"§";
            xFiltri+=1;
        }
    } else {
        Filtri[nomePagina]['ATTRIBUTI']=xID+"§";
        xFiltri+=1;
    }
    
    AvviaCarDatiElencoArticoli("elencoArticoli","");

    try {
        var xDes=Filtri[nomePagina]['ATTRIBUTI'].replace("§");

        if (xDes=='') {
            document.getElementById("tabAttributo").removeAttribute("style");
            
            if (xFiltri==0){
                document.getElementById("cmdFiltri").removeAttribute("style");
            }

            if (filtroApertura==""){
                eliminaStato(nomeStorage+".elencoAttributo.id");
                eliminaStato(nomeStorage+".elencoAttributo.descrizioneId");
            }
        } else {
            document.getElementById("tabAttributo").style.border="3px solid rgba("+xColoreSecondario+", 1)";    
            document.getElementById("cmdFiltri").style.border="3px solid rgba("+xColoreSecondario+", 1)";

            if (filtroApertura==""){
                segnaStato(a,"elencoAttributo",Filtri[nomePagina]['ATTRIBUTI'],xDes,"",nomeStorage);
            }
        }
    } catch (error) {
        
    }
}

function eliminaFiltroAttributo(a){
    if (Filtri[nomePagina]['ATTRIBUTI']!=""){
        Filtri[nomePagina]['ATTRIBUTI']="";
        
        AvviaCarDatiElencoArticoli("elencoArticoli","");

        var ul=document.getElementById("elencoAttributo");
        var chk=ul.getElementsByTagName("input");
        if (chk!=undefined){
            for (x=0;x<chk.length;x++){
                try {
                    if (chk[x].checked==true){
                        xFiltri-=1
                    }

                    chk[x].checked=false;
                } catch (error) {
                    
                }
            }
        }

        document.getElementById("tabAttributo").removeAttribute("style");

        if (xFiltri==0){
            document.getElementById("cmdFiltri").removeAttribute("style");
        }
        
        eliminaStato(nomeStorage+".elencoAttributo.id");
        eliminaStato(nomeStorage+".elencoAttributo.descrizioneId");
    }
}

function caricaStorico(xCodice,descrizione) {
    codice=xCodice;

    AvviaCarDatiElencoArticoli("elencoStorico","myStorico",true,0);
    
    modal=document.getElementById('myStorico');
    var captionText=document.getElementById("captionStorico");

    modal.style.display="block";
    captionText.innerHTML="<span class='clrTestoRosso'>"+codice+"</span> - "+descrizione; //codice+' - '+descrizione;    
}

function txtRicercaChange(input,inputID,ulID,sottoQuery,righe) {
    if (timer1) {
        clearTimeout(timer1);
    }

    timer1=setTimeout(function() { 
        xRag="";
        
        if (inputID=="txtRicercaArticolo"){
            ricerca=input.value;
        } else if (inputID=="txtRicercaBarCode"){
            ricercaCodiceBarre=input.value;
        } else {
            ricercaF=input.value;
        }
        
        if (parametriArticoli.modificheDenaro==1){
            if (ricerca==""){
                document.getElementById("elencoArticoli").innerHTML="";
                return;
            }
        }

        AvviaCarDatiElencoArticoli(ulID)

        clearTimeout(timer1); 
        
        //inputID=input.getAttribute("id");

        salvaFiltro(inputID);
    }, 1500);
}

function clickBack(){
    try {
        if (filtroApertura!=""){
            open ("mainPage.html",xTarget);
        } else if (idTes>0) {
            open ("statoOrdini.html","_self");
        } else if (idCliente==0 || idCliente==null || xIdCliente>0){
            if (xTarget=="_blank") {
                window.close();
            } else {
                open ("mainPage.html",xTarget);
            }
        } else {
            open ("schedaCliente.html?tipoAnagrafica="+tipoAnagrafica,"_self");
        }
    } catch (error) {
        open ("mainPage.html");
    }
}

function visualizzaCosto(idCosto,tipo=''){
    if (parametriArticoli["visCosto"]==1) {
        if (idCosto.indexOf(";")>0){
            var appo=idCosto.split(";");
            for (x in appo){
                if (tipo=='hidden'){
                    document.getElementById(appo[x]).setAttribute("class",document.getElementById(appo[x]).getAttribute("class")+' '+tipo);
                } else {
                    if (document.getElementById(appo[x]).getAttribute("class").indexOf("hidden")>0){
                        document.getElementById(appo[x]).setAttribute("class",document.getElementById(appo[x]).getAttribute("class").replace("hidden",''));
                    } else {
                        document.getElementById(appo[x]).setAttribute("class",document.getElementById(appo[x]).getAttribute("class")+' '+"hidden");
                    }
                }    
            }
        } else {
            if (tipo=='hidden'){
                document.getElementById(idCosto).setAttribute("class",document.getElementById(idCosto).getAttribute("class")+' '+tipo);
            } else {
                if (document.getElementById(idCosto).getAttribute("class").indexOf("hidden")>0){
                    document.getElementById(idCosto).setAttribute("class",document.getElementById(idCosto).getAttribute("class").replace("hidden",''));
                } else {
                    document.getElementById(idCosto).setAttribute("class",document.getElementById(idCosto).getAttribute("class")+' '+"hidden");
                }
            }
        }
    }
}

function inputFocus(e){
    e.select();
}

document.addEventListener('swiped-left', function(e) {
    switch (e.target.getAttribute("name")){
        case "switch":
            cambiaImmagine(e.target,1);
        break;
        case "switchM":
            cambiaImmagine(e.target,1,true);
        break;
    }
});

document.addEventListener('swiped-right', function(e) {
    switch (e.target.getAttribute("name")){
        case "switch":
            cambiaImmagine(e.target,-1);
        break;
        case "switchM":
            cambiaImmagine(e.target,-1,true);
        break;
    }
});

function cambiaImmagineMouse(codice,valore,daModal=false){
    if (daModal){
        var e=document.getElementById("img1");
    } else {
        var e=document.getElementById("img."+codice);
    }
    
    cambiaImmagine(e,valore,daModal);
}

function cambiaImmagine(e,valore,daModal=false){
    var maxImg=Number(e.getAttribute("maxImg"));
    var nrImg=Number(e.getAttribute("nrImg"));
    var actualImg=e.getAttribute("actualImg");
    var stile=e.getAttribute("stile");
    var id=e.id;
    var dimensione=230;

    if (daModal){
        var sw=document.getElementById("bw");
        dimensione=600;
    } else {
        var sw=document.getElementById(id.replace("img","sw"));
    }
    
    if (valore<0){
        a=1;
        b=nrImg;
    } else {
        a=nrImg;
        b=maxImg;
    }

    if (a<b){
        nrImg+=valore;
        e.src=urlImmagineArticolo(actualImg,nrImg,stile,dimensione);
        e.setAttribute("nrImg",nrImg);

        try {
            sw.innerHTML=nrImg+'/'+maxImg;
        } catch (error) {
            
        }
    }
}

function apriScala(codice,descrizione,scala,prezzo){
    modal=document.getElementById("modScalaSconti");
    modal.style.display="block";
    modal.setAttribute("codice",codice);
    modal.setAttribute("descrizione",descrizione);

    var cap=document.getElementById("captionScala");
    cap.innerHTML="<span class='clrTestoRosso'>"+codice+"</span> - "+descrizione;

    cap=document.getElementById("captionScalaPrezzo");
    cap.innerHTML="Prezzo Abituale "+prezzo;

    scala='['+scala.replace(/{/g,'{"').replace(/:/g,'":').replace(/;/g,',"').replace(/}/g,'}')+']';
    var jSon=JSON.parse(scala);

    if (parametriArticoli.modificheGuajana!=1){
        valorizzaHTMLElemento("divTitoloSS",`SCALA SCONTI <span class="close" onclick="chiudiModalBox('modScalaSconti');">&times;</span>`);
    }

    popolaElencoDaJson(jSon,"elencoScala",0,"ListaArticoli.html:scala");
}

function spiegaDisponibilita(i){
    attivaAlert(4,i.getAttribute("title"),"spiegaDisponibilita",i.src);
}

function apriAlternativi(codice){
    var parametri={"tipoQuery":"listaAlternativi","tipoRisposta":"elencoAlternativi","nomeQuery":nomePagina+":alternativi",
            "azienda":0,"idCliente":idCliente,"idDest":cIdDest,"idAgente":0,"codice":codice,
            "chiamante":"apriAlternativi", "percorsoImmagini":xPercorsoImmagini,
            "decimaliPrezzi":parametriArticoli["decimaliPrezzi"], "hDescrizione":parametriArticoli["hDescrizione"], "hContainer":parametriArticoli["hContainer"],
            "hLi":parametriArticoli["hLi"], "hContainerNP":parametriArticoli["hContainerNP"],"hLiNP":parametriArticoli["hLiNP"], "idIvaCliente":idIvaCliente,
            "percIvaCliente":percIvaCliente,"offLine":xOffLine,"idDeposito":idDeposito
            }; 
    
    elencoInCaricamento=1;

    inviaRichiestaCentralino("multiQuery",parametri,elaboraRispostaAlternativi,"divCorpo");
}

function elaboraRispostaAlternativi(res){
    var risp=JSON.parse(res);
    var parametri=risp.parametri;
    var data=risp.risposta;

    if (risp.error!=''){
        return "";
    }
    
    query['ListaArticoli.html:alternativi']['modelloRiga']=query['ListaArticoli.html']['modelloRiga'].replace('class="col3Catalogo','class="col4Alternativi');

    popolaElencoDaJson(data,parametri.tipoRisposta,0,parametri.nomeQuery,true,0,"x",nomeCarrello);

    modal=document.getElementById("modAlternativi");
    modal.style.display="block";
    modal.setAttribute("codice",codice);
    //modal.setAttribute("descrizione",descrizione);

    var cmdA=modal.getElementsByClassName("cmdAlternativi");
    for (x=0;x<cmdA.length;x++){
        cmdA[x].style.display="none";
    }

    elencoInCaricamento=0;
}

function apriOpzioni(codice){
    var parametri={"tipoQuery":"listaOpzioni","tipoRisposta":"elencoOpzioni","nomeQuery":nomePagina+":opzioni",
            "azienda":0,"idCliente":idCliente,"idDest":cIdDest,"idAgente":0,"codice":codice,
            "chiamante":"apriAlternativi", "percorsoImmagini":xPercorsoImmagini,
            "decimaliPrezzi":parametriArticoli["decimaliPrezzi"], "hDescrizione":parametriArticoli["hDescrizione"], "hContainer":parametriArticoli["hContainer"],
            "hLi":parametriArticoli["hLi"], "hContainerNP":parametriArticoli["hContainerNP"],"hLiNP":parametriArticoli["hLiNP"], "idIvaCliente":idIvaCliente,
            "percIvaCliente":percIvaCliente,"idDeposito":idDeposito
            }; 
    
    elencoInCaricamento=1;

    if (xOffLine=="true"){
        parametri.ricerca="";
        parametri.campiFiltroIN=[{"nomeChiave":"ALTERNATIVI","nomeParametro":"codice","testo":1}];
        parametri.nomeTabellaOrdinata="listaArticoli";
        parametri.funzioniParticolari=fnContrattiIDB;
        parametri.attivaAlert=true;

        leggiTabellaIndexedDB("articoli",parametri,"ricerca",elaboraRispostaOpzioni);
    } else {
        inviaRichiestaCentralino("multiQuery",parametri,elaboraRispostaOpzioni,"divCorpo");
    }
}

function elaboraRispostaOpzioni(res){
    var risp=JSON.parse(res);
    var parametri=risp.parametri;
    var data=risp.risposta;

    if (risp.error!=''){
        return "";
    }
    
    query['ListaArticoli.html:opzioni']['modelloRiga']=query['ListaArticoli.html']['modelloRiga'].replace('class="col3Catalogo','class="col4Alternativi').replace('onclick="apriImmagine(this','onclick1="apriImmagine(this)');

    popolaElencoDaJson(data,parametri.tipoRisposta,0,parametri.nomeQuery,true,0,"x",nomeCarrello);

    modal=document.getElementById("modOpzioni");
    modal.style.display="block";
    modal.setAttribute("codice",codice);
    //modal.setAttribute("descrizione",descrizione);

    var cmdA=modal.getElementsByClassName("cmdAlternativi");
    for (x=0;x<cmdA.length;x++){
        cmdA[x].style.display="none";
    }

    elencoInCaricamento=0;
}

function pulisciUL(idUL){
    ul=document.getElementById(idUL);

    var li=ul.getElementsByTagName("li");
    var codici=new Array;
    for (x=0;x<li.length;x++){
        codici[x]=li[x].getAttribute("id");
    }

    ul.innerHTML="";

    var prodotti = carrelloJson.prodotti.data;
    var index=carrelloJson.prodotti.index;

    for (x=0;x<codici.length;x++){
        var i=index[codici[x]];
        if (i!=undefined){
            aggiornaLabelOrdinato(codici[x],prodotti[i].qu);
        } else {
            aggiornaLabelOrdinato(codici[x],0);
        }
    }
}

function caricaDatiDestinazione(idDest){
    var parametri={"tipoRisposta":"datiDest","tipoQuery":"querySpecifica","nomeTabella":"datiDestinazione","idDest":idDest};

    elencoInCaricamento=1;

    inviaRichiestaCentralino("query",parametri,elaboraRispostaDestinazione,"divCorpo");   
}

function elaboraRispostaDestinazione(res){
    var risp=JSON.parse(res);
    var parametri=risp.parametri;
    var data=risp.risposta;

    if (risp.error!=''){
        return "";
    }

    xNomeDestinazione = "nDestinazione."+idServer+"."+tipoAnagrafica+"."+idCliente;
    cIdDest=localStorage.setItem(xNomeDestinazione,JSON.stringify(data[0]));    
    cIdDest=data[0].idDest;
}

function assegnaSconto(){
    if (parametriArticoli["modificheTroia"]==1 && xIdCliente==0){
        var codice=recuperaHTMLElemento('divModalCodice');
        var grMerc=recuperaHTMLElemento('GRMERC.'+codice);
        var noScontoArticolo=recuperaHTMLElemento('NOSCONTISUAPP.'+codice);
        var percIva=recuperaHTMLElemento("divPercIvaM");

        if (recuperaValueElemento("txtSc1")==0 && noScontoArticolo==0){
            if(percIva==4){
                valorizzaValueElemento("txtSc1",2);
            } else {
                valorizzaValueElemento("txtSc1",5);
            }
        } else {
            valorizzaValueElemento("txtSc1",0);
        }        

        var txtSc1=document.getElementById("txtSc1");
        calcolaImporto(txtSc1);
    }
}

function apriImmagine(img, modalName,hideMultiImg='hide',nrImg=0,codice='',HIDDENALLEGATOTECNICO='hide',allegatiWeb='',codiceForn='', car1='',car2='',car3='',opzioni='',linkRaggruppamento='',imgMarchio='') {
    modal=document.getElementById(modalName);
    var modalImg=document.getElementById("img1");
    var captionText=document.getElementById("captionImg");
    
    attivaTouchZoom(modalImg);
    
    var src=img.src;
    
    var appo=src.split("&");
    for (x in appo){
        var c=appo[x].split("=");
        if (c[0]=="thumb"){
            var reg=new RegExp('&'+appo[x],'g');
            src=src.replace(reg,'');
        }
    }

    try {
        var sw=document.getElementById("bw");
        sw.innerHTML="1/"+nrImg;
        if (nrImg!=1){
            sw.style.display="block"
            sw=document.getElementById("bwI");
            sw.setAttribute("onclick","cambiaImmagineMouse('"+codice+"',-1,true)");
            sw.style.display="block"
            sw=document.getElementById("bwA");
            sw.style.display="block"
            sw.setAttribute("onclick","cambiaImmagineMouse('"+codice+"',1,true)");
        } else {
            sw.style.display="none"
            sw=document.getElementById("bwI");
            sw.style.display="none"
            sw=document.getElementById("bwA");
            sw.style.display="none"
        }

        modalImg.setAttribute("maxImg",nrImg);
        modalImg.setAttribute("actualImg",img.getAttribute("actualImg"));
        modalImg.setAttribute("nrImg",1);

        sw=document.getElementById("cmdAllegatoM");
        if (HIDDENALLEGATOTECNICO==''){
            sw.style.display="block";
            sw.setAttribute("onclick","apriAllegato('"+allegatiWeb+"','divFrame','xFrame');")
        } else {
            sw.style.display="none";
        }

        sw=document.getElementById("cmdOpzioniM");
        if (opzioni==''){
            sw.style.display="block";
            sw.setAttribute("onclick","apriOpzioni('"+codice+"');")
        } else {
            sw.style.display="none";
        }

        sw=document.getElementById("spCodiceM");
        sw.innerHTML=codice;
        sw=document.getElementById("spCodiceF");
        sw.innerHTML=" - "+codiceForn;
        nodoimgMarchio=document.getElementById('marchioModalImmagine');
        // if(nodoimgMarchio!=undefined){
        //     nodoimgMarchio.parentElement.removeChild(nodoimgMarchio);
        // }
        nodoimgMarchio.src='';
        hide(nodoimgMarchio.id)
        if(imgMarchio!=''){
            // var imgMarchio=`<img class="w100p" style="position:absolute; top:100px; left: 15px;" src="${urlImmagineArticolo(imgMarchio,"","rect","230")}" id="marchioModalImmagine">`;
            nodoimgMarchio.src=urlImmagineArticolo(imgMarchio,"","rect","230");
            show(nodoimgMarchio.id)
            // modal.innerHTML+=imgMarchio;
            
        }
    } catch (error) {
        console.log(error);
    }
    
    modalImg.src=src.replace(/&crop=1/g,"");
    
    var c1="";
    var c2="";
    var c3="";

    if (car1!=""){
        c1="<br><br><b>Caratteristica 1:</b> "+car1;
    }

    if (car2!=""){
        c2="<br><br><b>Caratteristica 2:</b> "+car2;
    }

    if (car3!=""){
        c3="<br><br><b>Caratteristica 3:</b> "+car3;
    }

    var dLink=document.getElementById("divLinkFam");
    dLink.innerHTML="";

    if (linkRaggruppamento!=''){
        var m=linkRaggruppamento.split("}");
        for (x in m){
            var v=m[x].split("§");

            if (v[0]!="0" && v[0]!=""){
                dLink.innerHTML+=`<a href="#" class="row pulsante sx marg2Dx testo16 marg2Bottom" onclick="listaDaRaggruppamento('${v[0]}',\`${v[1]}\`,'${v[2]}')">${v[1]}</a>`;
            }
        }
    }

    captionText.innerHTML=img.getAttribute("datiImg")+c1+c2+c3;
    modal.style.display="block";
}

function listaDaRaggruppamento(idFamiglia,desFamiglia,tipoFamiglia){
    if (Filtri[nomePagina]['GRMERC']!="" || Filtri[nomePagina]['SGR_MERC']!="" || Filtri[nomePagina]['SFAM1']!="" || Filtri[nomePagina]['SFAM2']!=""){
        xFiltri-=1;
    }

    Filtri[nomePagina]['GRMERC']="";
    Filtri[nomePagina]['SGR_MERC']="";
    Filtri[nomePagina]['SFAM1']="";
    Filtri[nomePagina]['SFAM2']="";

    xRag="";

    Filtri[nomePagina][tipoFamiglia]=idFamiglia;

    valorizzaValueElemento("txtRicercaArticolo","");
    ricerca="";

    AvviaCarDatiElencoArticoli("elencoArticoli","");

    document.getElementById("lblFiltroFamiglia").innerHTML="Selezione: "+desFamiglia;
    document.getElementById("tabFamiglia").style.border="3px solid rgba("+xColoreSecondario+", 1)";
    document.getElementById("cmdFiltri").style.border="3px solid rgba("+xColoreSecondario+", 1)";

    xFiltri+=1;

    var sezione="";

    if (nomeStorage!="") {
        sezione=nomeStorage;
    } else {
        sezione=nomePagina;
        if (tipoAnagrafica!=''){
            sezione+="."+tipoAnagrafica;
        }
    }
    
    var ulName="elencoFamiglia";

    window.sessionStorage.setItem(sezione+"."+ulName+".id", idFamiglia+":"+tipoFamiglia);
    window.sessionStorage.setItem(sezione+"."+ulName+".descrizioneId",desFamiglia);

    chiudiModalBox('myModal');
}

function avviaRicercaLettoreBarcode(inputID){
    var input=document.getElementById(inputID);
    ricercaCodiceBarre=input.value;
    
    AvviaCarDatiElencoArticoli("elencoArticoli");
}

async function fnContrattiIDB(rsO,parametri){
    try {
        var rsD=[];
        var saltati=parametri.saltati;

        for (z in rsO){
            var jSonCli=JSON.parse(sessionStorage.getItem("schedaCliente.html."+tipoAnagrafica+"."+idCliente+".jSon")); 
            var contratti=eval(jSonCli[0].CONTRATTI);

            var rs=[];
            var rsSS=[];

            rsO[z].GIORNALINOS=0;
            rsO[z].GIORNALINO=0;
            rsO[z].INPROMO=0;

            if (contratti!=null){
                var tran=db.transaction(["contratti","scalaSconti"],'readonly')
                var tab=tran.objectStore("contratti");
                var tabSS=tran.objectStore("scalaSconti");

                for (x in contratti){
                    let promise = new Promise((resolve,reject) => {
                        tab.get([String(contratti[x]),rsO[z].CODICE]).onsuccess = function(e) {
                            resolve(e.target.result);
                        }
                    });

                    let result=await promise;
                    
                    if (result!=undefined){
                        rs.push(result);
                    }

                    let promiseSS = new Promise((resolve,reject) => {
                        tabSS.get([String(contratti[x]),rsO[z].CODICE]).onsuccess = function(e) {
                            resolve(e.target.result);
                        }
                    });

                    let resultSS=await promiseSS;
                    
                    if (resultSS!=undefined){
                        rsSS.push(resultSS);
                    }
                }

                if (rs.length!=0){
                    var i=0;
                    var riga=999999;

                    for (x in rs){
                        if (Number(rs[x].RIGA)<riga){
                            riga=Number(rs[x].RIGA);
                            i=x;
                        }
                    }

                    var result2=rs[i];

                    rsO[z].PREZZO=result2.PREZZO;
                    rsO[z].PREZZOII=result2.PREZZOII;
                    rsO[z].SC1=result2.SC1;
                    rsO[z].DESSCONTO=result2.DESSCONTO;
                    rsO[z].SCONTATO=result2.SCONTATO;
                    rsO[z].SCONTATOII=result2.SCONTATOII;
                    rsO[z].przNetto=result2.przNetto;
                    rsO[z].INPROMO=result2.PRIORITA;
                    rsO[z].GIORNALINO=result2.GIORNALINO;

                    if (result2.PRIORITA==0){
                        rsO[z].DPROMO='hide';
                        rsO[z].NOPROMO='';
                    } else {
                        rsO[z].DPROMO='';
                        rsO[z].NOPROMO='hide';
                    }

                    if (result2.GIORNALINO==1){
                        rsO[z].HIDEPROMO='';
                        rsO[z].GIORNALINOI=1;
                    } else {
                        rsO[z].HIDEPROMO='hide';
                        rsO[z].GIORNALINOI=0;
                    }
                }

                if (rsSS.length!=0){
                    var i=0;
                    var riga=999999;

                    for (x in rsSS){
                        if (Number(rsSS[x].RIGA)<riga){
                            riga=Number(rsSS[x].RIGA);
                            i=x;
                        }
                    }

                    var result2=rsSS[i];

                    rsO[z].SCALA=result2.SCALA;
                    rsO[z].GIORNALINOS=result2.GIORNALINOS;

                    if (result2.SCALA==''){
                        rsO[z].HIDESCALA='hide';
                        rsO[z].NOHIDESCALA='';
                        rsO[z].SCALASCONTI=0;
                    } else {
                        rsO[z].HIDESCALA='';
                        rsO[z].NOHIDESCALA='hide';
                        rsO[z].SCALASCONTI=1;
                    }

                    if (result2.GIORNALINOS==1 || result2.SCALA==''){
                        rsO[z].HIDENETTO='hide';
                    } else {
                        rsO[z].HIDENETTO='';
                    }

                    if (result2.GIORNALINOS==1 || rsO[z].GIORNALINOI==1){
                        rsO[z].HIDEPROMO='';
                    } else {
                        rsO[z].HIDEPROMO='hide';
                    }
                }
            } 

            if (parametriArticoli.modificheGuajana==1){
                if (parametri.inPromo>0){
                    if (rsO[z].GIORNALINO==0 && rsO[z].GIORNALINOS==0){
                        parametri.saltati++;
                        continue;
                    }
                }
        
                if (parametri.scalaSconti>0){
                    if (rsO[z].SCALA=='' || rsO[z].GIORNALINOS==1){
                        parametri.saltati++;
                        continue;
                    }
                }
        
                if (parametri.promoScala>0){
                    if (rsO[z].SCALA=='' && rsO[z].GIORNALINO==0){
                        parametri.saltati++;
                        continue;
                    }
                }
            } else {
                if (parametri.promoScala>0){
                    if (rsO[z].INPROMO==0 && rsO[z].SCALA==''){
                        parametri.saltati++;
                        continue;
                    }
                }
            }

            var obj=eval(rsO[z].CLIENTI);

            if (obj!=undefined){
                if (obj.includes(Number(idCliente))==false){
                    rsO[z].HIDDENSTORICO="hidden";
                } else {
                    rsO[z].HIDDENSTORICO="";
                }
            }

            rsD.push(rsO[z]);
        }

        if ((parametri.saltati-saltati>50 || rsD.length==0) && parametri.totaleRecordTabella>parametri.offSet && rsD.length<75 && rsO.length>0){
            parametri.offSet+=parametri.saltati;
            parametri.fetch+=parametri.saltati;
        
            leggiTabellaIndexedDB("articoli",parametri,"ricerca",elaboraRisposta,false,rsD);
        } else {
            parametri.fetch+=parametri.saltati;
            res=impacchettaRispostaIndexedDB(rsD,parametri);
            parametri.callBack(res);
        }
    } catch (error) {
        console.error(error);
        parametri.fetch+=parametri.saltati;
        res=impacchettaRispostaIndexedDB(rsO,parametri);
        parametri.callBack(res);        
    } 
}

async function fnScalaScontiIDB(cursor){
   return cursor; 
}

function caricaDettagliInArrivo(xCodice,descrizione) {
    codice=xCodice;

    AvviaCarDatiElencoArticoli("elencoInArrivo","modalMerceInArrivo",true,0);
    
    modal=document.getElementById('modalMerceInArrivo');
    var captionText=document.getElementById("captionInArrivo");

    modal.style.display="block";
    captionText.innerHTML="<span class='clrTestoRosso'>"+codice+"</span> - "+descrizione; //codice+' - '+descrizione;    
}

function ricalcolaArrivi(parametri,data){
    try {
        var tArrivo=Number(recuperaHTMLElemento("ord."+parametri.codice));
        var tot=0;

        for (x in data){
            tot+=Number(data[x].QU);
        }

        tArrivo=tot-tArrivo;
        tot=0;

        console.log(tArrivo);

        if (tArrivo<=0){
            return;
        }

        for (x in data){
            if (tArrivo-tot==0){
                return;
            }

            if (Number(data[x].QU)>tArrivo-tot){
                data[x].QU=formattaNumeri(Number(data[x].QU)-(tArrivo-tot),3,0);
                return;
            } else {
                tot-=Number(data[x].QU);
                if (x==0 && data.length>1){
                    data[1].max=data[x].max;
                }
                data.splice(x,1);
            }
        }
    } catch (error) {
        console.error (error);
    }
}
var linkRapidi=new Array;
function modalLinkRapido(){
    parametri={"tipoRisposta":"select","tipoQuery":"querySpecifica","nomeTabella":"listaLinkRapidiListaArticoli","elencoCompletoLinkRapidi":"true"};
    inviaRichiestaCentralino("query",parametri,(res)=>{
        var risp=JSON.parse(res);
        var parametri=risp.parametri;
        
        linkRapidi=risp.risposta;
        apriModalDettagli('ListaArticoli.html:elencoLinkRapidiListaArticoli','Clicca sul tasto copia, per copiare il link rapido',linkRapidi,0,true,'');
    });
}
function salvaArrayFILTRI(){
    var x={};
    for([k,v] of Object.entries(Filtri['ListaArticoli.html'])){
        x[k]=v
    }
    
    return JSON.stringify(x);
}
function salvaFiltriBackend(){
    var y={};
    for([k,v] of Object.entries(query['ListaArticoli.html:variabili'])){
        y[k]=eval(v);
    }
    return JSON.stringify(y);
}

function presenzaLinkRapido(){
    var id=location.search.split('=');
    if(linkRapidiObj[id[1]]!=undefined){
        // var x=linkRapidiObj[id[1]];
        // for([k,v] of Object.entries(x)){
        //     if(v!=null && IsJsonString(v)){
        //         for([JK,JV] of Object.entries(JSON.parse(v))){
        //             Filtri['ListaArticoli.html'][JK]=JV;
        //         }
        //     }else{
        //         console.log(''+k+` = '${v==null ? '':v}'`);
        //         try{
        //         if(query['ListaArticoli.html:variabili'][k].indexOf('session')!=-1 ){
        //             eval(''+k+` = '${v==null ? '':v}'`);
        //         }else{
        //             eval(''+k+` = '${v}'`);
        //         }
        //     }catch(e){
        //         console.error(e);
        //     }
                
        //     }
            
        // }
        
        return true
    }else{
        return false;
    }
    
    // AvviaCarDatiElencoArticoli("elencoArticoli","");
}
function apriFormInserimentoLinkListaArticoli(){
    if (document.getElementById("divFormAddInserimentoLInk")==undefined){
        var ul=document.getElementById("elencoDettagli");
        ul.innerHTML+=elementoLiInserimenoLink;

        var li=document.getElementById("liXAggiuntaLink");
        li.innerHTML=elementoFormInserimentoLink;
        document.getElementById('chkSovrascriviFiltri').checked=true;
        ul.scrollTop=ul.scrollHeight;
        document.getElementById('txtLinkEsterno').disabled=true;
        
    }
}
var liOrigD;
function apriFormModificaLinkListaArticoli(riga){

    if (document.getElementById("divFormAddInserimentoLInk")==undefined){

                var li=document.getElementById("link-"+riga);
                liOrigD=li.innerHTML;
                li.innerHTML=elementoFormInserimentoLink;

                document.getElementById("cmdSalvaLink").setAttribute("onclick","salvaLinkListaArticoli('"+riga+"')");
                document.getElementById("cmdAnnullaLink").setAttribute("onclick","annullaFormLinkListaArticoli('"+riga+"')");
                popolaFormModificaDati(linkRapidi[riga],"ListaArticoli.html:linkRapido");
                var ul = document.getElementById("immagineCarosello");
                ul.innerHTML='';
                var elementiAllegati = `<li id="emAt.{NOMEFILE}" name="{NOMEFILE}" class="w100-5p clrSfumatoScuro clrContorno elementiGriglia marg5Bottom" url="{URL}">
                <a id="a.{NOMEFILE}" href="{URL}" target="_blank" class="w100-45p clrSfumatoScuro">
                    <img class="row marg5Dx" src="img/bianche/pdf.svg"/>
                    {NOMEFILE}
                </a>
                <img id="del.{NOMEFILE}" class="rowDx marg5Top marg5Dx hide" title="Rimuovi Allegato" src="img/bianche/delete.svg" onclick="rimuoviImmagineCaroselloBackend(\'{NOMEFILE}\',\'{ID}\')"/>
            </li>`;
            if(linkRapidi[riga].imgCarosello!=''){
                ul.innerHTML += elementiAllegati.replace(/{URL}/g, xUrlBase+'\\pdf\\'+xIdConfigurazione+'\\slideShow\\'+linkRapidi[riga].imgCarosello).replace(/{NOMEFILE}/g, linkRapidi[riga].imgCarosello).replace(/ hide/g, '').replace(/{ID}/g, linkRapidi[riga].id);
            }
            document.getElementById('chkSovrascriviFiltri').checked=false;
    } else {
        attivaAlert(0,"Concludere la modifica in Corso!","apriModificaDestinazione");
    }
} 
function rimuoviImmagineCaroselloBackend(nomeFile,id){
    
    parametri = {
        "tipoQuery": "eliminaImmagineCaroselloBackend",
        "tipoRisposta": '',
        "nomeFile":nomeFile,
        "nomeTabella": "eliminaImmagineCaroselloBackend",
        "id":id
    };
    inviaRichiestaCentralino("multiQuery", parametri,(res)=>{
        var risp=JSON.parse(res);
        if(risp.error==''){
            var li = document.getElementById("emAt." + nomeFile);
            li.parentNode.removeChild(li);
        }
    });
}
function annullaFormLinkListaArticoli(id=''){
	globalClickButton=true;
	globalModificaInCorso=false;

    if (id==''){
        var e=document.getElementById("liXAggiuntaLink");
        e.parentNode.removeChild(e);
    } else {
        var e=document.getElementById("link-"+id);
        e.innerHTML=liOrigD;
    }
}
function salvaLinkListaArticoli(riga='',verificaPresenzaImmagini=true){
    if(!isEmpty(fotoCarosello) && verificaPresenzaImmagini==true){
        
            var r = 0;
            var formData = new FormData();
            for (x in fotoCarosello) {
                r++;
                formData.append(xIdDispositivo + '§' + xTkCom + '§' + xUserCom.replace(/\./g,"__") + "§" + xIdConfigurazione + "§" + r, fotoCarosello[x]);
            }
        
            var parametri = { "chiamante": "FileUpload" };
        
            inviaRichiestaCentralinoUploadFile(formData, parametri, function (res) {
                var risp = JSON.parse(res);
                var parametri = risp.parametri;
                var data = risp.risposta;
        
                if (risp.error != '') {
                    attivaAlert(xTipoAllert.ESCLAMAZIONE,risp.error);
                } else if (data == 'ok') {
                    salvaLinkListaArticoli(riga,false);
                    // fotoCarosello = {};
                }
        
            });
        
    }else{

        var tipo="salva";
        if(riga!=''){
            tipo='update';
        }
        jSon={
            'descrizione':recuperaValueElemento('txtDescrizioneLinkRapido'),
            'dataDa':document.getElementById('txtDataValiditaDa').value,
            'dataA':document.getElementById('txtDataValiditaA').value,
            'linkEsterno':recuperaValueElemento('txtLinkEsterno')
        }
        if(tipo=='update'){
            jSon.id=linkRapidi[riga].id
        }
        if(document.getElementById('chkSovrascriviFiltri').checked==true ){
            jSon.jsonFiltri=salvaFiltriBackend();
        }
        
        if(!isEmpty(fotoCarosello)){
            for([k,v] of Object.entries(fotoCarosello)){
                jSon.imgCarosello=v.name
                break;
            }
        }
        if(jSon.linkEsterno!=''){
            jSon.jsonFiltri='';
        }
    
        var parametri={"tipoRisposta":tipo,"tipoSalva":"linkRapido", "dati":jSon};
        inviaRichiestaCentralino(tipo,parametri,(res)=>{
            var risp=JSON.parse(res);
            if(risp.error==''){
                fotoCarosello={};
                modalLinkRapido();
            }else{
                attivaAlert(xTipoAllert.CRITICO,risp.error);
            }

        });
    }
}
function allegaFotoRiga(input) {
    var ul = document.getElementById("immagineCarosello");
    if(ul.innerHTML==''){
    try {
        inputElement = document.getElementById(input);
        inputElement.addEventListener("change", conservaFoto, false);

        inputElement.click();
    } catch (error) {
        console.log(error);
    }
}else{
    attivaAlert(xTipoAllert.ESCLAMAZIONE,'è possibile caricare un solo file per il carosello, eliminare la foto già caricata prima di procedere!');
}
}
var fotoCarosello = {};

function conservaFoto(evt) {
    var tgt = evt.target || window.event.srcElement,
        files = tgt.files;
    fotoCarosello={}
    const fileList = this.files;

    for (i = 0; i < files.length; i++) {
        url = URL.createObjectURL(files[i]);
        fotoCarosello[url] = renameFile(fileList[i], Date.now() + '-' + files[i].name);

        var ul = document.getElementById("immagineCarosello");
        ul.innerHTML='';
        var elementiAllegati = `<li id="emAt.{NOMEFILE}" name="{NOMEFILE}" class="w100-5p clrSfumatoScuro clrContorno elementiGriglia marg5Bottom" url="{URL}">
        <a id="a.{NOMEFILE}" href="{URL}" target="_blank" class="w100-45p clrSfumatoScuro">
            <img class="row marg5Dx" src="img/bianche/pdf.svg"/>
            {NOMEFILE}
        </a>
        <img id="del.{NOMEFILE}" class="rowDx marg5Top marg5Dx hide" title="Rimuovi Allegato" src="img/bianche/delete.svg" onclick="rimuoviFotoTmp(\'{NOMEFILE}\',\'{URL}\')"/>
    </li>`;
        ul.innerHTML += elementiAllegati.replace(/{URL}/g, url).replace(/{NOMEFILE}/g, fotoCarosello[url].name).replace(/ hide/g, '');
    }
}
function rimuoviFotoTmp(nomeFile, url) {
    var li = document.getElementById("emAt." + nomeFile);
    li.parentNode.removeChild(li);
    delete fotoCarosello[url];
}
function generaLinkListaArticoli(riga){
    var linkBase=location.origin+''+location.pathname+'?linkRapido='+riga;
    navigator.clipboard.writeText(linkBase);
    attivaAlert(xTipoAllert.SUCCESSO,'Link copiato con successo!');
}


function eliminaLink(userName,descrizione) {
    if (userName!=''){
        attivaAlert(5,"Sei sicuro di voler eliminare il link "+descrizione+"?","rispEliminaLink_"+userName);        
    }
}

function rispEliminaLink(risp, id) {
    
    if (risp=="Si") {
        parametri = {
            "tipoQuery": "eliminaImmagineCaroselloBackend",
            "tipoRisposta": '',
            "nomeTabella": "eliminaImmagineCaroselloBackend",
            "id":id
        };
        inviaRichiestaCentralino("multiQuery", parametri,(res)=>{
            var risp=JSON.parse(res);
                if(risp.error==''){
                    modalLinkRapido();
                }else{
                    attivaAlert(xTipoAllert.CRITICO,risp.error);
                }
        });             
    } else {
        chiudiModalAlert("rispEliminaUtente."+userName);
    }
}

function apriModalDettaglioGiacenze(codiceArticolo){
    if(parametriArticoli.dettaglioGiacenze!=undefined && parametriArticoli.dettaglioGiacenze==1){
        avviaRichiestaModalDettaglioGiacenze(codiceArticolo);
    }
}

function chkFiltriLink(input){
    if(input.checked==true){
        document.getElementById('txtLinkEsterno').value='';
        document.getElementById('txtLinkEsterno').setAttribute('disabled',true);
        document.getElementById("divForzaLink").classList.add("hide");
    }else{
        document.getElementById('txtLinkEsterno').removeAttribute('disabled');
        document.getElementById("divForzaLink").classList.remove("hide");
    }
}

function stampaCatalogoPDF(){
    try{
        AvviaCarDatiElencoArticoli("elencoArticoli","",true,0,false,"catalogoListaArticoli");        
    }catch(e){

    }
}
function selezionaCarico(li,idCaricoSelezionato){
    if(idCarico>0){
        var exCarico=document.getElementById('liCarico_'+idCarico);
        exCarico.classList.remove('filtroSelezionato');
    }
    idCarico=idCaricoSelezionato;
    li.classList.add('filtroSelezionato');
    AvviaCarDatiElencoArticoli("elencoArticoli","");
    document.getElementById('tabCarichi').classList.add('filtroSelezionato');
    if (vw<1200){
        document.getElementById("nav-toggleF").checked=false;
    }
    document.getElementById('lblCaricoSelezionato').innerHTML="Selezionato: "+document.getElementById('ragioneSocialeCarico_'+idCaricoSelezionato).innerHTML;
}
function eliminaFiltroCarico(){
    if(idCarico>0){
        var exCarico=document.getElementById('liCarico_'+idCarico);
        exCarico.classList.remove('filtroSelezionato');
        idCarico=0;
        AvviaCarDatiElencoArticoli("elencoArticoli","");
        document.getElementById('tabCarichi').classList.remove('filtroSelezionato');
        document.getElementById('lblCaricoSelezionato').innerHTML="Selezionato: ";
    }
}