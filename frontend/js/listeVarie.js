// Codici Iva
query['listeVarie.html:codiciIva']=new Array;
query['listeVarie.html:codiciIva']['OFFSET']=0;
query['listeVarie.html:codiciIva']['FETCH']=100;
query['listeVarie.html:codiciIva']['MAXFETCH']=0;
query['listeVarie.html:codiciIva']['COUNT']="id";
query['listeVarie.html:codiciIva']['textBoxRicerca']="txtRicercaCliente";
query['listeVarie.html:codiciIva']['numeroModello']=2;
query['listeVarie.html:codiciIva']['modello2Righe']=elementiListeVarieCodiciIva;
query['listeVarie.html:codiciIva']['title']="Codici Iva";

// Famiglie Articoli
query['listeVarie.html:famiglieArticoli']=new Array;
query['listeVarie.html:famiglieArticoli']['OFFSET']=0;
query['listeVarie.html:famiglieArticoli']['FETCH']=100;
query['listeVarie.html:famiglieArticoli']['MAXFETCH']=0;
query['listeVarie.html:famiglieArticoli']['COUNT']="id";
query['listeVarie.html:famiglieArticoli']['textBoxRicerca']="txtRicercaCliente";
query['listeVarie.html:famiglieArticoli']['numeroModello']=1;
query['listeVarie.html:famiglieArticoli']['modello1Riga']=elementiListeVarieFamiglieArticoli;
query['listeVarie.html:famiglieArticoli']['title']="Famiglie Articoli";

// TipologieArticoli
query['listeVarie.html:tipologieArticoli']=new Array;
query['listeVarie.html:tipologieArticoli']['OFFSET']=0;
query['listeVarie.html:tipologieArticoli']['FETCH']=100;
query['listeVarie.html:tipologieArticoli']['MAXFETCH']=0;
query['listeVarie.html:tipologieArticoli']['COUNT']="id";
query['listeVarie.html:tipologieArticoli']['textBoxRicerca']="txtRicercaCliente";
query['listeVarie.html:tipologieArticoli']['numeroModello']=2;
query['listeVarie.html:tipologieArticoli']['modello2Righe']=elementiListeVarieTipologieArticoli;
query['listeVarie.html:tipologieArticoli']['title']="Tipologie Articoli";

// TipologiaArticoli2
query['listeVarie.html:tipologieArticoli2']=new Array;
query['listeVarie.html:tipologieArticoli2']['OFFSET']=0;
query['listeVarie.html:tipologieArticoli2']['FETCH']=100;
query['listeVarie.html:tipologieArticoli2']['MAXFETCH']=0;
query['listeVarie.html:tipologieArticoli2']['COUNT']="id";
query['listeVarie.html:tipologieArticoli2']['textBoxRicerca']="txtRicercaCliente";
query['listeVarie.html:tipologieArticoli2']['numeroModello']=1;
query['listeVarie.html:tipologieArticoli2']['modello1Riga']=elementiListeVarieDescrizione;
query['listeVarie.html:tipologieArticoli2']['title']="Tipologia Articoli 2";

// FamiglieCliFor
query['listeVarie.html:famiglieCliFor']=new Array;
query['listeVarie.html:famiglieCliFor']['OFFSET']=0;
query['listeVarie.html:famiglieCliFor']['FETCH']=100;
query['listeVarie.html:famiglieCliFor']['MAXFETCH']=0;
query['listeVarie.html:famiglieCliFor']['COUNT']="id";
query['listeVarie.html:famiglieCliFor']['textBoxRicerca']="txtRicercaCliente";
query['listeVarie.html:famiglieCliFor']['numeroModello']=2;
query['listeVarie.html:famiglieCliFor']['modello2Righe']=elementiListeVarie2Righe;
query['listeVarie.html:famiglieCliFor']['title']="Famiglie Cli/For";

// Zone
const tagListeVarieHtmlZone = 'listeVarie.html:zone';
query[tagListeVarieHtmlZone]=new Array;
query[tagListeVarieHtmlZone]['OFFSET']=0;
query[tagListeVarieHtmlZone]['FETCH']=100;
query[tagListeVarieHtmlZone]['MAXFETCH']=0;
query[tagListeVarieHtmlZone]['COUNT']="id";
query[tagListeVarieHtmlZone]['textBoxRicerca']="txtRicercaCliente";
query[tagListeVarieHtmlZone]['numeroModello']=1;
query[tagListeVarieHtmlZone]['modello1Riga']=elementiListeVarieDescrizione;
query[tagListeVarieHtmlZone]['title']="Zone";

// Banche
const tagListeVarieHtmlBanche = 'listeVarie.html:banche';
query[tagListeVarieHtmlBanche]=new Array;
query[tagListeVarieHtmlBanche]['OFFSET']=0;
query[tagListeVarieHtmlBanche]['FETCH']=100;
query[tagListeVarieHtmlBanche]['MAXFETCH']=0;
query[tagListeVarieHtmlBanche]['COUNT']="id";
query[tagListeVarieHtmlBanche]['textBoxRicerca']="txtRicercaCliente";
query[tagListeVarieHtmlBanche]['numeroModello']=1;
query[tagListeVarieHtmlBanche]['modello1Riga']=elementiListeVarieDescrizione;
query[tagListeVarieHtmlBanche]['title']="Banche";

// Depositi
query['listeVarie.html:depositi']=new Array;
query['listeVarie.html:depositi']['OFFSET']=0;
query['listeVarie.html:depositi']['FETCH']=100;
query['listeVarie.html:depositi']['MAXFETCH']=0;
query['listeVarie.html:depositi']['COUNT']="id";
query['listeVarie.html:depositi']['textBoxRicerca']="txtRicercaCliente";
query['listeVarie.html:depositi']['numeroModello']=1;
query['listeVarie.html:depositi']['modello1Riga']=elementiListeVarieDescrizione;
query['listeVarie.html:depositi']['title']="Depositi";

// Aspetto beni
query['listeVarie.html:aspettoBeni']=new Array;
query['listeVarie.html:aspettoBeni']['OFFSET']=0;
query['listeVarie.html:aspettoBeni']['FETCH']=100;
query['listeVarie.html:aspettoBeni']['MAXFETCH']=0;
query['listeVarie.html:aspettoBeni']['COUNT']="id";
query['listeVarie.html:aspettoBeni']['textBoxRicerca']="txtRicercaCliente";
query['listeVarie.html:aspettoBeni']['numeroModello']=1;
query['listeVarie.html:aspettoBeni']['modello1Riga']=elementiListeVarieDescrizione;
query['listeVarie.html:aspettoBeni']['title']="aspettoBeni";

// Causali Trasporti
query['listeVarie.html:causaliTrasporto']=new Array;
query['listeVarie.html:causaliTrasporto']['OFFSET']=0;
query['listeVarie.html:causaliTrasporto']['FETCH']=100;
query['listeVarie.html:causaliTrasporto']['MAXFETCH']=0;
query['listeVarie.html:causaliTrasporto']['COUNT']="id";
query['listeVarie.html:causaliTrasporto']['textBoxRicerca']="txtRicercaCliente";
query['listeVarie.html:causaliTrasporto']['numeroModello']=1;
query['listeVarie.html:causaliTrasporto']['modello1Riga']=elementiListeVarieDescrizione;
query['listeVarie.html:causaliTrasporto']['title']="causaliTrasporto";

// Note Aggiuntive
query['listeVarie.html:noteAggiuntive']=new Array;
query['listeVarie.html:noteAggiuntive']['OFFSET']=0;
query['listeVarie.html:noteAggiuntive']['FETCH']=100;
query['listeVarie.html:noteAggiuntive']['MAXFETCH']=0;
query['listeVarie.html:noteAggiuntive']['COUNT']="id";
query['listeVarie.html:noteAggiuntive']['textBoxRicerca']="txtRicercaCliente";
query['listeVarie.html:noteAggiuntive']['numeroModello']=1;
query['listeVarie.html:noteAggiuntive']['modello1Riga']=elementiListeVarieDescrizione;
query['listeVarie.html:noteAggiuntive']['title']="noteAggiuntive";

// Assortimenti Articoli
query['listeVarie.html:assortimentiArticoli']=new Array;
query['listeVarie.html:assortimentiArticoli']['OFFSET']=0;
query['listeVarie.html:assortimentiArticoli']['FETCH']=100;
query['listeVarie.html:assortimentiArticoli']['MAXFETCH']=0;
query['listeVarie.html:assortimentiArticoli']['COUNT']="id";
query['listeVarie.html:assortimentiArticoli']['textBoxRicerca']="txtRicercaCliente";
query['listeVarie.html:assortimentiArticoli']['numeroModello']=1;
query['listeVarie.html:assortimentiArticoli']['modello1Riga']=elementiListeVarieDescrizione;
query['listeVarie.html:assortimentiArticoli']['title']="assortimentiArticoli";

// Contratti
query['listeVarie.html:contratti']=new Array;
query['listeVarie.html:contratti']['OFFSET']=0;
query['listeVarie.html:contratti']['FETCH']=100;
query['listeVarie.html:contratti']['MAXFETCH']=0;
query['listeVarie.html:contratti']['COUNT']="id";
query['listeVarie.html:contratti']['textBoxRicerca']="txtRicercaCliente";
query['listeVarie.html:contratti']['numeroModello']=0;
query['listeVarie.html:contratti']['modelloRiga']=elementiListeVarieContratti;
query['listeVarie.html:contratti']['title']="Contratti di Vendita";

query['listeVarie.html:contratti']['oggetti']=new Array;
query['listeVarie.html:contratti']['oggetti']['{ID}']="id";
query['listeVarie.html:contratti']['oggetti']['{descrizione1}']="d1";
query['listeVarie.html:contratti']['oggetti']['{DADATA}']="DADATA";
query['listeVarie.html:contratti']['oggetti']['{ADATA}']="ADATA";

// Contratti B2B
query['listeVarie.html:ContrattiB2B']=new Array;
query['listeVarie.html:ContrattiB2B']['OFFSET']=0;
query['listeVarie.html:ContrattiB2B']['FETCH']=100;
query['listeVarie.html:ContrattiB2B']['MAXFETCH']=0;
query['listeVarie.html:ContrattiB2B']['COUNT']="id";
query['listeVarie.html:ContrattiB2B']['textBoxRicerca']="txtRicercaCliente";
query['listeVarie.html:ContrattiB2B']['numeroModello']=0;
query['listeVarie.html:ContrattiB2B']['modelloRiga']=elementiListeVarieContrattiB2B;
query['listeVarie.html:ContrattiB2B']['title']="Contratti di Vendita B2B";
query['listeVarie.html:ContrattiB2B']['oggetti']=new Array;
query['listeVarie.html:ContrattiB2B']['oggetti']['{ID}']="id";
query['listeVarie.html:ContrattiB2B']['oggetti']['{descrizione1}']="d1";
query['listeVarie.html:ContrattiB2B']['oggetti']['{DATADA}']="DATADA";
query['listeVarie.html:ContrattiB2B']['oggetti']['{DATAA}']="DATAA";

var parametriNC={};
var ricerca="";

var nomeTabella=recuperaParametroHRef("","tabella");
var av=recuperaParametroHRef("","av");

var nomePaginaTabella=nomePagina+":"+nomeTabella;
const titleList = query[nomePaginaTabella]['title'];

window.addEventListener("load", function(event) {
    setTitle();
    setHintButtonAdd();
    recuperaParametri();
});

function setTitle() {
    const el = document.getElementById("titleList");
    el.innerHTML = titleList;
}

function setHintButtonAdd() {
    const el = document.getElementById("cmdNuovoUtente");
    el.setAttribute("title", `Nuovo ${titleList}`);
}

function recuperaParametri(){
    var parametri={"tipoRisposta":"parametri","chiamante":"parametri","nomePagina":nomePaginaTabella, "userName":""}; 
    inviaRichiestaCentralino("parametri",parametri,elaboraParametri);
}

function elaboraParametri(res){
    var risp=JSON.parse(res);
    var parametri=risp.parametri;
    var data=risp.risposta;

    if (risp.error!=''){
        return "";
    }

    for (x in data){
        if (!isNaN(Number(data[x]["valore"]))){
            parametriNC[data[x]["parametro"]]=Number(data[x]["valore"]);
        } else {
            parametriNC[data[x]["parametro"]]=data[x]["valore"];
        }  
    }
    
    carDatiListaClienti();
}

function elencoClientiScroll(ec, pagina, txtRicerca="") {
    var scrollPos = ec.scrollTop;
    var maxScroll = ec.scrollHeight - ec.clientHeight;
    
    window.sessionStorage.setItem(nomePagina+".elenco"+tipoAnagrafica+".scroolTop",scrollPos);

    if (maxScroll-scrollPos<(maxScroll/100) && elencoInCaricamento==0) {
        AvviaCarDatiElencoClienti("elencoClienti","",false);
    }
}

var timer1;

function txtRicercaChange(input,ulID,sottoQuery,righe) {
    if (timer1) {
        clearTimeout(timer1);
    }
    timer1=setTimeout(function() { 
        xRag="";
        
        ricerca=input.value;

        AvviaCarDatiElencoClienti("elencoClienti")

        clearTimeout(timer1); 
        
        inputID=input.getAttribute("id");

        salvaFiltro(inputID,tipoAnagrafica);
    }, 1000);
}

function AvviaCarDatiElencoClienti(tipoRisposta,sottoQuery="",ricarica=true,righe=2,scrollTop=0){
    var nomeQuery=new String (nomePaginaTabella);
    
    if (sottoQuery!=''){
        nomeQuery+=":"+sottoQuery;
    }

    var maxFetch=0;
    
    if (query[nomeQuery]['MAXFETCH']){
        maxFetch=query[nomeQuery]['MAXFETCH'];
    }

    if (ricarica){
        maxFetch=0;
    }

    if (query[nomeQuery]['OFFSET']>=maxFetch && maxFetch!=0) {
        return '';
    }

    if (ricarica){
        query[nomeQuery]['OFFSET']=0;
    }

    // parametro 'righe' obsoleto 
    // il tipoElenco adesso lo recupera dall'array della tabella
    let tipoElenco = 2;
    if (query[nomeQuery]['numeroModello']>=0) {
        tipoElenco = parseInt(query[nomeQuery]['numeroModello']);
    }

    var parametri={"tipoQuery":"listeVarie","tipoRisposta":tipoRisposta,"nomeQuery":nomeQuery,"ricerca":ricerca, "tipoElenco":tipoElenco, 
        "ricarica":ricarica, "scrollTop":scrollTop,"offSet":query[nomeQuery]['OFFSET'],"fetch":query[nomeQuery]['FETCH'],"chiamante":tipoRisposta, "av":av
        }; 

    var nomeSession=nomeSessionJson(parametri);

    var md5=sessionStorage.getItem(nomeSession+".md5");
    if (md5!=undefined){
        parametri.md5=md5;
    }

    elencoInCaricamento=1;

    inviaRichiestaCentralino("query",parametri);
}

function elaboraRisposta(res){
    var risp=JSON.parse(res);
    var parametri=risp.parametri;
    var data=risp.risposta;

    if (risp.error!=''){
        return "";
    }

    var nomeSession=nomeSessionJson(parametri);
    var nomeOS=nomeSessionOffSet(parametri);

    if (parametri.md5==risp.md5){
        data=JSON.parse(sessionStorage.getItem(nomeSession+".jSon"));
    } else {
        sessionStorage.setItem(nomeSession+".md5",risp.md5);
        sessionStorage.setItem(nomeSession+".jSon",JSON.stringify(data));
    }

    if (parametri.tipoRisposta=="elencoClienti"){
        sessionStorage.setItem(nomeOS+".offSet",parametri.offSet);
        query[nomePaginaTabella]['OFFSET']+=query[nomePaginaTabella]['FETCH'];
    }

    popolaElencoDaJson(data,parametri.tipoRisposta,parametri.tipoElenco,parametri.nomeQuery,parametri.ricarica,parametri.scrollTop);

    elencoInCaricamento=0;
}

function nomeSessionJson(parametri){
    return nomePaginaTabella+"."+parametri.tipoRisposta+"."+parametri.ricerca+"."+parametri.offSet;
}

function nomeSessionOffSet(parametri){
    return nomePaginaTabella+"."+parametri.tipoRisposta+"."+parametri.ricerca;
}

function carDatiListaClienti() {    
    ricerca="";
    
    var filter=window.sessionStorage.getItem(nomePagina+"."+nomeTabella+".filter");
    var scroolTop=window.sessionStorage.getItem(nomePagina+".elenco"+nomeTabella+".scroolTop");

    if (filter) {
        ricerca=filter;
        var txtRicerca=document.getElementById("txtRicercaCliente");
        txtRicerca.setAttribute("value",filter);
    }

    var tipoRisposta="elencoClienti";
    var parametri={"tipoQuery":"listeVarie","tipoRisposta":tipoRisposta,"ricerca":ricerca,"nomeQuery":nomePaginaTabella,
        "scrollTop":scroolTop,"chiamante":tipoRisposta, "tipoElenco":2, "av":av
        }; 


    var nomeOS=nomeSessionOffSet(parametri);
    os=sessionStorage.getItem(nomeOS+".offSet");

    if (os>0){
        while (query[nomePagina]['OFFSET']<=os){
            parametri.offSet=query[nomePaginaTabella]['OFFSET'];
            var nomeSession=nomeSessionJson(parametri);
            parametri.ricarica=(query[nomePaginaTabella]['OFFSET']==0);

            data=JSON.parse(sessionStorage.getItem(nomeSession+".jSon"));

            query[nomePaginaTabella]['OFFSET']+=query[nomePaginaTabella]['FETCH'];

            popolaElencoDaJson(data,parametri.tipoRisposta,parametri.tipoElenco,parametri.nomeQuery,parametri.ricarica,parametri.scrollTop); 
        }

        if (scroolTop>0) {
            var ulCliente=document.getElementById("elencoClienti");
            ulCliente.scrollTop=scroolTop;
        }
    } else {
        let tipoElenco = +query[nomePaginaTabella]['numeroModello']
        // AvviaCarDatiElencoClienti("elencoClienti","",(scroolTop>0),2,scroolTop);
        AvviaCarDatiElencoClienti("elencoClienti","",(scroolTop>0),tipoElenco,scroolTop);        
    }
}

function apriSchedaCliente(e,idCli,ragSoc){
    if (idCli!=''){
        var parametri={"tipoQuery":"listeVarie","tipoRisposta":"scheda","nomeQuery":nomePagina+":scheda"+nomeTabella,"id":idCli,"chiamante":"scheda","offSet":0,"fetch":0,"ricerca":''}; 

        elencoInCaricamento=1;

        inviaRichiestaCentralino("query",parametri,elaboraApriScheda);
    } else {
        sessionStorage.removeItem("skVarie."+nomeTabella);
        if(typeof modElectron!='undefined' && modElectron==true){
            location.href="nuovo"+nomeTabella+".html";
        }else{
            window.open("nuovo"+nomeTabella+".html","_self");
        }
        
    }
}
/*eliminazione record da lista */
function eliminaSchedaCliente(e,idCli,descrRecord='') {
    if (idCli!=''){
        attivaAlert(5,"<div><div>Sei sicuro di voler eliminare questo record?</div><div><u>"+(descrRecord!='' ? descrRecord:'')+"</u></div></div>","rispEliminaListeVarie_"+idCli);        
    }
}

function rispEliminaListeVarie(risp, id) {
    if (risp=="Si") {
        avviaEliminaListeVarie(id);
    } else {
        chiudiModalAlert("rispEliminaListeVarie."+id);
    }
}

function avviaEliminaListeVarie(id) {
    const parametri={"tipoRisposta":"elimina", "tipoElimina":nomeTabella, "dati":id};
    inviaRichiestaCentralino("elimina", parametri, elaboraEliminaListeVarie);
}

function elaboraEliminaListeVarie(res){
    var risp=JSON.parse(res);
    var parametri=risp.parametri;
    var data=risp.risposta;

    if (risp.error!=''){
        return "";
    }
    
    if(data[0]==0){
        attivaAlert(0,"Errore durante l'eliminazione del record'","fineElimina");
        return "";
    }

    AvviaCarDatiElencoClienti("elencoClienti","",true);
}

function elaboraApriScheda(res){
    var risp=JSON.parse(res);
    var parametri=risp.parametri;
    var data=risp.risposta;

    if (risp.error!=''){
        return "";
    }

    if (data[0]==0){
        return;
    }

    sessionStorage.setItem("skVarie."+nomeTabella,JSON.stringify(data));

    if (av==""){
        if(typeof modElectron!='undefined' && modElectron==true){
            location.href="nuovo"+nomeTabella+".html";
        }else{
            window.open("nuovo"+nomeTabella+".html","_self");
        }
        
    } else {
        if(typeof modElectron!='undefined' && modElectron==true){
            location.href="nuovo"+nomeTabella+".html?av="+av;
        }else{
        window.open("nuovo"+nomeTabella+".html?av="+av,"_self");
        }
    }
    
}

function clickBack(){
    if (xTarget=="_blank") {
        window.close();
    } else {
        open ("mainPage.html",xTarget);
    }
}

function mailReset(userName){
    sessionStorage.setItem("utenteAttiva",userName);
    if(typeof modElectron!='undefined' && modElectron==true){
        location.href="passwordDimenticata.html";
    }else{
        window.open("passwordDimenticata.html","_self");
    }
    
}