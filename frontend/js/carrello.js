query['carrello.js']=new Array;
query['carrello.js']['oggetti']=new Array;
query['carrello.js']['imgOffLine']={"precodice":"imgC.","campoCodice":"codice","campoImmagine":"imgSrc"};

query['carrello.js']['oggetti']['{codice}']="codice";
query['carrello.js']['oggetti']['{descrizione}']="descrizione";
query['carrello.js']['oggetti']['{imgSrc}']="imgSrc";
query['carrello.js']['oggetti']['{um}']="um";
query['carrello.js']['oggetti']['{qu}']={campo:"qu", decimaliMax:5, decimaliMin:0};
query['carrello.js']['oggetti']['{listino}']={campo:"listino", decimaliMax:5, decimaliMin:2, noZero:1};
query['carrello.js']['oggetti']['{przListinoRif}']={campo:"przListinoRif", decimaliMax:5, decimaliMin:2, noZero:1};
query['carrello.js']['oggetti']['{scontiListinoRif}']="scontiListinoRif";
query['carrello.js']['oggetti']['{prezzo}']={campo:"prezzo", decimaliMax:5, decimaliMin:2};
query['carrello.js']['oggetti']['{sconti}']="sconti";
query['carrello.js']['oggetti']['{importo}']={campo:"importo", decimaliMax:2, decimaliMin:2};
query['carrello.js']['oggetti']['{notaPrelievo}']="notaPrelievo";
query['carrello.js']['oggetti']['{notaUfficio}']="notaUfficio";
query['carrello.js']['oggetti']['{srcDisp}']="srcDisp";
query['carrello.js']['oggetti']['{srcRicarico}']="srcRicarico";
query['carrello.js']['oggetti']['{ricarico}']={campo:"ricarico", decimaliMax:2, decimaliMin:0};
query['carrello.js']['oggetti']['{disp}']={campo:"disp", decimaliMax:3, decimaliMin:0};
query['carrello.js']['oggetti']['{costo}']={campo:"costo", decimaliMax:2, decimaliMin:2};
query['carrello.js']['oggetti']['{ordinato}']={campo:"ordinato", decimaliMax:3, decimaliMin:0};
query['carrello.js']['oggetti']['{quUnitaria}']={campo:"quUnitaria", decimaliMax:3, decimaliMin:0};
query['carrello.js']['oggetti']['{percIva}']={campo:"percIva", decimaliMax:2, decimaliMin:0};
query['carrello.js']['oggetti']['{hideDisp}']="hideDisp";
query['carrello.js']['oggetti']['{hideNoDisp}']="hideNoDisp";
query['carrello.js']['oggetti']['{hideQu}']="hideQu";
query['carrello.js']['oggetti']['{hideDesReso}']="hideDesReso";
query['carrello.js']['oggetti']['{visQuReso}']={campo:"visQuReso", decimaliMax:0, decimaliMin:0};;
query['carrello.js']['oggetti']['{quReso}']={campo:"quReso", decimaliMax:3, decimaliMin:0};
query['carrello.js']['oggetti']['{visQuOmaggio}']={campo:"visQuOmaggio", decimaliMax:0, decimaliMin:0};;
query['carrello.js']['oggetti']['{quOmaggio}']={campo:"quOmaggio", decimaliMax:3, decimaliMin:0};
query['carrello.js']['oggetti']['{hideDesOmaggio}']="hideDesOmaggio";
query['carrello.js']['oggetti']['{percentualeProvvigione}']={campo:"percentualeProvvigione", decimaliMax:2, decimaliMin:0};
query['carrello.js']['oggetti']['{importoProvvigione}']={campo:"importoProvvigione", decimaliMax:2, decimaliMin:2};

query['carrello.js:indispensabili']=new Array;

query['carrello.js:indispensabili']['imgOffLine']={"precodice":"imgI.","campoCodice":"codice","campoImmagine":"imgSrc"};
query['carrello.js:indispensabili']['oggetti']=new Array;
query['carrello.js:indispensabili']['oggetti']['{codice}']="codice";
query['carrello.js:indispensabili']['oggetti']['{descrizione}']="descrizione";
query['carrello.js:indispensabili']['oggetti']['{imgSrc}']="imgSrc";
query['carrello.js:indispensabili']['oggetti']['{um}']="um";
query['carrello.js:indispensabili']['oggetti']['{qu}']={campo:"qu", decimaliMax:5, decimaliMin:0};
query['carrello.js:indispensabili']['oggetti']['{listino}']={campo:"listino", decimaliMax:5, decimaliMin:2, noZero:1};
query['carrello.js:indispensabili']['oggetti']['{prezzo}']={campo:"prezzo", decimaliMax:5, decimaliMin:2};
query['carrello.js:indispensabili']['oggetti']['{sconti}']="sconti";
query['carrello.js:indispensabili']['oggetti']['{importo}']={campo:"importo", decimaliMax:5, decimaliMin:2};
query['carrello.js:indispensabili']['oggetti']['{notaPrelievo}']="notaPrelievo";
query['carrello.js:indispensabili']['oggetti']['{notaUfficio}']="notaUfficio";
query['carrello.js:indispensabili']['oggetti']['{srcDisp}']="srcDisp";
query['carrello.js:indispensabili']['oggetti']['{srcRicarico}']="srcRicarico";
query['carrello.js:indispensabili']['oggetti']['{ricarico}']={campo:"ricarico", decimaliMax:2, decimaliMin:0};
query['carrello.js:indispensabili']['oggetti']['{disp}']={campo:"disp", decimaliMax:3, decimaliMin:0};
query['carrello.js:indispensabili']['oggetti']['{costo}']={campo:"costo", decimaliMax:2, decimaliMin:2};
query['carrello.js:indispensabili']['oggetti']['{ordinato}']={campo:"ordinato", decimaliMax:3, decimaliMin:0};
query['carrello.js:indispensabili']['oggetti']['{quUnitaria}']={campo:"quUnitaria", decimaliMax:3, decimaliMin:0};
query['carrello.js:indispensabili']['oggetti']['{percIva}']={campo:"percIva", decimaliMax:2, decimaliMin:0};
query['carrello.js:indispensabili']['oggetti']['{hideDisp}']="hideDisp";
query['carrello.js:indispensabili']['oggetti']['{hideNoDisp}']="hideNoDisp";
query['carrello.js:indispensabili']['oggetti']['{hideQu}']="hideQu";

query['carrello.js:prenotati']=new Array;

query['carrello.js:prenotati']['imgOffLine']={"precodice":"imgI.","campoCodice":"codice","campoImmagine":"imgSrc"};
query['carrello.js:prenotati']['oggetti']=new Array;
query['carrello.js:prenotati']['oggetti']['{codice}']="codice";
query['carrello.js:prenotati']['oggetti']['{descrizione}']="descrizione";
query['carrello.js:prenotati']['oggetti']['{imgSrc}']="imgSrc";
query['carrello.js:prenotati']['oggetti']['{um}']="um";
query['carrello.js:prenotati']['oggetti']['{qu}']={campo:"qu", decimaliMax:5, decimaliMin:0};
query['carrello.js:prenotati']['oggetti']['{listino}']={campo:"listino", decimaliMax:5, decimaliMin:2, noZero:1};
query['carrello.js:prenotati']['oggetti']['{prezzo}']={campo:"prezzo", decimaliMax:5, decimaliMin:2};
query['carrello.js:prenotati']['oggetti']['{sconti}']="sconti";
query['carrello.js:prenotati']['oggetti']['{importo}']={campo:"importo", decimaliMax:5, decimaliMin:2};
query['carrello.js:prenotati']['oggetti']['{notaPrelievo}']="notaPrelievo";
query['carrello.js:prenotati']['oggetti']['{notaUfficio}']="notaUfficio";
query['carrello.js:prenotati']['oggetti']['{srcDisp}']="srcDisp";
query['carrello.js:prenotati']['oggetti']['{srcRicarico}']="srcRicarico";
query['carrello.js:prenotati']['oggetti']['{ricarico}']={campo:"ricarico", decimaliMax:2, decimaliMin:0};
query['carrello.js:prenotati']['oggetti']['{disp}']={campo:"disp", decimaliMax:3, decimaliMin:0};
query['carrello.js:prenotati']['oggetti']['{costo}']={campo:"costo", decimaliMax:2, decimaliMin:2};
query['carrello.js:prenotati']['oggetti']['{ordinato}']={campo:"ordinato", decimaliMax:3, decimaliMin:0};
query['carrello.js:prenotati']['oggetti']['{quUnitaria}']={campo:"quUnitaria", decimaliMax:3, decimaliMin:0};
query['carrello.js:prenotati']['oggetti']['{percIva}']={campo:"percIva", decimaliMax:2, decimaliMin:0};
query['carrello.js:prenotati']['oggetti']['{hideDisp}']="hideDisp";
query['carrello.js:prenotati']['oggetti']['{hideNoDisp}']="hideNoDisp";
query['carrello.js:prenotati']['oggetti']['{hideQu}']="hideQu";

query['schedaCliente.html:destinazioni']=new Array;
query['schedaCliente.html:destinazioni']['modelloRiga']=elementiDestinazioni;
query['schedaCliente.html:destinazioni']['modelloContenitore']=modalRubrica;

query['schedaCliente.html:destinazioni']['oggetti']=new Array;
query['schedaCliente.html:destinazioni']['oggetti']['{ID}']="ID";
query['schedaCliente.html:destinazioni']['oggetti']['{RAGIONE_SOCIALE}']="RAGIONE_SOCIALE";
query['schedaCliente.html:destinazioni']['oggetti']['{TEL}']="TEL";
query['schedaCliente.html:destinazioni']['oggetti']['{HIDETEL}']="HIDETEL";
query['schedaCliente.html:destinazioni']['oggetti']['{FAX}']="FAX";
query['schedaCliente.html:destinazioni']['oggetti']['{HIDEFAX}']="HIDEFAX";
query['schedaCliente.html:destinazioni']['oggetti']['{INDIRIZZO}']="INDIRIZZO";
query['schedaCliente.html:destinazioni']['oggetti']['{LOCALITA}']="LOCALITA";
query['schedaCliente.html:destinazioni']['oggetti']['{LOCALITAPULITA}']="LOCALITAPULITA";
query['schedaCliente.html:destinazioni']['oggetti']['{CAP}']="CAP";
query['schedaCliente.html:destinazioni']['oggetti']['{PROV}']="PROV";
query['schedaCliente.html:destinazioni']['oggetti']['{MAP}']="MAP";
query['schedaCliente.html:destinazioni']['oggetti']['{HIDELOC}']="HIDELOC";
query['schedaCliente.html:destinazioni']['oggetti']['{DESPAGAMENTO}']="DESPAGAMENTO";
query['schedaCliente.html:destinazioni']['oggetti']['{DESVETTORE}']="DESVETTORE";
query['schedaCliente.html:destinazioni']['oggetti']['{DESAGENTE}']="DESAGENTE";
query['schedaCliente.html:destinazioni']['oggetti']['{CONTATTOD}']="CONTATTOD";
query['schedaCliente.html:destinazioni']['oggetti']['{DESDEPOSITO}']="DESDEPOSITO";
query['schedaCliente.html:destinazioni']['oggetti']['{NOTED}']="NOTED";
query['schedaCliente.html:destinazioni']['oggetti']['{EMAILD}']="EMAILD";
query['schedaCliente.html:destinazioni']['oggetti']['{HIDEEMAIL}']="HIDEEMAIL";
query['schedaCliente.html:destinazioni']['oggetti']['{PECD}']="PECD";
query['schedaCliente.html:destinazioni']['oggetti']['{SDI_DEST}']="SDI_DEST";
query['schedaCliente.html:destinazioni']['oggetti']['{NAZIONED}']="NAZIONED";
query['schedaCliente.html:destinazioni']['oggetti']['{PAGAMENTOD}']="PAGAMENTOD";
query['schedaCliente.html:destinazioni']['oggetti']['{VETTORED}']="VETTORED";
query['schedaCliente.html:destinazioni']['oggetti']['{AGENTED}']="AGENTED";
query['schedaCliente.html:destinazioni']['oggetti']['{DEPOSITOD}']="IDDEPOSITOD";
query['schedaCliente.html:destinazioni']['oggetti']['{PREDEFINITA}']="PREDEFINITA";
query['schedaCliente.html:destinazioni']['oggetti']['{DESPREDEFINITA}']="DESPREDEFINITA";
query['schedaCliente.html:destinazioni']['oggetti']['{DESLISTINO}']="DESLISTINO";
query['schedaCliente.html:destinazioni']['oggetti']['{LISTINODEST}']="LISTINODEST";

var idServer=sessionStorage.getItem("s");
var versioneCarrello="6";
var jSonScala=undefined;
var mandante=0;
var idDeposito=0;
var idPagamentoD=0;
var dPagamentoD="";
var idAgenteD=0;
var idVettoreD=0;
var idRaggruppamentoD=0;
var costiTrasporto="";
var listinoDest=0;
var costiTrasportoB2B="";
var scontiB2B="";

var skCli;

var nomeCarrello="";
var carrelloJson;

var totale=0;
var costo=0;
var idTes=0;
var rsProvviggioniAgente;
var rsContrattiB2B;

var campoFamigliaTrainante="grMerc";
var famigliaTrainante=0;
var quMinima=0;

function caricaCarrello(){
    skCli=JSON.parse(sessionStorage.getItem("schedaCliente.html.CLIENTE."+idCliente+".jSon"));

    try {
        if (skCli[0].IDDEPOSITO!=undefined){
            idDeposito=skCli[0].IDDEPOSITO;
        }        
    } catch (error) {
        
    }

    xNomeDestinazione = "nDestinazione."+idServer+"."+tipoAnagrafica+"."+idCliente;

    cIdDest=localStorage.getItem(xNomeDestinazione);    
    if (cIdDest==undefined){
        cIdDest=0;
    } else {
        cIdDest=JSON.parse(cIdDest);

        if (cIdDest.deposito!=undefined){
            if (cIdDest.deposito>0){
                idDeposito=cIdDest.deposito;
            }
        }

        try {
            idPagamentoD=cIdDest.pagamento;
            dPagamentoD=cIdDest.dPagamento;
            idVettoreD=cIdDest.vettore;
            idAgenteD=cIdDest.agente;
            
            if (cIdDest.RAGGRUPPAMENTOD!=undefined){
                idRaggruppamentoD=cIdDest.RAGGRUPPAMENTOD;    
            }
        } catch (error) {
            
        }

        listinoDest=0;

        if (cIdDest.listinoDest!=undefined) {
            if (cIdDest.listinoDest>0) {
                listinoDest=cIdDest.listinoDest;
                document.getElementById("cmdDest").style.display="none";
                document.getElementById("cmdDestP").style.display="none";
            }
        }

        cIdDest=cIdDest.idDest;
    }

    totale=0;
    costo=0;

    if (filtroApertura==parametriArticoli.codiceCatalogo){
        nomeCarrello = "carrello."+parametriArticoli.codiceCatalogo;
        
        inizializzaCarrelloJson();
    } else{
        idTes=sessionStorage.getItem("carrelloDaAprire");    
        if (idTes!=undefined){
            nomeCarrello = "carrello."+idTes;
            carrelloJson=sessionStorage.getItem(nomeCarrello);

            inizializzaCarrelloJson();
        } else {
            apriModificaPreOrdine();
        }
    }
    
    // inizializzaDatiDestinazione();

    try {
        if (skCli[0].NOPROMO==1){
            document.getElementById("liINPROMO").style.display="none";
            document.getElementById("liINPROMOSCALA").style.display="none";
        }
        if (skCli[0].NONETTI==1){
            document.getElementById("liSCALA").style.display="none";
            document.getElementById("liINPROMOSCALA").style.display="none";
        }
        if (skCli[0].NOATTRIBUTIAPP==1){
            document.getElementById("liINPROMO").style.display="none";
            document.getElementById("liSCALA").style.display="none";
            document.getElementById("liINPROMOSCALA").style.display="none";
        }
    } catch (error) {
        
    }

    if (xOffLine!="true" && skCli!=undefined){
        avviaCarDatiContrattiB2B();
    }
}

function avviaCarDatiContrattiB2B(){
    var idFamCli=skCli[0].RAGGRUPPAMENTO;

    if (idRaggruppamentoD>0){
        idFamCli=idRaggruppamentoD;
    }

    var parametri={"tipoRisposta":"rec","tipoQuery":"querySpecifica","nomeTabella":"contrattoB2B", "idClienteB2B":skCli[0].ID, "idAgenteB2B":skCli[0].COD_AGENTE, "idRaggruppamentoB2B":idFamCli};
    inviaRichiestaCentralino("query",parametri,elaboraRispostaCarDatiContrattiB2B);
}

function elaboraRispostaCarDatiContrattiB2B(res){
    var risp=JSON.parse(res);
    var parametri=risp.parametri;
    var data=risp.risposta;

    if (risp.error!=''){
        return "";
    }

    if(data[0]===0){
        return "";
    }
    
    rsContrattiB2B=data;

    if (rsContrattiB2B[0].UM=='UM'){
        parametriArticoli.NoQuConfezione=1;
    }

    switch (rsContrattiB2B[0].LIVELLOFAMIGLIA) {
        case '-1':
            campoFamigliaTrainante="grMerc";
            break;
        case '0':
            campoFamigliaTrainante="sGrMerc";
            break;
        case '1':
            campoFamigliaTrainante="sFam1";
            break;
        case '2':
            campoFamigliaTrainante="sFam2";
            break;
    }

    famigliaTrainante=rsContrattiB2B[0].IDFAMIGLIA;
    quMinima=rsContrattiB2B[0].QUMIN;
    costiTrasportoB2B=[];
    scontiB2B=[];

    var i=0;
    var s=0;

    for (x in rsContrattiB2B){
        if (rsContrattiB2B[x].TIPO==2){
            costiTrasportoB2B[i]=rsContrattiB2B[x];
            i+=1;
        } else if (rsContrattiB2B[x].TIPO==1){
            scontiB2B[s]=rsContrattiB2B[x];
            s+=1;
        }
    }

    ricalcolaTotali();
}

function inizializzaDatiDestinazione () {
    if (carrelloJson.testata!=undefined){
        if (carrelloJson.testata.destinazioni!=undefined){
            if (carrelloJson.testata.destinazioni.idDest!=0){
                cIdDest=carrelloJson.testata.destinazioni.idDest;
                idPagamentoD=carrelloJson.testata.destinazioni.pagamento;
                dPagamentoD=carrelloJson.testata.destinazioni.dPagamento;
                idVettoreD=carrelloJson.testata.destinazioni.vettore;
                idAgenteD=carrelloJson.testata.destinazioni.agente; 
                idDeposito=carrelloJson.testata.destinazioni.deposito;

                if (carrelloJson.testata.destinazioni.listinoDest!=undefined) {
                    if (carrelloJson.testata.destinazioni.listinoDest>0) {
                        document.getElementById("cmdDest").style.display="none";
                        document.getElementById("cmdDestP").style.display="none";
                    }
                }
                return;
            } 
        } 
    } 

    xNomeDestinazione = "nDestinazione."+idServer+"."+tipoAnagrafica+"."+idCliente;

    cIdDest=localStorage.getItem(xNomeDestinazione);    
    if (cIdDest==undefined){
        cIdDest=0;
    } else {
        cIdDest=JSON.parse(cIdDest);

        if (cIdDest.deposito!=undefined){
            idDeposito=cIdDest.deposito;
        }

        try {
            idPagamentoD=cIdDest.pagamento;
            dPagamentoD=cIdDest.dPagamento;
            idVettoreD=cIdDest.vettore;
            idAgenteD=cIdDest.agente;    
        } catch (error) {
            
        }

        if (cIdDest.listinoDest!=undefined) {
            if (cIdDest.listinoDest>0) {
                document.getElementById("cmdDest").style.display="none";
                document.getElementById("cmdDestP").style.display="none";
            }
        }

        cIdDest=cIdDest.idDest;
    }
}

function carrelloToStorage(){
    if (idTes!=undefined){
        sessionStorage.setItem(nomeCarrello, _toJSONString(carrelloJson));
    } else {
        localStorage.setItem(nomeCarrello, _toJSONString(carrelloJson));
    }
}

function inizializzaCarrelloJson(){
    if (carrelloJson == null ) {
        carrelloJson = {};
        
        carrelloJson.prodotti ={index:{}, data:[]};
    
        carrelloJson.totali={totale:0, tCosto:0, tCostoEvadibile:0, tQu:0, tQuEvadibile:0, tRighe:0, tRigheEvadibili:0, totEvadibile:0, tIva:0, tDoc:0, 
            tIvaEvadibile:0, tDocEvadibile:0, totaleMerce:0, nettoMerce:0, scCassa:0, trasporto:0, spese:0, castellettoIva:[],totaliProvvigioniAgente:0, tQuTrainante:0};
    
        carrelloToStorage();
        
        var oldVerCarrello=localStorage.getItem("versioneCarrello."+idServer+"."+tipoAnagrafica+"."+idCliente);
        
        if (oldVerCarrello!=versioneCarrello || oldVerCarrello==null){
            //funzione per aggiornamento carrello a versione corrente
    
            localStorage.setItem("versioneCarrello."+idServer+"."+tipoAnagrafica+"."+idCliente,versioneCarrello);
        }  
    } else {
        carrelloJson=JSON.parse(carrelloJson);
    }    
}

function aggiornaLabelOrdinato(codice,tQu,quReso=0,quOmaggio=0){
    try {
        var label=document.getElementById("lblQu"+codice);   
    
        if (tQu<=0 && quReso==0 && quOmaggio==0){
            label.innerHTML="";
            label.style.visibility="hidden";
        } else {
            label.innerHTML=arrotonda(tQu,3);
            if (quReso>0){
                label.innerHTML+='+'+quReso;
            }
            if (quOmaggio>0){
                label.innerHTML+='+'+quOmaggio;
            }
            label.style.visibility="visible"; 
        }

        var minus=document.getElementById("cmdM"+codice);
        var liCar=document.getElementById("car."+codice);

        if (tQu>0 || quReso>0 || quOmaggio>0){
            minus.style.visibility="visible";
        } else {
            minus.style.visibility="hidden";

            if (liCar!=undefined){
                liCar.parentNode.removeChild(liCar);
            }
        }
    } catch (error){

    }
}

function aggiornaTotaliCarrello(){
    try {
        var totali=carrelloJson.totali;
        
        valorizzaHTMLElemento("divTotaleC","€ "+formatter.format(totali.nettoMerce));
        valorizzaHTMLElemento("divCOTotImp","€ "+formatter.format(totali.totale));
        valorizzaHTMLElemento("divTotaleIvaC","Iva € "+formatter.format(totali.tIva));
        valorizzaHTMLElemento("divCOTotIva","€ "+formatter.format(totali.tIva));
        valorizzaHTMLElemento("divCOTotDoc","€ "+formatter.format(totali.tDoc));
        valorizzaHTMLElemento("divTotaleDocC","€ "+formatter.format(totali.tDoc));
        valorizzaHTMLElemento("divTotaleIvaEvC","€ "+formatter.format(totali.tIvaEvadibile));
        valorizzaHTMLElemento("divTotaleDocEvC","€ "+formatter.format(totali.tDocEvadibile));
        valorizzaHTMLElemento("divTotEvadibileC","€ "+formatter.format(totali.totEvadibile));
        valorizzaHTMLElemento("divRigheC","#"+formattaNumeri(totali.tRighe,0,0));
        valorizzaHTMLElemento("divRigheEvadibileC","#"+formattaNumeri(totali.tRigheEvadibili,2,0));
        valorizzaHTMLElemento("divQuC",formattaNumeri(totali.tQu,3,0));
        valorizzaHTMLElemento("divQuEvadibileC",formattaNumeri(totali.tQuEvadibile,0,0));
        valorizzaHTMLElemento("divTotaleCostoC","€ "+formatter.format(totali.tCosto));
        
        if (totali.trasporto>0){
            var des="Sp. trasporto";
            
            if (parametriArticoli.modificheGuajana==1){
                des+=" presunte";
            }
        
            if (totali.percTrasp>0){
                des+=" "+formattaNumeri(totali.percTrasp,2,0)+"%";
            }

            if (skCli[0].TRASPORTOA!="0,00"){
                des+=" minimo €"+skCli[0].TRASPORTOA;
            }

            document.getElementById("divContTrasportoC").classList.remove("hide");
            document.getElementById("divContPiedeCarrello").classList.add("h120p");
            document.getElementById("divContPiedeCarrello").classList.remove("h95p");
            document.getElementById("divContCorpoCarrello").classList.add("posBottomA185p");
            document.getElementById("divContCorpoCarrello").classList.remove("posBottomA155p");

            valorizzaHTMLElemento("divDesTrasportoC",des);
            valorizzaHTMLElemento("divTrasportoC","€ "+formattaNumeri(totali.trasporto,2,2));

            if (totali.scCassa>0){
                var des="Extra Sconto";
                
                document.getElementById("divContScCassaC").classList.remove("hide");
                document.getElementById("divContPiedeCarrello").classList.add("h135p");
                document.getElementById("divContPiedeCarrello").classList.remove("h120p");
                document.getElementById("divContCorpoCarrello").classList.add("posBottomA200p");
                document.getElementById("divContCorpoCarrello").classList.remove("posBottomA185p");
    
                valorizzaHTMLElemento("divDesScCassaC",des);
                valorizzaHTMLElemento("divScCassaC",formattaNumeri(totali.scCassa,2,0)+"%");
            } else {
                document.getElementById("divContScCassaC").classList.add("hide");
                document.getElementById("divContPiedeCarrello").classList.remove("h135p");
                document.getElementById("divContCorpoCarrello").classList.remove("posBottomA200p");
            }
        } else {
            document.getElementById("divContTrasportoC").classList.add("hide");
            // document.getElementById("divContPiedeCarrello").classList.add("h95p");
            // document.getElementById("divContPiedeCarrello").classList.remove("h120p");
            // document.getElementById("divContCorpoCarrello").classList.add("posBottomA155p");
            // document.getElementById("divContCorpoCarrello").classList.remove("posBottomA185p");

            if (totali.scCassa>0){
                var des="Extra Sconto";
                
                document.getElementById("divContScCassaC").classList.remove("hide");
                document.getElementById("divContPiedeCarrello").classList.add("h120p");
                document.getElementById("divContPiedeCarrello").classList.remove("h95p");
                document.getElementById("divContPiedeCarrello").classList.remove("h135p");
                document.getElementById("divContCorpoCarrello").classList.add("posBottomA185p");
                document.getElementById("divContCorpoCarrello").classList.remove("posBottomA155p");
                document.getElementById("divContCorpoCarrello").classList.remove("posBottomA200p");
    
                valorizzaHTMLElemento("divDesScCassaC",des);
                valorizzaHTMLElemento("divScCassaC",formattaNumeri(totali.scCassa,2,0)+"%");
            } else {
                document.getElementById("divContScCassaC").classList.add("hide");
                document.getElementById("divContPiedeCarrello").classList.add("h95p");
                document.getElementById("divContPiedeCarrello").classList.remove("h120p");
                document.getElementById("divContPiedeCarrello").classList.remove("h135p");
                document.getElementById("divContCorpoCarrello").classList.add("posBottomA155p");
                document.getElementById("divContCorpoCarrello").classList.remove("posBottomA185p");
                document.getElementById("divContCorpoCarrello").classList.remove("posBottomA200p");
            }
        }

        var tRicarica=calcolaRicarico(totali.totale,totali.tCosto);
        valorizzaHTMLElemento("divTotaleRicaricoC",formatter.format(tRicarica)+"%");
        valorizzaHTMLElemento("divTotaleDeltaC","€ "+formatter.format(totali.totale-totali.tCosto));
        valorizzaHTMLElemento("divTotaleCostoCEv","€ "+formatter.format(totali.tCostoEvadibile));

        tRicarica=calcolaRicarico(totali.totEvadibile,totali.tCostoEvadibile);
        valorizzaHTMLElemento("divTotaleRicaricoCEv",formatter.format(tRicarica)+"%");
        valorizzaHTMLElemento("divTotaleDeltaCEv","€ "+formatter.format(totali.totEvadibile-totali.tCostoEvadibile));

        if (tRicarica<parametriArticoli["ricaricoRosso"]){
            srcRicarico="img/viola/ricarica.svg";
        } else if (tRicarica<parametriArticoli["ricaricoArancione"]){
            srcRicarico="img/rosse/ricarica.svg";
        } else if (tRicarica<parametriArticoli["ricaricoVerde"]){
            srcRicarico="img/arancione/ricarica.svg";
        } else {
            srcRicarico="img/verde/ricarica.svg";
        }

        document.getElementById('imgRicT').src=srcRicarico;

        if(parametriArticoli.calcolaProvvigioni==1){
            divProv=document.getElementById('totaleProvvigioniAgente');
            divProv.classList.remove('hide');
            // console.log(totali.totaliProvvigioniAgente);
            divProv.innerHTML="€ "+formattaNumeri(totali.totaliProvvigioniAgente,2,2);
        }
    } catch (error){

    }
}

function calcolaTotaliCarrello(totali,prodotti,molt=1,trasporto=null,spese=null,scCassa=null){
    var castelletto=totali.castellettoIva;

    var x=-1;

    if (prodotti!=null){
        for (i in castelletto) {
            if (prodotti.idIva === castelletto[i].idIva) {
                x=i;
                break;
            }
        }
        
        var importo=Number(prodotti.importo)-(Number(prodotti.importo)*Number(totali.scCassa)/100);

        if (x!=-1){
            castelletto[x].totImponibile+=importo*molt;
            castelletto[x].totIva=arrotonda(castelletto[x].totImponibile*prodotti.percIva/100,2);
    
            if (castelletto[x].totImponibile==0){
                castelletto.splice(x,1);
            }
        } else {
            castelletto.push({idIva:prodotti.idIva,percIva:prodotti.percIva,totImponibile:importo*molt,
                totIva:arrotonda(importo*molt*prodotti.percIva/100,2)});  
        }
        
        totali.tIva=0;

        for (i in castelletto) {
            totali.tIva+=castelletto[i].totIva;
        }

        totali.totaleMerce+=Number(prodotti.importo)*molt;
        totali.totale+=importo*molt;
        totali.tDoc=arrotonda(totali.totale+totali.tIva,2);
        totali.tCosto+=arrotonda(prodotti.qu*prodotti.costo,2)*molt;
        totali.tQu+=Number(prodotti.qu)*molt;

        if (totali.tColli==undefined){
            totali.tColli=0;
        }

        totali.tColli+=(Number(prodotti.qu)/Number(prodotti.quUnitaria)).toFixed(0)*molt;

        if (rsContrattiB2B!=undefined){
            if (prodotti[campoFamigliaTrainante]==famigliaTrainante){
                if (rsContrattiB2B[0].UM=="UM"){
                    totali.tQuTrainante+=Number(prodotti.qu)*molt;
                } else {
                    if (prodotti.quUnitaria==0){
                        totali.tQuTrainante+=Number(prodotti.qu)*molt;
                    } else {
                        totali.tQuTrainante+=(Number(prodotti.qu)/Number(prodotti.quUnitaria)).toFixed(0)*molt;
                    }
                }
            }
        }

        totali.tRighe+=1*molt;
        
        if (prodotti.peso!=undefined){
            if (totali.tPeso!=undefined){
                totali.tPeso+=prodotti.peso*prodotti.qu*molt;
            } else {
                totali.tPeso=prodotti.peso*prodotti.qu*molt;
            }
        }

        if (prodotti.disp>=prodotti.qu){
            totali.tQuEvadibile+=Number(prodotti.qu)*molt;
            totali.totEvadibile+=Number(importo)*molt;
            totali.tRigheEvadibili+=1*molt;
            totali.tCostoEvadibile+=arrotonda(prodotti.qu*prodotti.costo,2)*molt;
        } else {
            if (prodotti.disp>0){
                totali.tQuEvadibile+=Number(prodotti.disp)*molt;
                totali.totEvadibile+=arrotonda(prodotti.disp*prodotti.prezzo,2)*molt;
                totali.tCostoEvadibile+=arrotonda(prodotti.disp*prodotti.costo,2)*molt;
                totali.tRigheEvadibili+=arrotonda(prodotti.disp/prodotti.qu,2)*molt;
            }
        }
    }

    totali.nettoMerce=totali.totaleMerce;

    if (scCassa!=null){
        totali.scCassa=Number(scCassa);
    }

    if (totali.scCassa!=undefined){
        totali.nettoMerce=arrotonda(totali.totaleMerce-(totali.totaleMerce*totali.scCassa/100),2);
    }

    if (trasporto!=null){
        trasporto=Number(trasporto);
    
        totali.trasporto=trasporto;
        
        x=-1

        if (skCli[0].ID_IVA!="0"){
            var ivaDoc=Number(skCli[0].ID_IVA);
            var percIvaT=Number(skCli[0].PERCIVA);
        } else {
            var ivaDoc=xParametriGenerali.idIvaPredefinita;
            var percIvaT=xParametriGenerali.percIvaPredefinita;
        }

        for (i in castelletto) {
            if (ivaDoc === castelletto[i].idIva) {
                x=i;
                break;
            }
        }

        if (x!=-1){
            castelletto[x].totImponibile+=trasporto*molt;
            castelletto[x].totIva=arrotonda(castelletto[x].totImponibile*castelletto[x].percIva/100,2);
    
            if (castelletto[x].totImponibile==0){
                castelletto.splice(x,1);
            }
        } else {
            castelletto.push({idIva:ivaDoc,percIva:percIvaT,totImponibile:trasporto*molt,
                totIva:arrotonda(trasporto*molt*percIvaT/100,2)});  
        }
        
        totali.tIva=0;

        for (i in castelletto) {
            totali.tIva+=castelletto[i].totIva;
        }

        totali.totale+=trasporto*molt;
        totali.tDoc=arrotonda(totali.totale+totali.tIva,2);
    } 

    if (spese!=null){
        trasporto=Number(spese);

        totali.spese=trasporto;

        x=-1
        
        if (skCli[0].ID_IVA!="0"){
            var ivaDoc=Number(skCli[0].ID_IVA);
            var percIvaT=Number(skCli[0].PERCIVA);
        } else {
            var ivaDoc=xParametriGenerali.idIvaPredefinita;
            var percIvaT=xParametriGenerali.percIvaPredefinita;
        }

        for (i in castelletto) {
            if (ivaDoc === castelletto[i].idIva) {
                x=i;
                break;
            }
        }
    
        if (x!=-1){
            castelletto[x].totImponibile+=trasporto*molt;
            castelletto[x].totIva=arrotonda(castelletto[x].totImponibile*castelletto[x].percIva/100,2);
    
            if (castelletto[x].totImponibile==0){
                castelletto.splice(x,1);
            }
        } else {
            castelletto.push({idIva:ivaDoc,percIva:percIvaT,totImponibile:trasporto*molt,
                totIva:arrotonda(trasporto*molt*percIvaT/100,2)});  
        }
        
        totali.tIva=0;

        for (i in castelletto) {
            totali.tIva+=castelletto[i].totIva;
        }

        totali.totale+=trasporto*molt;
        totali.tDoc=arrotonda(totali.totale+totali.tIva,2);
    }

    totali.totale=arrotonda(totali.totale,2);
    totali.tCosto=arrotonda(totali.tCosto,2);
    totali.tCostoEvadibile=arrotonda(totali.tCostoEvadibile,2);
    totali.totEvadibile=arrotonda(totali.totEvadibile,2);

    if(parametriArticoli.calcolaProvvigioni==1){
        var jSonCli=JSON.parse(sessionStorage.getItem("schedaCliente.html."+tipoAnagrafica+"."+idCliente+".jSon")); 
        if(jSonCli!=undefined){
            //console.log(prodotti);
            var idAgenteTmp=0;
            if(xIdAgente>0){
                idAgenteTmp=xIdAgente;
            }else if(jSonCli[0].COD_AGENTE!= undefined && jSonCli[0].COD_AGENTE>0){
                idAgenteTmp=jSonCli[0].COD_AGENTE;
            }
            totali.totaliProvvigioniAgente+=Number(assegnaProvvigione(prodotti,rsProvviggioniAgente,0,idAgenteTmp,prodotti.przListinoRif,Number(recuperaHTMLElemento('FASCIAPROV.'+prodotti.codice)),0,0,prodotti.costo,jSonCli[0].PROVVIGIONETOTMERCE))*Number(molt);
            totali.totaliProvvigioniAgente=arrotonda(totali.totaliProvvigioniAgente,2);
        }
    }
    
    carrelloToStorage();

    if (trasporto==null && spese==null){
        if (skCli!=null){
            var percTraspA=0;
            var spTrasportoA=0;

            try {
                percTraspA=Number(skCli[0].PERCTRASPA.replace(".","").replace(",","."));
                spTrasportoA=Number(skCli[0].TRASPORTOA.replace(".","").replace(",","."));
            } catch (error) {
                
            }
            
            if (percTraspA>0 || spTrasportoA>0){
                var trasp=0;

                if (percTraspA>0){
                    trasp=arrotonda(totali.nettoMerce*percTraspA/100,2);
                    totali.percTrasp=percTraspA;
                } else if (totali.trasporto!=undefined) {
                    trasp=totali.trasporto;
                }

                if (trasp<spTrasportoA){
                    trasp=spTrasportoA;
                }

                valorizzaValueElemento("txtTrasporto",formattaNumeriInput(trasp));
                aggiornaSpese('txtTrasporto');
            }
        }
    }
}

function aggiornaTotale(){
    try {
        var totali=carrelloJson.totali;
        divTot=document.getElementById("divImportoTotale");
        divTot.innerHTML="€ "+formatter.format(Number(totali.nettoMerce));
    } catch (error){

    }    
}

function recuperaPrezzoScala(codice,qu){
    var res=false;

    jSonScala=undefined;

    var prodotti = carrelloJson.prodotti.data;
    var index=carrelloJson.prodotti.index;
    
    var i=index[codice]

    if (i!=undefined){
        if (prodotti[i].jSonScala!=undefined){
            jSonScala=prodotti[i].jSonScala;
        }
    } else {
        var scala=document.getElementById("SCALA."+codice);
        if (scala!=undefined){
            if (scala.innerHTML!=''){
                scala=scala.innerHTML;
                scala='['+scala.replace(/{/g,'{"').replace(/:/g,'":').replace(/;/g,',"').replace(/}/g,'}')+']';
                jSonScala=JSON.parse(scala);
            }
        }
    }

    if (jSonScala!=undefined){
        for (x in jSonScala){
            if (qu>=Number(jSonScala[x].QU)){
                res=jSonScala[x];
            }
        }
    }

    return res;
}

function aggiungiCarrello(e){
    var quTot=0;

    var codice=e.getAttribute("codice");
    var descrizione=document.getElementById("descrizione."+codice).getAttribute("tag");
    var imgSrc="img/noImg.svg";

    var soloRivenditori=recuperaHTMLElemento("SOLORIVENDITORI."+codice);
    if (soloRivenditori=="1"){
        if (skCli==undefined){
            skCli=JSON.parse(sessionStorage.getItem("schedaCliente.html.CLIENTE."+idCliente+".jSon"));
            if (skCli==undefined && xIdCliente>0){
                throw new TypeError("Necessario Ripartire da Home");
            }
        }

        if (skCli[0].RIVENDITORE=="0"){
            attivaAlert(0,"ATTENZIONE<BR>Questo prodotto può essere venduto solo a Rivenditori!")
            return;
        }
    }

    try {
        imgSrc=document.getElementById("percImg."+codice).innerHTML;
    } catch (err){

    }
    
    var um=document.getElementById("um."+codice).innerHTML;

    if ((parametriArticoli["modificheTroia"]==1 && um!='KG') || parametriArticoli.NoQuConfezione==1){
        var qu=1;
    } else {
        var qu=Number(document.getElementById("quUnitaria."+codice).innerHTML.replace(".","").replace(",","."));
    }

    var prezzo=Number(document.getElementById("prezzoNetto."+codice).getAttribute("tag"));
    var sc=document.getElementById("sconti."+codice).innerHTML;
    var listino=Number(document.getElementById("listino."+codice).innerHTML.replace("€ ","").replace(".","").replace(",","."));
    var idIva=Number(document.getElementById("IDIVA."+codice).innerHTML.replace(".","").replace(",","."));
    var percIva=Number(document.getElementById("PERCIVA."+codice).innerHTML.replace(".","").replace(",","."));
    
   
    var prodotti = carrelloJson.prodotti.data;
    var index=carrelloJson.prodotti.index;

    var i=index[codice];
    if (i!=undefined){
        listino=prodotti[i].listino;

        if (prodotti[i].sconti!=undefined){
            sc=prodotti[i].sconti;
        }

        prezzo=prodotti[i].prezzo;

        quTot=prodotti[i].qu;
        
        // if (prodotti[i].quScala!=undefined){
        //     if (prodotti[i].quScala>0){
        //         qu=prodotti[i].quScala;
        //     }
        // }
    }

    if (qu==0){
        qu=1;
    }

    quTot+=qu;
    var jScala=recuperaPrezzoScala(codice,quTot);
    var quScala=0;

    if (jScala!=false){
        quScala=Number(jScala.QU.replace(".","").replace(",","."));
        listino=Number(jScala.PREZZO.replace(".","").replace(",","."));
        sc=jScala.SCONTI;
        prezzo=Number(jScala.PREZZONETTO.replace(".","").replace(",","."));
        
    }
    if(parametriArticoli.ordiniACosto==1){
        var struCossto=document.getElementById('costoU.'+codice).innerHTML
        if(struCossto!=''){
            var costo=(struCossto.split('-'))[1];
            if(costo.indexOf(',')!=-1){
                costo=costo.replace(".","").replace(",",".");
            }
            listino=Number(costo);
            prezzo=Number(costo);
        }
        
    }
    var tQu=aggiungiCarrelloLocal(codice, descrizione,imgSrc,qu,prezzo,listino,sc,'§','§','+',um,idIva,percIva,"§","§",quScala);

    aggiornaLabelOrdinato(codice,tQu);
    aggiornaTotale();
    apriCarrello(true);
    verificaCostiTrasportoESconti();
}

function rimuoviCarrello(e,elimina=false){
    var quTot=0;

    var codice=e.getAttribute("codice");

    var label=document.getElementById("lblQu"+codice);    
    var descrizione=document.getElementById("descrizione."+codice).getAttribute("tag");
    var imgSrc="img/noImg.svg";
    var qu=-1;
    var prezzo=0;
    var sc="";
    var listino=0;
    var oPrezzo=0;
    var oSc="";
    var oListino=0;

    try {
        // imgSrc=document.getElementById("img."+codice).getAttribute("src").split("&");
        // imgSrc=imgSrc[imgSrc.length-1].split('=')[1];
        imgSrc=document.getElementById("percImg."+codice).innerHTML;
        
        var um=document.getElementById("um."+codice).innerHTML;

        if ((parametriArticoli["modificheTroia"]==1 && um!='KG') || parametriArticoli.NoQuConfezione==1){
            var qu=-1;
        } else {
            qu=Number(document.getElementById("quUnitaria."+codice).innerHTML.replace(".","").replace(",","."))*-1;
        }

        prezzo=Number(document.getElementById("prezzoNetto."+codice).getAttribute("tag"));
        sc=document.getElementById("sconti."+codice).innerHTML;
        listino=Number(document.getElementById("listino."+codice).innerHTML.replace("€ ","").replace(".","").replace(",","."));
        oSc=sc;
        oListino=listino;
    } catch (err){

    }
    
    var prodotti = carrelloJson.prodotti.data;
    var index=carrelloJson.prodotti.index;
    
    var i=index[codice];
    if (i!=undefined){
        listino=prodotti[i].listino;

        if (prodotti[i].sconti!=undefined){
            sc=prodotti[i].sconti;
        }

        prezzo=prodotti[i].prezzo;

        if (elimina){
            qu=prodotti[i].qu*-1;
        }

        quTot=prodotti[i].qu;
    }

    if (qu==0){
        qu=-1;
    }

    quTot+=qu;
    var jScala=recuperaPrezzoScala(codice,quTot);
    var quScala=0;

    if (jScala!=false){
        quScala=Number(jScala.QU.replace(".","").replace(",","."));
        listino=Number(jScala.PREZZO.replace(".","").replace(",","."));
        sc=jScala.SCONTI;
        prezzo=Number(jScala.PREZZONETTO.replace(".","").replace(",","."));
    } else {
        prezzo=arrotonda(Number(recuperaHTMLElemento("PREZZONETTOORIG."+codice)),xParametriGenerali.decimaliPrezzi);
        sc=oSc;
        listino=oListino;
    }

    var tQu=aggiungiCarrelloLocal(codice,descrizione,imgSrc,qu,prezzo,listino,sc,'§','§','+','',0,0,"§","§",quScala);

    aggiornaLabelOrdinato(codice,tQu);  
    aggiornaTotale();
    apriCarrello(true);
    verificaCostiTrasportoESconti();
}

function aggiungiCarrelloScala(qu, prezzo, sc){
    modal=document.getElementById("modScalaSconti");

    var codice=modal.getAttribute("codice");
    var descrizione=modal.getAttribute("descrizione");

    modal.style.display="none";

    var imgSrc="img/noImg.svg";

    var soloRivenditori=recuperaHTMLElemento("SOLORIVENDITORI."+codice);
    if (soloRivenditori=="1"){
        if (skCli[0].RIVENDITORE=="0"){
            attivaAlert(0,"ATTENZIONE<BR>Questo prodotto può essere venduto solo a Rivenditori!")
            return;
        }
    }

    try {
        // imgSrc=document.getElementById("img."+codice).getAttribute("src").split("&");
        // imgSrc=imgSrc[imgSrc.length-1].split('=')[1];
        imgSrc=document.getElementById("percImg."+codice).innerHTML;
    } catch (err){

    }
    
    qu=Number(qu.replace(".","").replace(",","."));
    prezzo=Number(prezzo.replace(".","").replace(",","."));

    var quScala=qu;

    if (sc!=""){
        if (sc.indexOf("+")>0){
            var mSc=sc.split("+");
            for (x in mSc){
                xSc=Number(mSc[x].replace(".","").replace(",","."));
                prezzo=prezzo*(100-xSc)/100;
            }
        } else {
            xSc=Number(sc.replace(".","").replace(",","."));
            prezzo=prezzo*(100-xSc)/100;
        }

        prezzo=arrotonda(prezzo,xParametriGenerali.decimaliPrezzi);
    }
    
    var listino=Number(document.getElementById("listino."+codice).innerHTML.replace("€ ","").replace(".","").replace(",","."));
    var um=document.getElementById("um."+codice).innerHTML;
    var idIva=Number(document.getElementById("IDIVA."+codice).innerHTML.replace(".","").replace(",","."));
    var percIva=Number(document.getElementById("PERCIVA."+codice).innerHTML.replace(".","").replace(",","."));

    var prodotti = carrelloJson.prodotti.data;
    var index=carrelloJson.prodotti.index;
    
    var i=index[codice];
    if (i!=undefined){
        listino=prodotti[i].listino;

        if (prodotti[i].sconti!=undefined){
            sc=prodotti[i].sconti;
        }

        prezzo=prodotti[i].prezzo;
        
        var aQu=prodotti[i].qu*-1;

        var tQu=aggiungiCarrelloLocal(codice,descrizione,imgSrc,aQu,prezzo,listino,sc);

        aggiornaLabelOrdinato(codice,tQu);  
        aggiornaTotale();
    }
    
    if (qu==0){
        qu=1;
    }

    var jScala=recuperaPrezzoScala(codice,qu);
    var quScala=0;

    if (jScala!=false){
        quScala=Number(jScala.QU.replace(".","").replace(",","."));
        listino=Number(jScala.PREZZO.replace(".","").replace(",","."));
        sc=jScala.SCONTI;
        prezzo=Number(jScala.PREZZONETTO.replace(".","").replace(",","."));
    }

    var tQu=aggiungiCarrelloLocal(codice, descrizione,imgSrc,qu,prezzo,listino,sc,'§','§','+',um,idIva,percIva,"§","§",quScala);

    aggiornaLabelOrdinato(codice,tQu);
    aggiornaTotale();
    apriCarrello(true);
    verificaCostiTrasportoESconti();
}

function calcolaRicarico(prezzo,costo){
    if (costo==0){
        return 0;
    } else {
        var ricarico=((100*prezzo)/costo)-100;
        return arrotonda(ricarico,2);
    }
}

function aggiungiCarrelloLocal(codice,descrizione,imgSrc,qu,prezzo,listino,sc,notaUfficio='§',notaPrelievo='§',segno='+',um='',idIva=0,percIva=0,indispensabile="§",prenotazione="§",quScala=0,quReso=0,visQuReso=0,quOmaggio=0,visQuOmaggio=0){
    var prodotti = carrelloJson.prodotti.data;
    var index=carrelloJson.prodotti.index;
    
    var totali=carrelloJson.totali;
    
    if (sc=="" && listino!=prezzo){
        listino=prezzo;
    }
    
    var disp=0;
    var ordinato=0;
    var costo=0;
    var srcDisp="img/bianche/bianco.svg";
    var srcRicarico="img/bianche/bianco.svg";
    var ricarico=0;
    var quUnitaria=0;
    var przListinoRif=0;
    var scontiListinoRif="";

    disp=Number(recuperaHTMLElemento("disp."+codice).replace(".","").replace(",","."));
    ordinato=Number(recuperaHTMLElemento("ord."+codice).replace(".","").replace(",","."));
    costo=Number(recuperaHTMLElemento("costo."+codice).replace(".","").replace(",","."));
    var fasciaProvvigione=Number(recuperaHTMLElemento('FASCIAPROV.'+codice).replace(".","").replace(",","."));
    przListinoRif=Number(recuperaHTMLElemento("listinoRif."+codice));
    scontiListinoRif=recuperaHTMLElemento("sconti."+codice);
    
    if (disp<0){
        disp=0;
    }

    var x=-1;

    var i=index[codice];
    if (i!=undefined){
        x=i;
    }

    if (x==-1){
        var peso=recuperaHTMLElemento("PESO."+codice,false,true);
        var grMerc=recuperaHTMLElemento("GRMERC."+codice,false,false);
        var sGrMerc=recuperaHTMLElemento("SGRMERC."+codice,false,false);
        var sFam1=recuperaHTMLElemento("SFAM1."+codice,false,false);
        var sFam2=recuperaHTMLElemento("SFAM2."+codice,false,false);
        
        if (qu<=0 && quReso<=0 && quOmaggio<=0){
            attivaAlert(0,"Impossibile Aggiungere Prodotti con Quantità minore o uguale a 0!","erroreQu");
            return 0;
        }

        if (notaUfficio=="§"){
            notaUfficio="";
        }

        if (notaPrelievo=="§"){
            notaPrelievo="";
        }

        if (prenotazione=="§"){
            prenotazione=false;
        }

        if (indispensabile=="§"){
            indispensabile=false;
        }

        var valori = {codice:codice, descrizione:descrizione, imgSrc:imgSrc, qu:qu, prezzo: prezzo, listino:listino, sconti: sc, um:um, 
                        srcDisp:srcDisp, srcRicarico:srcRicarico, ricarico:ricarico, costo:costo, disp:disp, ordinato:ordinato, quUnitaria:quUnitaria,
                        importo:arrotonda(qu*prezzo,2), notaUfficio:notaUfficio, notaPrelievo:notaPrelievo,
                        idIva:idIva, percIva:percIva, indispensabile:indispensabile, prenotazione:prenotazione,przListinoRif:przListinoRif,
                        quScala:quScala, jSonScala:jSonScala, scontiListinoRif:scontiListinoRif, peso:peso,'fasciaProvvigione':fasciaProvvigione,'percentualeProvvigione':0,'importoProvvigione':0,
                        grMerc:grMerc, sGrMerc:sGrMerc, sFam1:sFam1, sFam2:sFam2
                    };

        prodotti.push(valori);
        x=prodotti.length-1;
        index[codice]=x;

        prodotti[x].quReso=quReso;
        prodotti[x].quOmaggio=quOmaggio;
    } else {
        calcolaTotaliCarrello(totali,prodotti[x],-1);

        if (segno=='+'){
            prodotti[x].qu+=qu;
        } else {
            prodotti[x].qu=qu;
        }
        
        prodotti[x].quReso=quReso;
        prodotti[x].quOmaggio=quOmaggio;

        if (prodotti[x].qu<=0 && prodotti[x].quReso<=0 && prodotti[x].quOmaggio<=0){
            eliminaCarrelloLocal(codice,x);
            return 0;
        }

        prodotti[x].quScala=quScala;
        prodotti[x].prezzo=prezzo;
        prodotti[x].importo=arrotonda(prodotti[x].qu*prezzo,2);
        prodotti[x].srcRicarico=srcRicarico;
        prodotti[x].listino=listino;
        prodotti[x].ricarico=ricarico;

        if (notaPrelievo!="§"){
            prodotti[x].notaPrelievo=notaPrelievo;
            prodotti[x].notaUfficio=notaUfficio;
            prodotti[x].prenotazione=prenotazione;
            prodotti[x].indispensabile=indispensabile;
        }

        prodotti[x].sconti=sc;

        disp=prodotti[x].disp;
        ordinato=prodotti[x].ordinato;
        costo=prodotti[x].costo;
    }
    
    prodotti[x].hideNoDisp="hide";
    prodotti[x].hideDisp="hide";
    prodotti[x].hideQu="";
    prodotti[x].visQuReso=visQuReso;
    prodotti[x].visQuOmaggio=visQuOmaggio;

    if (quReso==0){
        hideDesReso="hide";
    } else {
        hideDesReso="";
    }

    if (quOmaggio==0){
        hideDesOmaggio="hide";
    } else {
        hideDesOmaggio="";
    }

    prodotti[x].hideDesReso=hideDesReso;
    prodotti[x].hideDesOmaggio=hideDesOmaggio;

    if (disp<prodotti[x].qu){
        if (disp>0){
            prodotti[x].hideDisp="";
            prodotti[x].hideQu="hide";
            prodotti[x].hideNoDisp="hide";
        } else {
            prodotti[x].hideDisp="hide";
            prodotti[x].hideQu="hide";
            prodotti[x].hideNoDisp="";
        }

        if (ordinato>0){
            srcDisp="img/grafiche/inArrivoN.svg";
        } else {
            if (disp>0){
                srcDisp="img/grafiche/parzialeN.svg";
            } else {
                srcDisp="img/grafiche/inDisponibileN.svg";
            }
        }
    } else {
        srcDisp="img/grafiche/disponibileN.svg";
    }

    prodotti[x].srcDisp=srcDisp;

    if (costo!=0){
        ricarico=calcolaRicarico(prodotti[x].prezzo,costo);
        if (ricarico<parametriArticoli["ricaricoRosso"]){
            srcRicarico="img/viola/ricarica.svg";
        } else if (ricarico<parametriArticoli["ricaricoArancione"]){
            srcRicarico="img/rosse/ricarica.svg";
        } else if (ricarico<parametriArticoli["ricaricoVerde"]){
            srcRicarico="img/arancione/ricarica.svg";
        } else {
            srcRicarico="img/verde/ricarica.svg";
        }
    }

    prodotti[x].srcRicarico=srcRicarico;
    prodotti[x].ricarico=ricarico;

    carrelloToStorage();

    calcolaTotaliCarrello(totali,prodotti[x]);
    
    return prodotti[x].qu;
}

function eliminaCarrelloLocal(codice, x=-1){
    var prodotti = carrelloJson.prodotti.data;
    var index=carrelloJson.prodotti.index;

    var totali=carrelloJson.totali;

    if (x==-1) {
        var i=index[codice];
        if (i!=undefined){
            x=i;
        }

        calcolaTotaliCarrello(totali,prodotti[x],-1);
    }
    
    prodotti.splice(x, 1);
    delete index[codice];

    for (i in index){
        if (index[i]>x){
            index[i]-=1;
        }
    }

    carrelloToStorage();
}

var riapri=false;
var scrollCarrello=0;

function apriModificaQuantita(codice,descrizione,UM,disp,quUnitaria,inArrivo,listino,scontato,sc1,listinoRif,visQuReso,visQuOmaggio,ePromo='',eScala='') {
    var chk=document.getElementById("nav-toggleP");

    if (chk.checked){
        var ul=document.getElementById("elencoCarrello");
        riapri=true;
        scrollCarrello=ul.scrollTop;
        chk.click();
    }

    var idIva=0;
    var percIva=0;
    var costo=0;
    var przListinoRif=0;

    try{
        idIva=Number(document.getElementById("IDIVA."+codice).innerHTML.replace(".","").replace(",","."));
        percIva=Number(document.getElementById("PERCIVA."+codice).innerHTML.replace(".","").replace(",","."));
        costo=Number(document.getElementById("costo."+codice).innerHTML.replace(".","").replace(",","."));
    } catch (error){

    }
    
    if (isNaN(listinoRif)){
        przListinoRif=Number(listinoRif.replace(',','.')); //recuperaHTMLElemento("listinoRif."+codice)
    } else {
        przListinoRif=Number(listinoRif); //recuperaHTMLElemento("listinoRif."+codice)
    }

    document.getElementById('divModalDescrizione').innerHTML=descrizione;
    document.getElementById('divModalCodice').innerHTML=codice;
    document.getElementById('divQuUnitaria').innerHTML=quUnitaria;
    document.getElementById('divDisp').innerHTML=disp;

    if (recuperaHTMLElemento("desOrd."+codice)!=''){
        document.getElementById('divDesInArrivo').innerHTML=recuperaHTMLElemento("desOrd."+codice);
        document.getElementById('divDesQuUnitaria').innerHTML=recuperaHTMLElemento("desQuUnitaria."+codice);
        document.getElementById('divInArrivo').innerHTML=inArrivo.replace("UM",recuperaValueElemento("umoRD."+codice));
        if (document.getElementById("disp."+codice).classList.contains("hide")){
            document.getElementById("divDisponibile").classList.add("hide");
        }
    } else {
        document.getElementById('divInArrivo').innerHTML=inArrivo;
    }

    if (visQuReso==1){
        document.getElementById("divReso").classList.remove("hide");
    } else {
        document.getElementById("divReso").classList.add("hide");
    }

    if (visQuOmaggio==1){
        document.getElementById("divOmaggio").classList.remove("hide");

        if (parametriArticoli.omaggioSoloMandante==1){
            try {
                idMandante=window.sessionStorage.getItem("idMandante");
                if (idMandante=="null" || idMandante=="0"){
                    document.getElementById("divOmaggio").classList.add("hide");
                }   
            } catch (error) {

            }
        }
    } else {
        document.getElementById("divOmaggio").classList.add("hide");
    }

    var qu=0; //Number(document.getElementById("lblQu"+codice).innerHTML);

    var strSc="";
    var vSc;

    if (sc1==""){
        document.getElementById("txtSc1").value="0";
    } else {
        document.getElementById("txtSc1").value=sc1;
        strSc=sc1;
    }
    
    document.getElementById('divListino').innerHTML=formattaNumeri(przListinoRif,parametriArticoli["decimaliPrezzi"],2);
    
    document.getElementById("txtPrezzo").setAttribute("originale",listino);
    document.getElementById("txtSc1").setAttribute("originale",strSc);

    if (strSc=="" && listino!=scontato){
        listino=scontato;
    }
    
    if (listino!=''){
        document.getElementById("txtPrezzo").value=Number(listino.replace("€ ","").replace('.','').replace(',','.'));
    } else {
        document.getElementById("txtPrezzo").value=Number(scontato.replace("€ ","").replace('.','').replace(',','.'));
    }    

    if (strSc==""){
        vSc=[0];
    } else if(strSc.indexOf("+")>0){
        vSc=strSc.split("+");
    } else {
        vSc=[Number(strSc)];
    }

    var prezzo=document.getElementById("txtPrezzo").value;

    for (x in vSc){
        prezzo=prezzo-(prezzo*vSc[x]/100);
    }

    if (isNaN(qu)){
        qu=0;
    }

    document.getElementById('txtNotaPrelievo').value="";
    document.getElementById('txtNotaUfficio').value="";
    document.getElementById('chkPrenotazione').checked=false;
    document.getElementById('chkIndispensabile').checked=false;
    
    var prodotti = carrelloJson.prodotti.data;
    var index=carrelloJson.prodotti.index;
    
    var i=index[codice];
    var quScala=0;
    var quReso=0;
    var quOmaggio=0;

    if (i!=undefined){
        if (prodotti[i].notaPrelievo!=undefined){
            document.getElementById('txtNotaPrelievo').value=prodotti[i].notaPrelievo;
        }
        
        if (prodotti[i].notaPrelievo!=undefined){
            document.getElementById('txtNotaUfficio').value=prodotti[i].notaUfficio;
        }

        if (prodotti[i].prenotazione!=undefined){
            document.getElementById('chkPrenotazione').checked=prodotti[i].prenotazione;
        }
        
        if (prodotti[i].indispensabile!=undefined){
            document.getElementById('chkIndispensabile').checked=prodotti[i].indispensabile;
        }

        document.getElementById('txtPrezzo').value=prodotti[i].listino;   
        
        if (prodotti[i].sconti!=undefined){
            document.getElementById("txtSc1").value=prodotti[i].sconti;
        }

        qu=prodotti[i].qu;
        prezzo=prodotti[i].prezzo;
        idIva=prodotti[i].idIva;
        percIva=prodotti[i].percIva;
        costo=prodotti[i].costo;
        
        if (przListinoRif!=prodotti[i].listino && prodotti[i].scontiListinoRif==""){
            ePromo="hide";
        }

        if (prodotti[i].quReso!=undefined){
            quReso=prodotti[i].quReso;
        }
        
        if (prodotti[i].quOmaggio!=undefined){
            quOmaggio=prodotti[i].quOmaggio;
        }

        if (prodotti[i].quScala!=undefined){
            if (prodotti[i].quScala>0){
                quScala=prodotti[i].quScala;
            }
        }

        if (prodotti[i].jSonScala!=undefined){
            document.getElementById("txtPrezzo").setAttribute("originale",formattaNumeri(przListinoRif,parametriArticoli["decimaliPrezzi"]));
            eScala="hide";
        }
    }

    document.getElementById('divPercIvaM').innerHTML=percIva;
    document.getElementById('divIdIvaM').innerHTML=idIva;
    document.getElementById('divPrezzoNettoM').innerHTML=formattaNumeri(prezzo,parametriArticoli["decimaliPrezzi"],2);

    var importo=arrotonda(qu*prezzo,2);

    var txtQu=document.getElementById("txtQu");
    txtQu.value=qu;

    valorizzaValueElemento("txtQuReso",quReso);
    valorizzaValueElemento("txtQuOmaggio",quOmaggio);

    // if (quScala>0){
    //     txtQu.disabled=true;
    // } else {
    //     txtQu.disabled=false;
    // }

    document.getElementById("txtImporto").value=formattaNumeri(importo,2,2);

    var ricarica=calcolaRicarico(prezzo,costo);    
    document.getElementById('divCostoM').innerHTML="€ "+formattaNumeri(costo,parametriArticoli["decimaliPrezzi"],2);
    document.getElementById('divRicaricoM').innerHTML=formattaNumeri(ricarica,2,0)+"%";
    document.getElementById('divDeltaM').innerHTML="&Delta; "+formattaNumeri(importo-(qu*costo),2,2);

    mostraRicarica(ricarica);

    // document.getElementById('divIntestazione').innerHTML="MODIFICA QUANTITA' IN "+UM;
    document.getElementById("slblQu").innerHTML=UM;
    document.getElementById("txtQu").setAttribute("placeholder",UM);
    
    if (parametriArticoli["modificaPrezzi"]==0 || ePromo=="hide" || eScala=="hide"){
        document.getElementById("txtPrezzo").disabled=true;
        document.getElementById("txtSc1").disabled=true;
    } else {
        document.getElementById("txtPrezzo").disabled=false;
        document.getElementById("txtSc1").disabled=false;
    }

    if (parametriArticoli["modificaSconti"]!=undefined){
        if (parametriArticoli["modificaSconti"]==1){
            document.getElementById("txtSc1").disabled=false;
        }
    }

    document.getElementById("txtImporto").disabled=true;

    modal=document.getElementById("modModificaQuantita");
    modal.style.display="block";

    txtQu.focus();
}

function annullaModificaCarrello(){
    if (riapri){
        apriCarrello();

        var ul=document.getElementById("elencoCarrello");
        ul.scrollTop=scrollCarrello;
    }

    chiudiModalBox();
}

function calcolaImporto(e){
    var codice=document.getElementById('divModalCodice').innerHTML;
    var qu=Number(document.getElementById("txtQu").value);
    var strSc="";
    var prezzo=0;

    var txtPrezzo=document.getElementById("txtPrezzo");
    var txtSc=document.getElementById("txtSc1");

    if (e.getAttribute("id")=="txtQu"){
        var jScala=recuperaPrezzoScala(codice,qu);

        if (jScala!=false){
            prezzo=Number(jScala.PREZZO.replace(".","").replace(",","."));
            strSc=jScala.SCONTI;
        } else {
            prezzo=Number(txtPrezzo.getAttribute("originale").replace("€ ","").replace('.','').replace(',','.'));
            strSc=txtSc.getAttribute("originale");
        }

        txtPrezzo.value=prezzo;
        txtSc.value=strSc;
    } else {
        strSc=document.getElementById("txtSc1").value;
        prezzo=Number(document.getElementById("txtPrezzo").value);
    }

    if (isNaN(qu)){
        qu=0
    }

    if (isNaN(prezzo)){
        prezzo=0
    }

    var vSc;

    if (strSc==""){
        vSc=[0];
    } else if(strSc.indexOf("+")>0){
        vSc=strSc.split("+");
        for (x in vSc){
            vSc[x]=Number(vSc[x].replace(",","."));
        }
    } else {
        if (isNaN(Number(strSc))){
            attivaAlert(0,"Valore Sconto Non Valido!","erroreSconto");
            document.getElementById("txtSc1").value=0;
            strSc="0";
        }
    
        vSc=[Number(strSc)];
    }

    if (vSc.length>parametriArticoli.maxSconti){
        attivaAlert(0,"Numero Sconti Troppo Elevato!","erroreSconto");
        document.getElementById("txtSc1").value=0;
        vSc=[0];
    }

    for (x in vSc){
        prezzo=arrotonda(prezzo-(prezzo*vSc[x]/100),5);
    }

    var importo=arrotonda(qu*prezzo,2)

    var txtImporto=document.getElementById("txtImporto");
    txtImporto.value=formattaNumeri(importo,2,2);

    var costo=Number(document.getElementById('divCostoM').innerHTML.replace("€ ","").replace(".","").replace(",","."));
    var ricarica=calcolaRicarico(prezzo,costo);
    document.getElementById('divRicaricoM').innerHTML=formattaNumeri(ricarica,2,0)+"%";
    document.getElementById('divDeltaM').innerHTML="&Delta; "+formattaNumeri(importo-(qu*costo),2,2);
    document.getElementById('divPrezzoNettoM').innerHTML=formattaNumeri(prezzo,parametriArticoli["decimaliPrezzi"],2);

    mostraRicarica(ricarica);
}

function mostraRicarica(ricarico){
    var srcRicarico;

    if (ricarico<parametriArticoli["ricaricoRosso"]){
        srcRicarico="img/viola/ricarica.svg";
    } else if (ricarico<parametriArticoli["ricaricoArancione"]){
        srcRicarico="img/rosse/ricarica.svg";
    } else if (ricarico<parametriArticoli["ricaricoVerde"]){
        srcRicarico="img/arancione/ricarica.svg";
    } else {
        srcRicarico="img/verde/ricarica.svg";
    }

    document.getElementById("imgRicM").src=srcRicarico;
}

function aggiornaCarrelloDaModifica(){
    var qu=Number(document.getElementById("txtQu").value);
    var strSc=document.getElementById("txtSc1").value;
    var prezzo=Number(document.getElementById("txtPrezzo").value);
    var listino=Number(document.getElementById('txtPrezzo').value);
    var descrizione=document.getElementById('divModalDescrizione').innerHTML;
    var codice=document.getElementById('divModalCodice').innerHTML;
    //var imgSrc=document.getElementById("img."+codice).src;
    var notaPrelievo=document.getElementById('txtNotaPrelievo').value;
    var notaUfficio=document.getElementById('txtNotaUfficio').value;
    var um=document.getElementById("slblQu").innerHTML;
    var idIva=Number(document.getElementById('divIdIvaM').innerHTML);
    var percIva=Number(document.getElementById("divPercIvaM").innerHTML);
    var chkIndispensabile=document.getElementById("chkIndispensabile").checked;
    var chkPrenotazione=document.getElementById("chkPrenotazione").checked;

    var soloRivenditori=recuperaHTMLElemento("SOLORIVENDITORI."+codice);
    if (soloRivenditori=="1"){
        if (skCli[0].RIVENDITORE=="0"){
            attivaAlert(0,"ATTENZIONE<BR>Questo prodotto può essere venduto solo a Rivenditori!")
            return;
        }
    }
    
    var vSc;

    var imgSrc="img/noImg.svg";
    try {
        // imgSrc=document.getElementById("img."+codice).getAttribute("src").split("&");
        // imgSrc=imgSrc[imgSrc.length-1].split('=')[1];
        imgSrc=document.getElementById("percImg."+codice).innerHTML;
    } catch (err){

    }
    
    if (strSc==""){
        vSc=[0];
    } else if(strSc.indexOf("+")>0){
        vSc=strSc.split("+");
        for (x in vSc){
            vSc[x]=Number(vSc[x].replace(",","."));
        }
    } else {
        vSc=[Number(strSc)];
    }
    
    for (x in vSc){
        prezzo=prezzo-(prezzo*vSc[x]/100);
    }

    if (isNaN(prezzo)){
        attivaAlert(0,"Importo Non Valido!","errImporto");
        return;
    }
    var jScala=recuperaPrezzoScala(codice,qu);
    var quScala=0;

    if (jScala!=false){
        quScala=Number(jScala.QU.replace(".","").replace(",","."));
    }

    var quReso=0;
    var visQuReso=0;

    var quOmaggio=0;
    var visQuOmaggio=0;

    if (document.getElementById("divReso").getAttribute("class").indexOf("hide")<0){
        visQuReso=1;
        if (!isNaN(recuperaValueElemento("txtQuReso"))){
            quReso=Number(recuperaValueElemento("txtQuReso"));
        }   
    }

    if (document.getElementById("divOmaggio").getAttribute("class").indexOf("hide")<0){
        visQuOmaggio=1;
        if (!isNaN(recuperaValueElemento("txtQuOmaggio"))){
            quOmaggio=Number(recuperaValueElemento("txtQuOmaggio"));
        }   
    }

    var tQu=aggiungiCarrelloLocal(codice,descrizione,imgSrc,qu,prezzo,listino,strSc,notaUfficio,notaPrelievo,"=",um,idIva,percIva,chkIndispensabile,chkPrenotazione,quScala,quReso,visQuReso,quOmaggio,visQuOmaggio);

    if (riapri){
        apriCarrello();

        var ul=document.getElementById("elencoCarrello");
        ul.scrollTop=scrollCarrello;
    }

    aggiornaLabelOrdinato(codice,tQu,quReso,quOmaggio);
    aggiornaTotale();
    chiudiModalBox();
    verificaCostiTrasportoESconti();
}

function apriCarrello(update=false){
    var chk=document.getElementById("nav-toggleP");
    document.getElementById("cmdPDF").classList.add("hide");

    try {
        if (carrelloJson.testata.numero!=undefined){
            var int=document.getElementById("intCarrello");
            var testo="";
    
            if (carrelloJson.testata.genere==5){
                testo="Ordine";
            } else {
                testo="Preordine";
            }
    
            testo+=" nr. "+carrelloJson.testata.numero+" del "+carrelloJson.testata.dataDoc;
    
            int.innerHTML=testo;

            document.getElementById("cmdPDF").classList.remove("hide");
        }
    } catch (error){

    }

    riapri=false;

    if (!chk.checked || update){
        var prodotti = carrelloJson.prodotti.data;

        var ul=document.getElementById("elencoCarrello");
        ul.innerHTML="";

        if (prodotti.length>0){
            popolaElencoDaJson(prodotti,'elencoCarrello',0,'carrello.js',true,0);
        }
    }
    
    aggiornaTotaliCarrello();
    
    if (!update){
        chk.click();
    }
}

var gPreordine;

function apriSalvaOrdine(preordine=true){
    if (idCliente==0){
        apriModalCustom('ListaArticoli.html:modalListaMagazzino','','Funzione lista','salvaListaMagazzino()',0)
        return;
    }

    if (skCli==undefined){
        attivaAlert(xTipoAllert.CRITICO,"Non è stata correttamente scaricata la scheda del cliente!<br>Tornare indietro e ripartire dalla scheda del cliente per procedere.");
        return;
    }

    if (preordine==true){
        document.getElementById("DivDatiOrdineCliente").classList.add("hide");
    } else {
        document.getElementById("DivDatiOrdineCliente").classList.remove("hide");

        if (rsContrattiB2B!=undefined){
            if (carrelloJson.totali.tQuTrainante<rsContrattiB2B[0].QUMIN){
                attivaAlert(xTipoAllert.CRITICO,"Non è possibile effettuare un ordine per quantità inferiori a "+rsContrattiB2B[0].QUMIN+" della famiglia prodotti "+rsContrattiB2B[0].DESFAMIGLIA+"<br>Si prega di aggiungere ulteriori articoli al carrello.");
                return;
            }
        }
    }

    const vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);

    gPreordine=preordine;

    if (vw>540){
        mostraNascondiElemento("divAltriDatiCliente","hide",document.getElementById("cmdDati"));
        mostraNascondiElemento("divDestinazione","hide",document.getElementById("cmdDatiDest"));
    }

    if (parametriArticoli["visMandante"]==1){
        document.getElementById("divDatiOrdine").classList.remove("posTopA100p");
        document.getElementById("divDatiOrdine").classList.add("posTopA130p");
        document.getElementById("divMandanteContainer").classList.remove("hide");
        mandante=window.sessionStorage.getItem("idMandante");
        valorizzaHTMLElemento("divMandante", window.sessionStorage.getItem("desMandante"));
    }

    valorizzaHTMLElemento("divCliente",skCli[0].RAGIONE_SOCIALE);
    valorizzaHTMLElemento("divIndirizzo",skCli[0].INDIRIZZO+'<BR>'+skCli[0].LOCALITA);
    valorizzaHTMLElemento("divPIva",skCli[0].PIVA);
    valorizzaHTMLElemento("divCF",skCli[0].CF);
    valorizzaHTMLElemento("divSDI",skCli[0].SDI);
    valorizzaHTMLElemento("divPEC",skCli[0].PEC);

    if (idPagamentoD!=0 && idPagamentoD!=undefined && dPagamentoD!=undefined){
        valorizzaHTMLElemento("divPagamento",dPagamentoD);
    } else {
        valorizzaHTMLElemento("divPagamento",skCli[0].DPAGAMENTO);
    }
    
    valorizzaHTMLElemento("divFido",skCli[0].FIDO);
    valorizzaHTMLElemento("divSaldo",skCli[0].SALDO);

    valorizzaCampiTestata();
    valorizzaCampiDestinazione();

    var totali=carrelloJson.totali;

    if (totali.totale==0){
        document.getElementById("divMetodoPagamento").classList.add("hide");
    } else {
        document.getElementById("divMetodoPagamento").classList.remove("hide");
    }

    if (parametriArticoli.modificheDenaro==1){
        document.getElementById("divDatiConsegna").classList.add("hide");
        document.getElementById("divNoteU").classList.add("hide");
        document.getElementById("divNoteM").classList.add("hide");
        document.getElementById("divNoteV").classList.add("hide");
        document.getElementById("divNoteG").classList.remove("hide");
        document.getElementById("divOrdineCli").classList.remove("hide");
        document.getElementById("cmdDatiDest").click();

        if (totali.totale>0 && totali.totale<300){
            valorizzaValueElemento("txtTrasporto",8);
            aggiornaSpese('txtTrasporto');
        }
    }

    verificaCostiTrasportoESconti();

    if (xIdCliente>0){
        document.getElementById("txtTrasporto").disabled=true;
        document.getElementById("txtSpese").disabled=true;
    }

    if (xIdCliente>0 || xIdAgente>0){
        document.getElementById("txtScCassa").disabled=true;
    }
    
    try {
        document.getElementById("cmdDest").classList.add(skCli[0].HIDEDEST);
    } catch (error) {

    }
    
    valorizzaValueElemento("txtTrasporto", formattaNumeriInput(totali.trasporto,2,2));
    valorizzaValueElemento("txtSpese",formattaNumeriInput(totali.spese,2,2));
    valorizzaValueElemento("txtScCassa",formattaNumeriInput(totali.scCassa,2,0));

    var prodotti = carrelloJson.prodotti.data;

    indispensabili = [];
    prenotati=[];

    for (x in prodotti){
        if (prodotti[x].indispensabile==true){
            indispensabili.push(prodotti[x]);
        }
        if (prodotti[x].prenotazione==true){
            prenotati.push(prodotti[x]);
        }
    }

    if (indispensabili.length>0){
        popolaElencoDaJson(indispensabili,'elencoIndispensabili',0,'carrello.js:indispensabili',true,0);
    }

    if (prenotati.length>0){
        popolaElencoDaJson(prenotati,'elencoPrenotati',0,'carrello.js:prenotati',true,0);
    }

    modal=document.getElementById("modChiusuraOrdine");
    modal.style.display="block";
}

function valorizzaCampiDestinazione() {
    try {
        var jSonDest=carrelloJson.testata.destinazioni;

        if (jSonDest==undefined){
            var xJSonDest=localStorage.getItem(xNomeDestinazione);
            if (xJSonDest!=undefined){
                xJSonDest=JSON.parse(xJSonDest);
                carrelloJson.testata.destinazioni=xJSonDest;

                carrelloToStorage();

                jSonDest=carrelloJson.testata.destinazioni;
            }
        }
        
        if (jSonDest!=undefined){
            valorizzaHTMLElemento("divIdDestinazione",jSonDest.idDest);
            valorizzaValueElemento("txtDestinazione",jSonDest.ragioneSociale);
            valorizzaValueElemento("txtIndirizzoDest",jSonDest.indirizzo);
            valorizzaValueElemento("txtLocalita",jSonDest.localita);
            valorizzaValueElemento("txtCAP",jSonDest.cap);
            valorizzaValueElemento("txtProv",jSonDest.prov);
            valorizzaValueElemento("txtTel",jSonDest.tel);
            valorizzaValueElemento("txtFax",jSonDest.fax);
        }
    } catch (error){

    }
}

function aggiornaDestinazione(){
    var idDest=recuperaHTMLElemento("divIdDestinazione");
    var ragioneSociale=recuperaValueElemento("txtDestinazione");
    var indirizzo=recuperaValueElemento("txtIndirizzoDest");
    var localita=recuperaValueElemento("txtLocalita");
    var cap=recuperaValueElemento("txtCAP");
    var prov=recuperaValueElemento("txtProv");
    var tel=recuperaValueElemento("txtTel");
    var fax=recuperaValueElemento("txtFax");

    var jSonDest={idDest:idDest, ragioneSociale:ragioneSociale,indirizzo:indirizzo,localita:localita,cap:cap,prov:prov,tel:tel,fax:fax,pagamento:"0",agente:"0",vettore:"0",deposito:"0",dPagamento:""};

    carrelloJson.testata.destinazioni=jSonDest;
    carrelloToStorage();
}

function pulisciDestinazione(){
    cIdDest=0;
    localStorage.removeItem(xNomeDestinazione);    

    valorizzaHTMLElemento("divIdDestinazione","0");
    valorizzaValueElemento("txtDestinazione","");
    valorizzaValueElemento("txtIndirizzoDest","");
    valorizzaValueElemento("txtLocalita","");
    valorizzaValueElemento("txtCAP","");
    valorizzaValueElemento("txtProv","");
    valorizzaValueElemento("txtTel","");
    valorizzaValueElemento("txtFax","");

    if (skCli[0].PAGAMENTO!=undefined){
        carrelloJson.testata.idPagamento=skCli[0].PAGAMENTO;
        idPagamentoD=0;
        valorizzaValueElemento("cmbPagamento",skCli[0].PAGAMENTO);
        valorizzaHTMLElemento("divPagamento",skCli[0].DPAGAMENTO);
    }

    if (skCli[0].IDVETTORE!=undefined){
        carrelloJson.testata.idVettore=skCli[0].IDVETTORE;
        idVettoreD=0;
        valorizzaValueElemento("cmbMezzo",skCli[0].MEZZOTRAS);
        valorizzaValueElemento("cmbVettore",skCli[0].IDVETTORE);
    }

    if (skCli[0].COD_AGENTE!=undefined){
        carrelloJson.testata.idAgente=skCli[0].COD_AGENTE;
        idAgenteD=0;
    }

    if (skCli[0].IDDEPOSITO!=undefined){
        carrelloJson.testata.idDeposito=skCli[0].IDDEPOSITO;
        idDeposito=skCli[0].IDDEPOSITO;
    }

    aggiornaDestinazione();
}

function apriDestinazioni(){
    var parametri={"nomeQuery":"schedaCliente.html:destinazioni","tipoRisposta":"destinazioni","idCliente":idCliente,
                    "tipoQuery":"schedaClienti","chiamante":"destinazioni"
                    }; 

    inviaRichiestaCentralino("query",parametri,elaboraApriDestinazioni);
}

function elaboraApriDestinazioni(res){
    var risp=JSON.parse(res);
    var parametri=risp.parametri;
    var data=risp.risposta;

    if (risp.error!=''){
        return "";
    }

    if(data[0]==0){
        return "";
    }

    apriModalDettagli(parametri.nomeQuery,document.getElementById("divCliente").innerHTML,data,0,true,"DESTINAZIONI");

    document.getElementById("myStorico").style.zIndex=2002;
}

var disattivaAggiornaTestata=false;

function valorizzaCampiTestata(){
    var testata=carrelloJson.testata;

    var testo="";

    if (gPreordine){
        testo="PREORDINE";
    } else {
        testo="ORDINE";
    }

    if (testata!=undefined){
        disattivaAggiornaTestata=true;

        if (testata.numero!=undefined){
            if (testata.genereSalvato==6 && gPreordine==true){
                testo+=" nr. "+testata.numero+" del "+testata.dataDoc;
            } else {
                testo+='<span class="testoNormale testo12"> da Preordine nr. '+testata.numero+' del '+testata.dataDoc+'</span>';
            }    
        }

        valorizzaHTMLElemento("divIntestazioneCO",testo);

        cambiaSelezioneSelect("cmbPagamento",testata.idPagamento);
        cambiaSelezioneSelect("cmbMezzo",testata.mezzo);
        cambiaSelezioneSelect("cmbVettore",testata.idVettore);
        valorizzaValueElemento("txtDataConsegna",testata.dataConsegna);
        valorizzaValueElemento("txtDataSpedizione",testata.dataSpedizione);
        valorizzaValueElemento("txtNoteU",testata.noteUfficio);
        valorizzaValueElemento("txtNoteM",testata.noteMagazzino);
        valorizzaValueElemento("txtNoteV",testata.noteVettore);
        valorizzaValueElemento("txtOrdineCli",testata.ordineCli);
        valorizzaValueElemento("txtDataOrdineCli",testata.dataOrdineCli);

        var txtData=document.getElementById("txtDataConsegna");
        var Data=recuperaValueElemento("txtDataConsegna").replace(/-/g,"");

        isDate(Data,txtData);
            
        var txtData=document.getElementById("txtDataSpedizione");
        var Data=recuperaValueElemento("txtDataSpedizione").replace(/-/g,"");

        isDate(Data,txtData);

        disattivaAggiornaTestata=false;
    } else {  
        valorizzaHTMLElemento("divIntestazioneCO",testo);

        if (idPagamentoD!=0 && idPagamentoD!=undefined){
            cambiaSelezioneSelect('cmbPagamento',idPagamentoD);
        } else if (skCli[0].PAGAMENTO>0){
            cambiaSelezioneSelect('cmbPagamento',skCli[0].PAGAMENTO);
        }
        
        if (idVettoreD!=0){
            cambiaSelezioneSelect("cmbMezzo","2");
            cambiaSelezioneSelect("cmbVettore",idVettoreD);
        } else {
            if (skCli[0].MEZZOTRAS>=0){
                cambiaSelezioneSelect("cmbMezzo",skCli[0].MEZZOTRAS);
            }
        
            if (skCli[0].IDVETTORE>0){
                cambiaSelezioneSelect("cmbVettore",skCli[0].IDVETTORE);
            }
        }
    
        aggiornaTestata(true);
    }
}

function aggiornaTestata(primoIns=false){  
    if (disattivaAggiornaTestata) {
        return;
    }

    // var pagamenti=JSON.parse(localStorage.getItem("cmbPagamento.jSon"));
    // console.log(pagamenti);
    var totali=carrelloJson.totali;
    var testata=carrelloJson.testata;

    if (testata==undefined){
        carrelloJson.testata={};
        testata=carrelloJson.testata;
    }

    if (primoIns){
      testata.id=0; 
    }

    testata.idIva=idIvaCliente; 
    
    if (gPreordine){
        testata.genere=6;
    } else {
        testata.genere=5;
    }

    testata.idMandante=mandante;
    testata.idCliente=idCliente;
    testata.idDeposito=idDeposito;

    if (idAgenteD!=0){
        testata.idAgente=idAgenteD;
    } else {
        testata.idAgente=skCli[0].COD_AGENTE;
    }
    
    testata.idPagamento=recuperaValueElemento("cmbPagamento");
    testata.mezzo=recuperaValueElemento("cmbMezzo");
    testata.idVettore=recuperaValueElemento("cmbVettore");
    testata.note=recuperaValueElemento("txtNoteG");
    testata.noteUfficio=recuperaValueElemento("txtNoteU");
    testata.noteMagazzino=recuperaValueElemento("txtNoteM");
    testata.noteVettore=recuperaValueElemento("txtNoteV");
    testata.ordineCli=recuperaValueElemento("txtOrdineCli");
    testata.dataOrdineCli=recuperaValueElemento("txtDataOrdineCli");

    var txtData=document.getElementById("txtDataConsegna");
    var Data=recuperaValueElemento("txtDataConsegna").replace(/-/g,"");

    if (isDate(Data,txtData)){
        testata.dataConsegna=recuperaValueElemento("txtDataConsegna");
    } 

    var txtData=document.getElementById("txtDataSpedizione");
    var Data=recuperaValueElemento("txtDataSpedizione").replace(/-/g,"");

    if (isDate(Data,txtData)){
        testata.dataSpedizione=recuperaValueElemento("txtDataSpedizione");
    }

    // for (x in pagamenti){
    //     if (pagamenti[x]["id"]==testata.idPagamento){
    //         calcolaTotaliCarrello(totali,null,-1,null,totali.spese);
    //         valorizzaValueElemento("txtSpese",formattaNumeri(pagamenti[x]["spese"],2,2));
    //         spese=recuperaValueElemento(txtSpese).replace(".","").replace(",",".");
    //         if (isNaN(spese)){
    //             spese=0;
    //         } else {
    //             spese=Number(spese);
    //         }
    //         calcolaTotaliCarrello(totali,null,1,null,spese);
    //         aggiornaTotaliCarrello();
    //     }
    // }

    carrelloToStorage();
}

function aggiornaSpese(idSpesa){
    var totali=carrelloJson.totali;

    var trasporto;
    var spese;

    switch (idSpesa){
        case "txtTrasporto":
            calcolaTotaliCarrello(totali,null,-1,totali.trasporto);
            trasporto=recuperaValueElemento(idSpesa);
            if (isNaN(trasporto)){
                trasporto=0;
            }
            
            calcolaTotaliCarrello(totali,null,1,trasporto);
            break;
        case "txtSpese":
            calcolaTotaliCarrello(totali,null,-1,null,totali.spese);
            spese=recuperaValueElemento(idSpesa);
            if (isNaN(spese)){
                spese=0;
            } 
            calcolaTotaliCarrello(totali,null,1,null,spese);
            break;
    }

    aggiornaTotaliCarrello();
}

function aggiornaScontoCassa(){
    var totali=carrelloJson.totali;

    var sconto;

    calcolaTotaliCarrello(totali,null,-1,null,null,totali.scCassa);
    sconto=recuperaValueElemento("txtScCassa");
    if (isNaN(sconto)){
        sconto=0;
    } 

    calcolaTotaliCarrello(totali,null,1,null,null,sconto);
    ricalcolaTotali(false,sconto);
    aggiornaTotale();
}

function changeSelectPaginaCorrente(s){
    if (s.getAttribute("id")=="cmbMezzo"){
        cambiaSelezioneSelect("cmbVettore",0);
    }

    aggiornaTestata()
}

var timer1;

function txtDataChange(d){
    if (timer1) {
        clearTimeout(timer1);
    }
    timer1=setTimeout(function() { 
        aggiornaTestata();
    }, 1000);
}

function avviaCarDatiTabelle(selectID,nomeTabella){
    var parametri={"tipoRisposta":"select","tipoQuery":"querySpecifica","nomeTabella":nomeTabella, "select":selectID};
    parametri.md5=localStorage.getItem(selectID+".md5");

    if (xOffLine=="true"){
        var data=JSON.parse(localStorage.getItem(parametri.select+".jSon"));

        if (parametri.select!="recordSetProvviggioniAgente"){
            popolaSelectDaJSON(data,parametri.select);
        } else {
            rsProvviggioniAgente=data;
        }
    
        return;
    }

    inviaRichiestaCentralino("query",parametri,elaboraRispostaTabelle);
}

function elaboraRispostaTabelle(res){
    var risp=JSON.parse(res);
    var parametri=risp.parametri;
    var data=risp.risposta;
    
    if(parametri.select=='listaLinkRapidiListaArticoli'){
        recuperaParametri();    
    }
    
    if (risp.error!=''){
        return "";
    }

    if(data[0]===0){
        return "";
    }
    
    data=verificaMd5(parametri.select,parametri,risp,data);
    
    if(parametri.select=='listaLinkRapidiListaArticoli'){
        for(var x in data){
            linkRapidiObj[data[x].id]=JSON.parse(data[x].jsonFiltri)
        }
        if(location.search.indexOf('linkRapido')!=-1){
          
        }

        return;
    }

    if(parametri.select=='recordSetProvviggioniAgente'){
        rsProvviggioniAgente=data;
        return;
    }

    popolaSelectDaJSON(data,parametri.select);
}

function salvaCarrelloSuServer(){
    aggiornaTestata();

    if (parametriArticoli["modificheTroia"]==0){
        if ((carrelloJson.testata.idPagamento==undefined || carrelloJson.testata.idPagamento==0) && carrelloJson.totali.totale!=0){
            carrelloJson.testata.idPagamento=skCli[0].PAGAMENTO;
            valorizzaHTMLElemento("divPagamento",skCli[0].DPAGAMENTO)
        }
    
        if (carrelloJson.testata.idPagamento==0 && carrelloJson.totali.totale!=0){
            attivaAlert(0,"Condizione di Pagamento non Valida 1!","AvvisiSalva");
            return;
        }
    }

    carrelloJson.testata.data=oggiISO();
    
    if (gPreordine){
        carrelloJson.testata.genere=6;
    } else {
        carrelloJson.testata.genere=5;
    }

    if (carrelloJson.prodotti.data.length==0) {
        attivaAlert(0,"Nessuna Riga Documento Presente!","salvaCarrelloSuServer");
        return;
    }
    
    var settaDestinazione=document.getElementById('chkDestPredefinita').checked;

    if (carrelloJson.totali.percTrasp==undefined){
        carrelloJson.totali.percTrasp=0;
    }

    if (carrelloJson.totali.percTrasp==""){
        carrelloJson.totali.percTrasp=0;
    }

    var parametri={"tipoRisposta":"salva","tipoSalva":"ordine", "dati":carrelloJson, "settaDestinazione":settaDestinazione};
    var pagamenti=JSON.parse(localStorage.getItem('cmbPagamento.jSon'));

    if (!gPreordine){
        for(var x in pagamenti){
            if(pagamenti[x].id==carrelloJson.testata.idPagamento && pagamenti[x].pagamentoOnline==1 && (carrelloJson.testata.idTransazione==undefined || carrelloJson.testata.idTransazione=='') && parametriArticoli.idClientPayPal!=undefined){
                var scriptPayPal=document.getElementById('scriptPayPal')
                if(scriptPayPal==undefined){
                    var script=document.createElement("script");
                    script.setAttribute('src',"https://www.paypal.com/sdk/js?client-id="+parametriArticoli.idClientPayPal+"&currency=EUR&disable-funding=card,mybank,sofort");
                    script.setAttribute('id','scriptPayPal');
                    document.body.appendChild(script);
                    script.onload = function () {
                        apriModalCustom('modalPayPal','','Pagamento PayPal','','',true);
                        paypal.Buttons({
                            // Sets up the transaction when a payment button is clicked
                            createOrder: (data, actions) => {
                                return actions.order.create({
                                purchase_units: [{
                                    amount: {
                                    value: carrelloJson.totali.tDoc // Can also reference a variable or function
                                    }
                                }]
                                });
                            },
                            // Finalize the transaction after payer approval
                            onApprove: (data, actions) => {
                                return actions.order.capture().then(function(orderData) {
                                
                                const transaction = orderData.purchase_units[0].payments.captures[0];
                                // alert(`Transaction ${transaction.status}: ${transaction.id}\n\nSee console for all available details`);
                                console.log(transaction.id);
                                parametri.dati.testata.idTransazione=transaction.id;
                                inviaRichiestaCentralino("salva",parametri,elaboraRispostaSalvaCarrello);
                                chiudiModalCustom();
                                });
                            }
                            }).render('#paypal-button-container');
                    }
                }else{
                    apriModalCustom('modalPayPal','','Pagamento PayPal','','',true);
                    paypal.Buttons({
                        // Sets up the transaction when a payment button is clicked
                        createOrder: (data, actions) => {
                            return actions.order.create({
                            purchase_units: [{
                                amount: {
                                value: carrelloJson.totali.tDoc // Can also reference a variable or function
                                }
                            }]
                            });
                        },
                        // Finalize the transaction after payer approval
                        onApprove: (data, actions) => {
                            return actions.order.capture().then(function(orderData) {
                            
                            const transaction = orderData.purchase_units[0].payments.captures[0];
                            // alert(`Transaction ${transaction.status}: ${transaction.id}\n\nSee console for all available details`);
                            console.log(transaction.id);
                            parametri.dati.testata.idTransazione=transaction.id;
                            inviaRichiestaCentralino("salva",parametri,elaboraRispostaSalvaCarrello);
                            chiudiModalCustom();
                            });
                        }
                        }).render('#paypal-button-container');
                }
                return;
                
            }
        }
    }

    inviaRichiestaCentralino("salva",parametri,elaboraRispostaSalvaCarrello);
}

function elaboraRispostaSalvaCarrello(res){
    var risp=JSON.parse(res);
    var parametri=risp.parametri;
    var data=risp.risposta;
    console.log(parametri);
    if (risp.error!=''){
        return "";
    }
    
    if(data[0]==0){
        attivaAlert(0,"Errore durante il salvataggio del documento","fineSalva");
        return "";
    }

    var messaggio="";

    if (parametri.dati.testata.genere==6){
        messaggio="Pre Ordine";
    } else {
        messaggio="Ordine";
    }
    
    messaggio+=" Salvato Correttamente con il numero "+data.numero;
    if (data.serie!=""){
        messaggio+="/"+data.serie;
    }

    if (data.erroreMail!=undefined){
        if (data.erroreMail!=""){
            messaggio+="<br><br>Non è stato però possibile recapitare la mail per problemi tecnici!";
        }
    }

    if (parametriArticoli.stampaAuto==1){
        stampa(data.idTes);
    }

    if (filtroApertura==parametriArticoli.codiceCatalogo){
        attivaAlert(4,messaggio,"fineSalva","","","clickBack");
        return;
    } 

    attivaAlert(4,messaggio,"fineSalva");

    localStorage.removeItem(nomeCarrello);
    
    if (idTes>0){
        document.getElementById('modChiusuraOrdine').style.display='none';
        carrelloJson=null;
        var chk=document.getElementById("nav-toggleP");
        chk.click();
        
        if (parametri.dati.testata.genere==5){
            sessionStorage.removeItem("carrello."+idTes);    
            sessionStorage.removeItem("carrelloDaAprire");   
            idTes=0; 
            AvviaCarDatiElencoArticoli("elencoArticoli","");
        }

        caricaCarrello();
        aggiornaTotale();
    } else {    
        document.getElementById('modChiusuraOrdine').style.display='none';
        carrelloJson=null;
        var chk=document.getElementById("nav-toggleP");
        chk.click();

        if (parametri.dati.testata.genere==6){
            caricaCarrello();
            aggiornaTotale();
        } else {
            inizializzaCarrelloJson();
            caricaCarrello();
            aggiornaTotale();
            AvviaCarDatiElencoArticoli("elencoArticoli","");
        }
    }

    if (parametriArticoli["idDest"]!="0"){
        caricaDatiDestinazione(parametriArticoli["idDest"]);
    }
}

function apriModificaPreOrdine(){
    var parametri={"tipoRisposta":"documento","tipoQuery":"preOrdini","chiamante":"modificaOrdini","percorsoImmagini":xPercorsoImmagini,"id":0,
            "cliente":idCliente, "noSitAgenti":1, "utente":xUserCom};

    if (xOffLine=="true" || parametriArticoli.nonCaricarePreordineAvvio==1){
        res=impacchettaSimulaElaboraRisposta([0],parametri);
        elaboraRigheOrdine(res);
    } else {
        elencoInCaricamento=1;
        xImmagineAperta=true;

        inviaRichiestaCentralino("multiQuery",parametri,elaboraRigheOrdine);
    }
}

function elaboraRigheOrdine(res){
    var risp=JSON.parse(res);
    var parametri=risp.parametri;
    var data=risp.risposta;

    if (risp.error!=''){
        return "";
    }
    
    if(data[0]==0){
        nomeCarrello = "carrello"+versioneCarrello+"."+idServer+"."+tipoAnagrafica+"."+idCliente;

        if (resoMerce==1){
            nomeCarrello+='.'+resoMerce;
        }

        if (cIdDest>0 && listinoDest>0) {
            nomeCarrello+='.'+cIdDest;
        }

        carrelloJson=localStorage.getItem(nomeCarrello);
        inizializzaCarrelloJson();
        aggiornaTotale();
        document.getElementById("intCarrello").innerHTML="CARRELLO PRODOTTI";
        return;
    }

    var ragsoc="NESSUN CLIENTE SELEZIONATO";

    try {
        ragsoc=data.skCliente[0].RAGIONE_SOCIALE;    
    } catch (error) {
    
    }

    sessionStorage.setItem("ragioneSociale",ragsoc)
    sessionStorage.setItem("carrello."+data.testata.id,_toJSONString(data));
    sessionStorage.setItem("carrelloDaAprire",data.testata.id);
    sessionStorage.setItem("idCliente",data.testata.idCliente);        
    sessionStorage.setItem("schedaCliente.html.CLIENTE."+data.testata.idCliente+".jSon",_toJSONString(data.skCliente));

    caricaCarrello();
    aggiornaTotale();

    attivaAlert(0,"Sono state recuperate le righe di un Pre Ordine precedentemente Salvato!<br>Tutte le modifiche effettuate dovranno essere Confermate con:<br>- Salva Pre Ordine<br>- Salva Ordine<br>Altrimenti andranno PERSE!","avvisoPreordine");
}
function controlloListaMagazzino(input){
    hide('divNomeAssortimento')
    switch(input.value){
        case '0' :
        break;
        case '1':
        break;
        case '2':
            show('divNomeAssortimento');
        break;
    }
}
function salvaListaMagazzino(){
    carrelloJson.testata={};

    carrelloJson.testata.data=oggiISO();
    
    if (carrelloJson.prodotti.data.length==0) {
        attivaAlert(0,"Nessuna Riga Documento Presente!","salvaCarrelloSuServer");
        return;
    }
    
    switch(document.getElementById('slcSceltaFunzioneLista').value){
        case '0' :
            attivaAlert(xTipoAllert.ESCLAMAZIONE,'Scegliere il tipo di lista!','Errore lista Magazzino');
            return;
        break;
        case '1':
            var parametri={"tipoRisposta":"salva","tipoSalva":"listaMagazzino", "dati":carrelloJson, "settaDestinazione":false};
            var fnc=elaboraRispostaSalvaListaMagazzino;        
        break;
        case '2':
            carrelloJson.assortimento={};
            carrelloJson.assortimento.descrizione=document.getElementById('txtNomeAssortimento').value;
            if(carrelloJson.assortimento.descrizione==''){
                attivaAlert(xTipoAllert.ESCLAMAZIONE,'Specificare un nome per l\'assortimento!');
                return;
            }
            var parametri={"tipoRisposta":"salva","tipoSalva":"assortimentoArticoli", "dati":carrelloJson};
            var fnc=(res)=>{
                var risp=JSON.parse(res);
                if(risp.error==''){
                    attivaAlert(xTipoAllert.SUCCESSO,'Assortimento : '+risp.risposta.descrizione+' creata con successo');
                    localStorage.removeItem(nomeCarrello);

                    document.getElementById('modChiusuraOrdine').style.display='none';
                    carrelloJson=null;
                    var chk=document.getElementById("nav-toggleP");
                    chk.click();
                
                    inizializzaCarrelloJson();
                    caricaCarrello();
                    aggiornaTotale();
                    if (parametriArticoli.TabAssortimento==1){
                        AvviaCarDatiElencoArticoli("elencoAssortimento","assortimenti",true,1);
                        
                        // div.classList.add("w"+arrotonda(width,0).toString());
                    } 
                    AvviaCarDatiElencoArticoli("elencoArticoli","");
                }
            };        
        break;
        default:
        return;
    }
    
    
    inviaRichiestaCentralino("salva",parametri,fnc);   
    chiudiModalCustom();
}

function elaboraRispostaSalvaListaMagazzino(res){
    var risp=JSON.parse(res);
    var parametri=risp.parametri;
    var data=risp.risposta;

    if (risp.error!=''){
        return "";
    }
    
    if(data[0]==0 || data=="false"){
        attivaAlert(0,"Errore durante il salvataggio della Lista di Magazzino","fineSalva");
        return "";
    }

    var messaggio="Lista di Magazzino Salvata Correttamente con il numero "+data.numero;
    if (data.serie!=""){
        messaggio+="/"+data.serie;
    }
    
    attivaAlert(xTipoAllert.SUCCESSO,messaggio,"fineSalva");

    localStorage.removeItem(nomeCarrello);

    document.getElementById('modChiusuraOrdine').style.display='none';
    carrelloJson=null;
    var chk=document.getElementById("nav-toggleP");
    chk.click();

    inizializzaCarrelloJson();
    caricaCarrello();
    aggiornaTotale();
    AvviaCarDatiElencoArticoli("elencoArticoli","");
}

function ricalcolaTotali(verificaSconti=true, scCassa=0){
    carrelloJson.totali={totale:0, tCosto:0, tCostoEvadibile:0, tQu:0, tQuEvadibile:0, tRighe:0, tRigheEvadibili:0, totEvadibile:0, tIva:0, tDoc:0, 
        tIvaEvadibile:0, tDocEvadibile:0, totaleMerce:0, nettoMerce:0, scCassa:Number(scCassa), trasporto:0, spese:0, castellettoIva:[],totaliProvvigioniAgente:0, tQuTrainante:0};   
    carrelloToStorage();

    for (x in carrelloJson.prodotti.data){
        calcolaTotaliCarrello(carrelloJson.totali,carrelloJson.prodotti.data[x],molt=1,trasporto=null,spese=null,scCassa=null)       
    }
    
    aggiornaTotaliCarrello();

    verificaCostiTrasportoESconti(verificaSconti);
}

function avviaPagamentoPayPal(){
    
}

function verificaCostiTrasportoESconti(verificaSconti=true){
    var totali=carrelloJson.totali;

    if (!(costiTrasporto=="" && costiTrasportoB2B=="")){
        var trasporto=0;

        if (costiTrasportoB2B==""){
            for (x in costiTrasporto){
                if (totali.tPeso<=Number(costiTrasporto[x].pesoFinoA)){
                    trasporto=Number(costiTrasporto[x].costo);
                    break;
                }
            }
        } else {
            for (x in costiTrasportoB2B){
                if (totali.tQuTrainante<=Number(costiTrasportoB2B[x].FINOA)){
                    trasporto=Number(costiTrasportoB2B[x].VALORE);
                    break;
                }
            }
        }

        if (xIdAgente!=0) {
            if (trasporto!=0){
                document.getElementById("txtTrasporto").disabled=true;
            } else {
                document.getElementById("txtTrasporto").disabled=false;
            }
        }
        
        if (trasporto!=totali.trasporto){
            valorizzaValueElemento("txtTrasporto",trasporto);
            aggiornaSpese('txtTrasporto');
        }
    }

    if (!scontiB2B=="" && verificaSconti==true){
        var sconto=0;

        for (x in scontiB2B){
            if (totali.tQuTrainante<=Number(scontiB2B[x].FINOA)){
                sconto=Number(scontiB2B[x].VALORE);
                break;
            }
        }

        if (sconto!=totali.scCassa){
            valorizzaValueElemento("txtScCassa",sconto);
            aggiornaScontoCassa();
        } 
    }
}

function avviaEliminacontenutoCarrello(){
    attivaAlert(xTipoAllert.DOMANDASINO,"Sei sicuro di voler eliminare tutte le righe del Carrello?","confermaEliminacontenutoCarrello_");
}

function confermaEliminacontenutoCarrello(risp,id){
    if (risp=="Si"){
        attivaAlert(xTipoAllert.DOMANDASINO,"Sei sicuro?<br>Continuando saranno eliminate tutte le righe presenti sul carrello!","eliminaContenutoCarrello_");
    }
}

function eliminaContenutoCarrello(risp,id){
    if (risp=="Si"){
        carrelloJson=null;
        inizializzaCarrelloJson();
        caricaCarrello();
        aggiornaTotale();
        apriCarrello();
        AvviaCarDatiElencoArticoli("elencoArticoli","");
    }
}